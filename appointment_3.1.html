<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Agendamentos M√©dicos - Logos Salvos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background-color: #1a5f7a;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .preview-section {
            flex: 2;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #1a5f7a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f0ff;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: #1a5f7a;
            outline: none;
        }
        
        input.error, textarea.error {
            border-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }
        
        .error-message.show {
            display: block;
        }
        
        .address-autocomplete, .logo-autocomplete, .user-autocomplete, .hospital-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .address-suggestion, .logo-suggestion, .user-suggestion, .hospital-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        
        .address-suggestion:hover, .logo-suggestion:hover, .user-suggestion:hover, .hospital-suggestion:hover {
            background-color: #f0f7ff;
        }
        
        .address-suggestion:last-child, .logo-suggestion:last-child, .user-suggestion:last-child, .hospital-suggestion:last-child {
            border-bottom: none;
        }
        
        .address-suggestion .address-name,
        .logo-suggestion .logo-name,
        .user-suggestion .user-name,
        .hospital-suggestion .hospital-name {
            font-weight: 600;
            color: #1a5f7a;
            margin-bottom: 3px;
        }
        
        .address-suggestion .address-value,
        .user-suggestion .user-value,
        .hospital-suggestion .hospital-value {
            font-size: 0.9rem;
            color: #666;
        }
        
        .logo-suggestion .logo-preview-img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
            background-color: white;
        }
        
        .logo-suggestion .logo-info,
        .user-suggestion .user-info,
        .hospital-suggestion .hospital-info {
            flex: 1;
        }
        
        .save-address-btn, .save-logo-btn, .save-user-btn {
            position: absolute;
            right: 10px;
            top: 40px;
            background: none;
            border: none;
            color: #1a5f7a;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
			/*visibility:hidden;*/
			display:none;
			
        }
        
        .save-address-btn:hover, .save-logo-btn:hover, .save-user-btn:hover {
            background-color: #f0f7ff;
        }
        
        .saved-addresses-container, .saved-logos-container, .saved-users-container, .saved-hospitals-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .saved-addresses-title, .saved-logos-title, .saved-users-title, .saved-hospitals-title {
            font-size: 1rem;
            color: #1a5f7a;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .saved-address-item, .saved-logo-item, .saved-user-item, .saved-hospital-item {
            background: white;
            border: 1px solid #e0f0ff;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .saved-address-item:hover, .saved-logo-item:hover, .saved-user-item:hover, .saved-hospital-item:hover {
            border-color: #1a5f7a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .address-info, .logo-info, .user-info, .hospital-info {
            flex: 1;
        }
        
        .address-label, .logo-label, .user-label, .hospital-label {
            font-weight: 600;
            color: #1a5f7a;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        
        .address-text, .user-text, .hospital-text {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.3;
        }
        
        .logo-preview-small {
            width: 50px;
            height: 30px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
            background-color: white;
        }
        
        .address-actions, .logo-actions, .user-actions, .hospital-actions {
            display: flex;
            gap: 5px;
        }
        
        .address-action-btn, .logo-action-btn, .user-action-btn, .hospital-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .address-action-btn:hover, .logo-action-btn:hover, .user-action-btn:hover, .hospital-action-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .address-action-btn.use-btn:hover,
        .logo-action-btn.use-btn:hover,
        .user-action-btn.use-btn:hover,
        .hospital-action-btn.use-btn:hover {
            background-color: #e8f4fc;
            color: #1a5f7a;
        }
        
        .address-action-btn.delete-btn:hover,
        .logo-action-btn.delete-btn:hover,
        .user-action-btn.delete-btn:hover,
        .hospital-action-btn.delete-btn:hover {
            background-color: #f8e8e8;
            color: #dc3545;
        }
        
        .no-addresses, .no-logos, .no-users, .no-hospitals {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .clear-addresses-btn, .clear-logos-btn, .clear-users-btn, .clear-hospitals-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }
        
        .clear-addresses-btn:hover, .clear-logos-btn:hover, .clear-users-btn:hover, .clear-hospitals-btn:hover {
            color: #c82333;
        }
        
        .logo-upload {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            position: relative;
        }
        
        .logo-preview {
            max-width: 200px;
            max-height: 120px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
        }
        
        .hidden {
            display: none;
        }
        
        .button {
            background-color: #1a5f7a;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .button:hover {
            background-color: #0d4a63;
        }
        
        .button.secondary {
            background-color: #28a745;
        }
        
        .button.secondary:hover {
            background-color: #1e7e34;
        }
        
        .button.danger {
            background-color: #dc3545;
        }
        
        .button.danger:hover {
            background-color: #c82333;
        }
        
        .button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .button.warning:hover {
            background-color: #e0a800;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            overflow: auto;
        }
        
        /* Paper simulation */
        .paper-sheet {
            width: 794px; /* A4 width in pixels at 96 DPI (210mm * 96 / 25.4) */
            height: 1123px; /* A4 height in pixels (297mm * 96 / 25.4) */
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: 0 auto;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Dynamic grid layout based on number of appointments */
        .appointments-grid {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: grid;
        }
        
        /* Layout configurations */
        .layout-1-card {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            gap: 0;
            padding: 80px;
        }
        
        .layout-2-cards {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 40px;
            padding: 40px;
        }
        
        .layout-4-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 30px;
        }
        
        .layout-6-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            padding: 25px;
        }
        
        .layout-8-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
        }
        
        .appointment-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            page-break-inside: avoid;
            break-inside: avoid;
            box-sizing: border-box;
        }
        
        /* Card sizes based on layout */
        .layout-1-card .appointment-card {
            padding: 40px;
        }
        
        .layout-2-cards .appointment-card {
            padding: 25px;
        }
        
        .layout-4-cards .appointment-card {
            padding: 20px;
        }
        
        .layout-6-cards .appointment-card {
            padding: 15px;
        }
        
        .layout-8-cards .appointment-card {
            padding: 12px;
        }
        
        .appointment-card:hover {
            border-color: #1a5f7a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .appointment-card.editing {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0f0ff;
        }
        
        .card-logo-container {
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .card-logo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }
        
        .card-logo:hover {
            opacity: 0.8;
        }
        
        /* Logo sizes based on layout */
        .layout-1-card .card-logo {
            max-width: 180px;
            max-height: 120px;
        }
        
        .layout-2-cards .card-logo {
            max-width: 120px;
            max-height: 80px;
        }
        
        .layout-4-cards .card-logo {
            max-width: 80px;
            max-height: 60px;
        }
        
        .layout-6-cards .card-logo {
            max-width: 70px;
            max-height: 50px;
        }
        
        .layout-8-cards .card-logo {
            max-width: 60px;
            max-height: 40px;
        }
        
        .hospital-name {
            color: #1a5f7a;
            font-weight: 700;
            flex-grow: 1;
            text-align: center;
            line-height: 1.2;
        }
        
        /* Hospital name sizes based on layout */
        .layout-1-card .hospital-name {
            font-size: 1.8rem;
        }
        
        .layout-2-cards .hospital-name {
            font-size: 1.4rem;
        }
        
        .layout-4-cards .hospital-name {
            font-size: 1.1rem;
        }
        
        .layout-6-cards .hospital-name {
            font-size: 1rem;
        }
        
        .layout-8-cards .hospital-name {
            font-size: 0.95rem;
        }
        
        .card-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* Title sizes based on layout */
        .layout-1-card .card-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .layout-2-cards .card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .layout-4-cards .card-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        
        .layout-6-cards .card-title {
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .layout-8-cards .card-title {
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .appointment-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin-bottom: 10px;
            flex-grow: 1;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 3px;
            align-items: center;
            min-height: 1.4em;
        }
        
        .detail-label {
            font-weight: 600;
            color: #1a5f7a;
            min-width: 70px;
            flex-shrink: 0;
        }
        
        .detail-value {
            color: #2c3e50;
            flex-grow: 1;
            word-break: break-word;
            line-height: 1.2;
            text-align: left;
            min-height: 1.2em;
            padding-left: 10px; /* Added blank space at the beginning */
        }
        
        /* Date value specific styling */
        .date-value {
            font-weight: 600;
            color: #1a5f7a;
            letter-spacing: 0.5px;
            min-width: 100px;
        }
        
        /* Detail sizes based on layout */
        .layout-1-card .detail-label,
        .layout-1-card .detail-value {
            font-size: 1.1rem;
        }
        
        .layout-2-cards .detail-label,
        .layout-2-cards .detail-value {
            font-size: 0.95rem;
        }
        
        .layout-4-cards .detail-label,
        .layout-4-cards .detail-value {
            font-size: 0.85rem;
        }
        
        .layout-6-cards .detail-label,
        .layout-6-cards .detail-value {
            font-size: 0.8rem;
        }
        
        .layout-8-cards .detail-label,
        .layout-8-cards .detail-value {
            font-size: 0.75rem;
        }
        
        /* Date-specific font sizes */
        .layout-1-card .date-value {
            font-size: 1.2rem !important;
        }
        
        .layout-6-cards .date-value,
        .layout-8-cards .date-value {
            font-size: 0.85rem !important;
        }
        
        .card-footer {
            text-align: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed #ddd;
            color: #666;
            font-style: italic;
        }
        
        /* Footer sizes based on layout */
        .layout-1-card .card-footer {
            font-size: 0.9rem;
        }
        
        .layout-2-cards .card-footer {
            font-size: 0.85rem;
        }
        
        .layout-4-cards .card-footer {
            font-size: 0.8rem;
        }
        
        .layout-6-cards .card-footer {
            font-size: 0.75rem;
        }
        
        .layout-8-cards .card-footer {
            font-size: 0.7rem;
        }
        
        .watermark {
            position: absolute;
            bottom: 4px;
            right: 4px;
            color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
            transform: rotate(-15deg);
            pointer-events: none;
            /*visibility:hidden;*/
            
            display:none;
        }
        
        /* Watermark sizes based on layout */
        .layout-1-card .watermark {
            font-size: 4rem;
        }
        
        .layout-2-cards .watermark {
            font-size: 3rem;
        }
        
        .layout-4-cards .watermark {
            font-size: 2.5rem;
        }
        
        .layout-6-cards .watermark {
            font-size: 2rem;
        }
        
        .layout-8-cards .watermark {
            font-size: 1.8rem;
        }
        
        .card-number {
            position: absolute;
            top: 6px;
            right: 6px;
            background-color: #1a5f7a;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .logo-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #28a745;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            z-index: 10;
        }
        
        /* Copy/Paste badge - BIGGER SIZE */
        .copy-badge {
            position: absolute;
            top: -8px;
            left: -8px;
            background-color: #ffc107;
            color: #212529;
            min-width: 24px;
            height: 24px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            z-index: 10;
            cursor: pointer;
            transition: all 0.3s;
            padding: 0 8px;
            white-space: nowrap;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .copy-badge:hover {
            background-color: #e0a800;
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
            min-width: 120px;
        }
        
        .copy-badge:hover::after {
            content: "Copiar este cart√£o";
            margin-left: 4px;
        }
        
        .copy-badge.copied {
            background-color: #28a745;
            color: white;
            min-width: 120px;
        }
        
        .copy-badge.copied::after {
            content: "‚úì Copiado!";
            margin-left: 4px;
        }
        
        /* Adjust copy badge size based on layout */
        .layout-1-card .copy-badge {
            min-width: 28px;
            height: 28px;
            font-size: 0.85rem;
            top: -10px;
            left: -10px;
        }
        
        .layout-1-card .copy-badge:hover {
            min-width: 140px;
        }
        
        .layout-1-card .copy-badge.copied {
            min-width: 140px;
        }
        
        .layout-2-cards .copy-badge {
            min-width: 24px;
            height: 24px;
            font-size: 0.75rem;
        }
        
        .layout-2-cards .copy-badge:hover {
            min-width: 120px;
        }
        
        .layout-2-cards .copy-badge.copied {
            min-width: 120px;
        }
        
        .layout-4-cards .copy-badge {
            min-width: 20px;
            height: 20px;
            font-size: 0.7rem;
            top: -6px;
            left: -6px;
        }
        
        .layout-4-cards .copy-badge:hover {
            min-width: 100px;
        }
        
        .layout-4-cards .copy-badge.copied {
            min-width: 100px;
            font-size: 0.65rem;
        }
        
        .layout-6-cards .copy-badge,
        .layout-8-cards .copy-badge {
            min-width: 18px;
            height: 18px;
            font-size: 0.65rem;
            top: -5px;
            left: -5px;
        }
        
        .layout-6-cards .copy-badge:hover,
        .layout-8-cards .copy-badge:hover {
            min-width: 90px;
        }
        
        .layout-6-cards .copy-badge.copied,
        .layout-8-cards .copy-badge.copied {
            min-width: 90px;
            font-size: 0.6rem;
        }
        
        .logo-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .logo-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
        }
        
        .default-logo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            border: 1px dashed #ccc;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .default-logo-placeholder:hover {
            border-color: #1a5f7a;
            background-color: #f0f7ff;
        }
        
        /* Placeholder sizes based on layout */
        .layout-1-card .default-logo-placeholder {
            min-height: 80px;
            width: 150px;
            font-size: 0.9rem;
        }
        
        .layout-2-cards .default-logo-placeholder {
            min-height: 60px;
            width: 100px;
            font-size: 0.8rem;
        }
        
        .layout-4-cards .default-logo-placeholder {
            min-height: 50px;
            width: 80px;
            font-size: 0.7rem;
        }
        
        .layout-6-cards .default-logo-placeholder {
            min-height: 40px;
            width: 70px;
            font-size: 0.65rem;
        }
        
        .layout-8-cards .default-logo-placeholder {
            min-height: 35px;
            width: 60px;
            font-size: 0.6rem;
        }
        
        .logo-icon {
            margin-bottom: 3px;
        }
        
        /* Icon sizes based on layout */
        .layout-1-card .logo-icon {
            font-size: 2rem;
        }
        
        .layout-2-cards .logo-icon {
            font-size: 1.5rem;
        }
        
        .layout-4-cards .logo-icon {
            font-size: 1.3rem;
        }
        
        .layout-6-cards .logo-icon {
            font-size: 1.1rem;
        }
        
        .layout-8-cards .logo-icon {
            font-size: 1rem;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .appointment-count {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .count-display {
            font-size: 1.1rem;
            color: #1a5f7a;
            font-weight: bold;
            text-align: center;
        }
        
        .layout-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .layout-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }
        
        .layout-option:hover {
            border-color: #1a5f7a;
            background-color: #f0f7ff;
        }
        
        .layout-option.selected {
            border-color: #1a5f7a;
            background-color: #e8f4fc;
            font-weight: bold;
        }
        
        .layout-option .layout-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .layout-option .layout-text {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .layout-option .layout-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        .paper-info {
            background-color: #e8f4fc;
            border: 1px solid #b8d4e5;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .paper-info h4 {
            color: #1a5f7a;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .paper-info ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .paper-info li {
            margin-bottom: 5px;
        }
        
        /* Modal for editing */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
            cursor: default !important;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #1a5f7a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f0ff;
            padding-right: 30px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .modal-logo-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .modal-logo-preview {
            max-width: 150px;
            max-height: 100px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
        }
        
        .modal-address-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .modal-saved-addresses,
        .modal-saved-logos,
        .modal-saved-users,
        .modal-saved-hospitals {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .esc-hint {
            color: #666;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .enter-hint {
            color: #666;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 5px;
            font-style: italic;
        }
        
        .preview-info {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Logo selection interface */
        .logo-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .logo-selection-item {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        
        .logo-selection-item:hover {
            border-color: #1a5f7a;
            transform: scale(1.05);
        }
        
        .logo-selection-item.selected {
            border-color: #28a745;
            border-width: 3px;
        }
        
        .logo-selection-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            padding: 5px;
        }
        
        .logo-selection-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.6rem;
            padding: 2px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .paper-sheet,
            .paper-sheet * {
                visibility: visible;
            }
            
            .paper-sheet {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            
            .appointment-card {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .card-number, .logo-badge, .copy-badge {
                display: none;
            }
        }
        
        /* Feedback animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .button-spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        
        /* NOVO ESTILO para bot√µes de salvar nos campos */
        .field-save-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #1a5f7a;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
            z-index: 10;
            display: none; /* Inicialmente escondido */
        }
        
        .field-input-container {
            position: relative;
        }
        
        .field-input-container:hover .field-save-btn {
            display: block; /* Mostrar ao passar o mouse */
        }
        
        .field-save-btn:hover {
            background-color: #f0f7ff;
        }
        
        /* Ajustar padding dos inputs para caber o bot√£o */
        .field-input-container input,
        .field-input-container select {
            padding-right: 40px !important;
        }
        
        /* Estilo para quando h√° valor no input */
        .field-input-container.has-value .field-save-btn {
            display: block;
        }
        
        /* Adicionando espa√ßo extra no container para o bot√£o no modal */
        .address-input-container,
        .hospital-input-container,
        .pacient-input-container {
            position: relative;
        }
        
        @media (max-width: 1200px) {
            .paper-sheet {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
        
        @media (max-width: 900px) {
            .paper-sheet {
                transform: scale(0.6);
                transform-origin: top center;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .paper-sheet {
                transform: scale(0.5);
                transform-origin: top center;
            }
            
            .layout-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .actions, .form-actions, .modal-actions {
                flex-direction: column;
            }
            
            .button {
                width: 100%;
            }
            
            .card-header {
                flex-direction: column;
                text-align: center;
            }
            
            .card-logo-container {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .detail-row {
                flex-direction: row !important;
            }
            
            .detail-label {
                min-width: 60px !important;
                margin-bottom: 0;
            }
            
            .save-address-btn, .save-logo-btn, .save-user-btn {
                top: 42px;
                right: 5px;
            }
            
            .field-save-btn {
                display: block; /* Sempre vis√≠vel em mobile */
                top: 42px;
                right: 5px;
            }
            
            .field-input-container input,
            .field-input-container select {
                padding-right: 35px !important;
            }
        }
        
        @media (max-width: 480px) {
            .layout-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Gerador de Agendamentos M√©dicos - Logos & Endere√ßos Salvos</h1>
            <p class="subtitle">Salve e reutilize logos, endere√ßos e nomes de pacientes - Totalmente offline</p>
        </header>
        
        <div class="main-content">
            <section class="control-panel">
                <h2 class="section-title">Configura√ß√µes</h2>
                
                <div class="appointment-count">
                    <div class="count-display">Configura√ß√£o do Layout</div>
                    <p style="text-align: center; font-size: 0.9rem; margin-top: 5px;">Escolha quantos cart√µes criar na folha A4</p>
                </div>
                
                <div class="form-group">
                    <label>Quantidade de Cart√µes:</label>
                    <div class="layout-options">
                        <div class="layout-option" data-layout="1">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text">1 Cart√£o</div>
                            <div class="layout-desc">(1√ó1) √önico Grande</div>
                        </div>
                        <div class="layout-option selected" data-layout="2">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text">2 Cart√µes</div>
                            <div class="layout-desc">(1√ó2) Grande</div>
                        </div>
                        <div class="layout-option" data-layout="4">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text">4 Cart√µes</div>
                            <div class="layout-desc">(2√ó2) M√©dio</div>
                        </div>
                        <div class="layout-option" data-layout="6">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text">6 Cart√µes</div>
                            <div class="layout-desc">(2√ó3) Compacto</div>
                        </div>
                        <div class="layout-option" data-layout="8">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text">8 Cart√µes</div>
                            <div class="layout-desc">(2√ó4) Padr√£o</div>
                        </div>
                    </div>
                </div>
                
                <div class="paper-info" id="paper-info">
                    <!-- Dynamic paper info will be inserted here -->
                </div>
                
                <div class="form-group">
                    <label for="global-pacient">Paciente (geral):</label>
                    <div class="address-input-container pacient-input-container field-input-container">
                        <input type="text" id="global-pacient" placeholder="Nome do paciente para todos" value="Alex Silva">
                        <button type="button" class="save-user-btn" id="save-global-user-btn" title="Salvar este nome">
                            üíæ
                        </button>
                        <button type="button" class="field-save-btn save-pacient-btn" id="save-global-pacient-btn" title="Salvar este nome">
                            üíæ
                        </button>
                        <div class="user-autocomplete" id="global-user-autocomplete"></div>
                    </div>
                    
                    <div class="saved-users-container" id="global-saved-users">
                        <div class="saved-users-title">
                            <span>Nomes Salvos</span>
                            <button class="clear-users-btn" id="clear-global-users">Limpar Todos</button>
                        </div>
                        <!-- Saved users will be loaded here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="global-hospital">Hospital/Cl√≠nica (geral):</label>
                    <div class="hospital-input-container field-input-container">
                        <input type="text" id="global-hospital" placeholder="Nome do hospital/cl√≠nica para todos" value="Santa B√°rbara">
                        <button type="button" class="field-save-btn save-hospital-btn" id="save-global-hospital-btn" title="Salvar este hospital/cl√≠nica">
                            üíæ
                        </button>
                        <div class="hospital-autocomplete" id="global-hospital-autocomplete"></div>
                    </div>
                    
                    <div class="saved-hospitals-container" id="global-saved-hospitals">
                        <div class="saved-hospitals-title">
                            <span>Hospitais/Cl√≠nicas Salvos</span>
                            <button class="clear-hospitals-btn" id="clear-global-hospitals">Limpar Todos</button>
                        </div>
                        <!-- Saved hospitals will be loaded here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="global-speciality">Especialidade (geral):</label>
                    <select id="global-speciality">
                        <script>
							function FirstOneUpperCase(word)
							{
								return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
							}
							
							
                            function specialities()
                            {
                                let values = [
                                    "otorrinolaringologista",
                                    "cardiologista",
                                    "dermatologista",
                                    "oftalmologista",
                                    "ortopedista",
                                    "pediatra",
                                    "ginecologista",
                                    "endocrinologista", 
                                    "gastroenterologista",
                                    "cl√≠nico geral"
                                ];
								
								values.sort();
								
								for(let i in values)
                                {
                                /*    document.write(`<option value="${values[i].charAt(0).toUpperCase() + values[i].slice(1).toLowerCase()}">
                                        ${values[i].charAt(0).toUpperCase() + values[i].slice(1).toLowerCase()}</option>`);
                                */
								    document.write(`<option value="${FirstOneUpperCase(values[i])}">
                                        ${FirstOneUpperCase(values[i])}</option>`);
                                
								}
                            }
							
							

                            specialities();
                        </script>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="global-address">Endere√ßo (geral):</label>
                    <div class="address-input-container field-input-container">
                        <input type="text" id="global-address" placeholder="Digite ou selecione um endere√ßo salvo" value="Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA">
                        <button type="button" class="save-address-btn" id="save-global-address-btn" title="Salvar este endere√ßo">
                            üíæ
                        </button>
                        <button type="button" class="field-save-btn save-address-field-btn" id="save-global-address-field-btn" title="Salvar este endere√ßo">
                            üíæ
                        </button>
                        <div class="address-autocomplete" id="global-address-autocomplete"></div>
                    </div>
                    
                    <div class="saved-addresses-container" id="global-saved-addresses">
                        <div class="saved-addresses-title">
                            <span>Endere√ßos Salvos</span>
                            <button class="clear-addresses-btn" id="clear-global-addresses">Limpar Todos</button>
                        </div>
                        <!-- Saved addresses will be loaded here -->
                    </div>
                </div>
                
                <!-- NEW DATE AND TIME CONTROLS -->
                <div class="form-group">
                    <label for="global-date">Data Padr√£o para Todos:</label>
                    <input type="date" id="global-date" value="2026-01-23">
                    <div class="error-message" id="global-date-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="global-hour">Hor√°rio Padr√£o para Todos:</label>
                    <input type="time" id="global-hour" value="08:00">
                    <div class="error-message" id="global-hour-error"></div>
                </div>
                <!-- END NEW DATE AND TIME CONTROLS -->
                
                <div class="form-group">
                    <label>Logo Padr√£o:</label>
                    <div class="logo-upload">
                        <div class="logo-preview-container">
                            <div id="default-logo-placeholder" class="default-logo-placeholder">
                                <div class="logo-icon">üè•</div>
                                <div>Sem logo</div>
                                <small>Clique para adicionar</small>
                            </div>
                            <img id="global-logo-preview" class="logo-preview hidden" alt="Preview do logo padr√£o">
                        </div>
                        
                        <div class="logo-controls">
                            <input type="file" id="global-logo-upload" accept="image/*" class="hidden">
                            <button type="button" id="global-upload-btn" class="button">Selecionar Novo Logo</button>
                            <button type="button" id="save-global-logo-btn" class="button secondary" title="Salvar este logo">üíæ Salvar Logo</button>
                            <button type="button" id="remove-global-logo-btn" class="button danger hidden">Remover Logo</button>
                        </div>
                        
                        <div class="saved-logos-container" id="global-saved-logos">
                            <div class="saved-logos-title">
                                <span>Logos Salvos</span>
                                <button class="clear-logos-btn" id="clear-global-logos">Limpar Todos</button>
                            </div>
                            <!-- Saved logos will be loaded here -->
                        </div>
                        
                        <div class="logo-autocomplete" id="global-logo-autocomplete"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="apply-all-btn" class="button">Aplicar Texto a Todos</button>
                    <button type="button" id="reset-all-btn" class="button danger">Redefinir Tudo</button>
                </div>
            </section>
            
            <section class="preview-section">
                <h2 class="section-title">Pr√©-visualiza√ß√£o para Impress√£o A4</h2>
                
                <div class="preview-container">
                    <div class="paper-sheet">
                        <div class="appointments-grid layout-2-cards" id="appointments-grid">
                            <!-- Dynamic appointment cards will be generated here -->
                        </div>
                    </div>
                    
                    <div class="preview-info">
                        <p id="layout-info">‚ö° 2 cart√µes grandes otimizados para folha A4</p>
                        <p id="size-info">üìè Cada cart√£o: ‚âà 180mm √ó 120mm</p>
                        <p>üë§ <strong>Nomes:</strong> Salve nomes de pacientes para uso futuro clicando em üíæ</p>
                        <p>üè• <strong>Hospitais:</strong> Salve nomes de hospitais/cl√≠nicas clicando em üíæ</p>
                        <p>üìç <strong>Endere√ßos:</strong> Digite e pressione üíæ para salvar endere√ßos</p>
                        <p>üñºÔ∏è <strong>Logos:</strong> Salve logos para uso futuro clicando em üíæ</p>
                        <p>‚èé <strong>Enter:</strong> Pressione Enter nos campos para salvar mais r√°pido</p>
                        <p>üìã <strong>Copiar/Colar:</strong> Passe o mouse sobre o badge amarelo para ver "Copiar este cart√£o"</p>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" id="download-pdf-btn" class="button secondary">Baixar PDF para Impress√£o</button>
                    <button type="button" id="print-btn" class="button">Imprimir Agora</button>
                    <button type="button" id="download-image-btn" class="button">Baixar como Imagem</button>
                </div>
            </section>
        </div>
        
        <footer style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
            <p>Sistema de gera√ß√£o de agendamentos m√©dicos - Logos, endere√ßos, hospitais e nomes salvos localmente - Funciona totalmente offline</p>
        </footer>
    </div>

    <!-- Modal for editing card -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content" id="modal-content">
            <button class="modal-close" id="modal-close-btn" title="Fechar (ESC)">√ó</button>
            <h3 class="modal-title">Editar Cart√£o <span id="modal-card-number">1</span></h3>
            
            <div class="form-group">
                <label for="modal-pacient">Nome do Paciente:</label>
                <div class="address-input-container pacient-input-container field-input-container">
                    <input type="text" id="modal-pacient" placeholder="Nome do paciente">
                    <button type="button" class="save-user-btn" id="save-modal-user-btn" title="Salvar este nome">
                        üíæ
                    </button>
                    <button type="button" class="field-save-btn save-pacient-btn" id="save-modal-pacient-btn" title="Salvar este nome">
                        üíæ
                    </button>
                    <div class="user-autocomplete" id="modal-user-autocomplete"></div>
                </div>
                <div class="error-message" id="modal-pacient-error"></div>
                
                <div class="modal-saved-users" id="modal-saved-users">
                    <!-- Saved users for modal will be loaded here -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="modal-hospital">Hospital/Cl√≠nica:</label>
                <div class="hospital-input-container field-input-container">
                    <input type="text" id="modal-hospital" placeholder="Nome do hospital/cl√≠nica">
                    <button type="button" class="field-save-btn save-hospital-btn" id="save-modal-hospital-btn" title="Salvar este hospital/cl√≠nica">
                        üíæ
                    </button>
                    <div class="hospital-autocomplete" id="modal-hospital-autocomplete"></div>
                </div>
                <div class="error-message" id="modal-hospital-error"></div>
                
                <div class="modal-saved-hospitals" id="modal-saved-hospitals">
                    <!-- Saved hospitals for modal will be loaded here -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="modal-speciality">Especialidade:</label>
                <select id="modal-speciality">
                    <script>
                        specialities();
                    </script>
                </select>
                <div class="error-message" id="modal-speciality-error"></div>
            </div>
            
            <div class="form-group">
                <label for="modal-date">Data da Consulta:</label>
                <input type="date" id="modal-date">
                <div class="error-message" id="modal-date-error"></div>
            </div>
            
            <div class="form-group">
                <label for="modal-hour">Hor√°rio:</label>
                <input type="time" id="modal-hour">
                <div class="error-message" id="modal-hour-error"></div>
            </div>
            
            <div class="modal-address-section">
                <h4>Endere√ßo da Consulta</h4>
                <div class="address-input-container field-input-container">
                    <input type="text" id="modal-address" placeholder="Digite ou selecione um endere√ßo salvo">
                    <button type="button" class="save-address-btn" id="save-modal-address-btn" title="Salvar este endere√ßo">
                        üíæ
                    </button>
                    <button type="button" class="field-save-btn save-address-field-btn" id="save-modal-address-field-btn" title="Salvar este endere√ßo">
                        üíæ
                    </button>
                    <div class="address-autocomplete" id="modal-address-autocomplete"></div>
                </div>
                <div class="error-message" id="modal-address-error"></div>
                
                <div class="modal-saved-addresses" id="modal-saved-addresses">
                    <!-- Saved addresses for modal will be loaded here -->
                </div>
            </div>
            
            <div class="modal-logo-section">
                <h4>Logo do Cart√£o</h4>
                <p>Este logo aparecer√° apenas neste cart√£o espec√≠fico</p>
                
                <div class="logo-preview-container">
                    <div id="modal-default-logo-placeholder" class="default-logo-placeholder">
                        <!-- Conte√∫do do placeholder ser√° inserido via JS -->
                    </div>
                    <img id="modal-logo-preview" class="modal-logo-preview hidden" alt="Preview do logo individual">
                </div>
                
                <div class="logo-controls">
                    <input type="file" id="modal-logo-upload" accept="image/*" class="hidden">
                    <button type="button" id="modal-upload-logo-btn" class="button">Carregar Novo Logo</button>
                    <button type="button" id="save-modal-logo-btn" class="button secondary">üíæ Salvar Logo</button>
                    <button type="button" id="modal-remove-logo-btn" class="button danger hidden">Remover Logo Individual</button>
                </div>
                
				
                <div class="logo-controls">
                    <button type="button" id="modal-use-global-logo-btn" class="button secondary" style="display:none">Usar Logo Padr√£o</button>
                </div>
                
                <div class="modal-saved-logos" id="modal-saved-logos">
                    <!-- Saved logos for modal will be loaded here -->
                </div>
                
                <div class="logo-autocomplete" id="modal-logo-autocomplete"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="modal-save-btn" class="button secondary">Salvar Altera√ß√µes</button>
                <button type="button" id="modal-cancel-btn" class="button danger">Cancelar</button>
            </div>
            
            <div class="esc-hint">Pressione ESC para cancelar e fechar</div>
            <div class="enter-hint">Pressione Enter em qualquer campo para salvar</div>
        </div>
    </div>

    <!-- Modal for saving address -->
    <div class="modal-overlay" id="save-address-modal-overlay">
        <div class="modal-content" id="save-address-modal-content">
            <button class="modal-close" id="save-address-modal-close-btn" title="Fechar (ESC)">√ó</button>
            <h3 class="modal-title">Salvar Endere√ßo</h3>
            
            <div class="form-group">
                <label for="address-name">Nome para este endere√ßo:</label>
                <input type="text" id="address-name" placeholder="Ex: Cl√≠nica Santa B√°rbara, Hospital Geral, etc.">
                <div class="error-message" id="address-name-error"></div>
            </div>
            
            <div class="form-group">
                <label for="address-value">Endere√ßo completo:</label>
                <textarea id="address-value" rows="3" placeholder="Endere√ßo completo..." readonly></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="save-address-confirm-btn" class="button secondary">Salvar Endere√ßo</button>
                <button type="button" id="save-address-cancel-btn" class="button danger">Cancelar</button>
            </div>
            
            <div class="esc-hint">Pressione ESC para cancelar</div>
            <div class="enter-hint">Pressione Enter no campo nome para salvar</div>
        </div>
    </div>

    <!-- Modal for saving logo -->
    <div class="modal-overlay" id="save-logo-modal-overlay">
        <div class="modal-content" id="save-logo-modal-content">
            <button class="modal-close" id="save-logo-modal-close-btn" title="Fechar (ESC)">√ó</button>
            <h3 class="modal-title">Salvar Logo</h3>
            
            <div class="form-group">
                <label for="logo-name">Nome para este logo:</label>
                    <input type="text" id="logo-name" placeholder="Ex: Logo Santa B√°rbara, Hospital Geral, etc.">
                    <div class="error-message" id="logo-name-error"></div>
                </div>
                
                <div class="form-group">
                    <label>Pr√©-visualiza√ß√£o do logo:</label>
                    <div class="logo-preview-container">
                        <img id="save-logo-preview" class="logo-preview" alt="Preview do logo a ser salvo">
                    </div>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="save-logo-confirm-btn" class="button secondary">Salvar Logo</button>
                    <button type="button" id="save-logo-cancel-btn" class="button danger">Cancelar</button>
                </div>
                
                <div class="esc-hint">Pressione ESC para cancelar</div>
                <div class="enter-hint">Pressione Enter no campo nome para salvar</div>
            </div>
        </div>

        <!-- Modal for saving user -->
        <div class="modal-overlay" id="save-user-modal-overlay">
            <div class="modal-content" id="save-user-modal-content">
                <button class="modal-close" id="save-user-modal-close-btn" title="Fechar (ESC)">√ó</button>
                <h3 class="modal-title">Salvar Nome de Paciente</h3>
                
                <div class="form-group">
                    <label for="user-name">Nome para este paciente:</label>
                    <input type="text" id="user-name" placeholder="Ex: Alex Silva, Maria Santos, Jo√£o Pereira, etc.">
                    <div class="error-message" id="user-name-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="user-value">Nome completo do paciente:</label>
                    <textarea id="user-value" rows="2" placeholder="Nome completo do paciente..." readonly></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="save-user-confirm-btn" class="button secondary">Salvar Nome</button>
                    <button type="button" id="save-user-cancel-btn" class="button danger">Cancelar</button>
                </div>
                
                <div class="esc-hint">Pressione ESC para cancelar</div>
                <div class="enter-hint">Pressione Enter no campo nome para salvar</div>
            </div>
        </div>

        <!-- Modal for saving hospital -->
        <div class="modal-overlay" id="save-hospital-modal-overlay">
            <div class="modal-content" id="save-hospital-modal-content">
                <button class="modal-close" id="save-hospital-modal-close-btn" title="Fechar (ESC)">√ó</button>
                <h3 class="modal-title">Salvar Hospital/Cl√≠nica</h3>
                
                <div class="form-group">
                    <label for="hospital-name">Nome para este hospital/cl√≠nica:</label>
                    <input type="text" id="hospital-name" placeholder="Ex: Santa B√°rbara, Hospital Geral, etc.">
                    <div class="error-message" id="hospital-name-error"></div>
                </div>
                
                <div class="form-group">
                    <label for="hospital-value">Nome do hospital/cl√≠nica:</label>
                    <textarea id="hospital-value" rows="2" placeholder="Nome do hospital/cl√≠nica..." readonly></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" id="save-hospital-confirm-btn" class="button secondary">Salvar Hospital/Cl√≠nica</button>
                    <button type="button" id="save-hospital-cancel-btn" class="button danger">Cancelar</button>
                </div>
                
                <div class="esc-hint">Pressione ESC para cancelar</div>
                <div class="enter-hint">Pressione Enter no campo nome para salvar</div>
            </div>
        </div>

        <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script>
            // Element references
            const globalPacientInput = document.getElementById('global-pacient');
            const globalHospitalInput = document.getElementById('global-hospital');
            const globalSpecialityInput = document.getElementById('global-speciality');
            const globalAddressInput = document.getElementById('global-address');
            const globalAddressAutocomplete = document.getElementById('global-address-autocomplete');
            const globalUserAutocomplete = document.getElementById('global-user-autocomplete');
            const globalHospitalAutocomplete = document.getElementById('global-hospital-autocomplete');
            const saveGlobalAddressBtn = document.getElementById('save-global-address-btn');
            const saveGlobalUserBtn = document.getElementById('save-global-user-btn');
            const globalSavedAddressesContainer = document.getElementById('global-saved-addresses');
            const globalSavedUsersContainer = document.getElementById('global-saved-users');
            const globalSavedHospitalsContainer = document.getElementById('global-saved-hospitals');
            const clearGlobalAddressesBtn = document.getElementById('clear-global-addresses');
            const clearGlobalUsersBtn = document.getElementById('clear-global-users');
            const clearGlobalHospitalsBtn = document.getElementById('clear-global-hospitals');
            
            // NEW: Global date and time inputs
            const globalDateInput = document.getElementById('global-date');
            const globalHourInput = document.getElementById('global-hour');
            const globalDateError = document.getElementById('global-date-error');
            const globalHourError = document.getElementById('global-hour-error');
            
            // NEW: Bot√µes de salvar nos campos
            const saveGlobalPacientBtn = document.getElementById('save-global-pacient-btn');
            const saveGlobalHospitalBtn = document.getElementById('save-global-hospital-btn');
            const saveGlobalAddressFieldBtn = document.getElementById('save-global-address-field-btn');
            
            const globalLogoUploadInput = document.getElementById('global-logo-upload');
            const globalUploadBtn = document.getElementById('global-upload-btn');
            const saveGlobalLogoBtn = document.getElementById('save-global-logo-btn');
            const removeGlobalLogoBtn = document.getElementById('remove-global-logo-btn');
            const globalLogoPreview = document.getElementById('global-logo-preview');
            const defaultLogoPlaceholder = document.getElementById('default-logo-placeholder');
            const globalSavedLogosContainer = document.getElementById('global-saved-logos');
            const clearGlobalLogosBtn = document.getElementById('clear-global-logos');
            const globalLogoAutocomplete = document.getElementById('global-logo-autocomplete');
            
            const layoutOptions = document.querySelectorAll('.layout-option');
            const paperInfo = document.getElementById('paper-info');
            const layoutInfo = document.getElementById('layout-info');
            const sizeInfo = document.getElementById('size-info');
            
            // Modal elements
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalPacientInput = document.getElementById('modal-pacient');
            const modalHospitalInput = document.getElementById('modal-hospital');
            const modalSpecialityInput = document.getElementById('modal-speciality');
            const modalDateInput = document.getElementById('modal-date');
            const modalHourInput = document.getElementById('modal-hour');
            const modalAddressInput = document.getElementById('modal-address');
            const modalAddressAutocomplete = document.getElementById('modal-address-autocomplete');
            const modalUserAutocomplete = document.getElementById('modal-user-autocomplete');
            const modalHospitalAutocomplete = document.getElementById('modal-hospital-autocomplete');
            const saveModalAddressBtn = document.getElementById('save-modal-address-btn');
            const saveModalUserBtn = document.getElementById('save-modal-user-btn');
            const modalSavedAddressesContainer = document.getElementById('modal-saved-addresses');
            const modalSavedUsersContainer = document.getElementById('modal-saved-users');
            const modalSavedHospitalsContainer = document.getElementById('modal-saved-hospitals');
            const modalCardNumberSpan = document.getElementById('modal-card-number');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');
            
            // NEW: Bot√µes de salvar nos campos do modal
            const saveModalPacientBtn = document.getElementById('save-modal-pacient-btn');
            const saveModalHospitalBtn = document.getElementById('save-modal-hospital-btn');
            const saveModalAddressFieldBtn = document.getElementById('save-modal-address-field-btn');
            
            // Modal error messages
            const modalPacientError = document.getElementById('modal-pacient-error');
            const modalHospitalError = document.getElementById('modal-hospital-error');
            const modalSpecialityError = document.getElementById('modal-speciality-error');
            const modalDateError = document.getElementById('modal-date-error');
            const modalHourError = document.getElementById('modal-hour-error');
            const modalAddressError = document.getElementById('modal-address-error');
            
            // Modal logo elements
            const modalLogoUploadInput = document.getElementById('modal-logo-upload');
            const modalUploadLogoBtn = document.getElementById('modal-upload-logo-btn');
            const saveModalLogoBtn = document.getElementById('save-modal-logo-btn');
            const modalRemoveLogoBtn = document.getElementById('modal-remove-logo-btn');
            const modalUseGlobalLogoBtn = document.getElementById('modal-use-global-logo-btn');
            const modalLogoPreview = document.getElementById('modal-logo-preview');
            const modalDefaultLogoPlaceholder = document.getElementById('modal-default-logo-placeholder');
            const modalSavedLogosContainer = document.getElementById('modal-saved-logos');
            const modalLogoAutocomplete = document.getElementById('modal-logo-autocomplete');
            
            // Save address modal elements
            const saveAddressModalOverlay = document.getElementById('save-address-modal-overlay');
            const saveAddressModalContent = document.getElementById('save-address-modal-content');
            const saveAddressModalCloseBtn = document.getElementById('save-address-modal-close-btn');
            const addressNameInput = document.getElementById('address-name');
            const addressValueInput = document.getElementById('address-value');
            const saveAddressConfirmBtn = document.getElementById('save-address-confirm-btn');
            const saveAddressCancelBtn = document.getElementById('save-address-cancel-btn');
            const addressNameError = document.getElementById('address-name-error');
            
            // Save logo modal elements
            const saveLogoModalOverlay = document.getElementById('save-logo-modal-overlay');
            const saveLogoModalContent = document.getElementById('save-logo-modal-content');
            const saveLogoModalCloseBtn = document.getElementById('save-logo-modal-close-btn');
            const logoNameInput = document.getElementById('logo-name');
            const saveLogoPreview = document.getElementById('save-logo-preview');
            const saveLogoConfirmBtn = document.getElementById('save-logo-confirm-btn');
            const saveLogoCancelBtn = document.getElementById('save-logo-cancel-btn');
            const logoNameError = document.getElementById('logo-name-error');
            
            // Save user modal elements
            const saveUserModalOverlay = document.getElementById('save-user-modal-overlay');
            const saveUserModalContent = document.getElementById('save-user-modal-content');
            const saveUserModalCloseBtn = document.getElementById('save-user-modal-close-btn');
            const userNameInput = document.getElementById('user-name');
            const userValueInput = document.getElementById('user-value');
            const saveUserConfirmBtn = document.getElementById('save-user-confirm-btn');
            const saveUserCancelBtn = document.getElementById('save-user-cancel-btn');
            const userNameError = document.getElementById('user-name-error');
            
            // NEW: Save hospital modal elements
            const saveHospitalModalOverlay = document.getElementById('save-hospital-modal-overlay');
            const saveHospitalModalContent = document.getElementById('save-hospital-modal-content');
            const saveHospitalModalCloseBtn = document.getElementById('save-hospital-modal-close-btn');
            const hospitalNameInput = document.getElementById('hospital-name');
            const hospitalValueInput = document.getElementById('hospital-value');
            const saveHospitalConfirmBtn = document.getElementById('save-hospital-confirm-btn');
            const saveHospitalCancelBtn = document.getElementById('save-hospital-cancel-btn');
            const hospitalNameError = document.getElementById('hospital-name-error');
            
            // Grid container
            const appointmentsGrid = document.getElementById('appointments-grid');
            
            // Buttons
            const applyAllBtn = document.getElementById('apply-all-btn');
            const resetAllBtn = document.getElementById('reset-all-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            const downloadImageBtn = document.getElementById('download-image-btn');
            const printBtn = document.getElementById('print-btn');
            
            // Store global and individual logo data
            let globalLogoDataURL = null;
            let currentEditingCardIndex = -1;
            let currentLayout = 2; // Default: 2 cards
            let individualLogos = Array(8).fill(null); // Store individual logos for each card
            
            // Store saved addresses, logos, and users
            let savedAddresses = [];
            let savedLogos = [];
            let savedUsers = [];
            let savedHospitals = []; // NEW: Store saved hospitals
            let addressToSave = null;
            let logoToSave = null;
            let userToSave = null;
            let hospitalToSave = null; // NEW: Store hospital to save
            let addressSaveContext = 'global'; // 'global' or 'modal'
            let logoSaveContext = 'global'; // 'global' or 'modal'
            let userSaveContext = 'global'; // 'global' or 'modal'
            let hospitalSaveContext = 'global'; // 'global' or 'modal'
            
            // NEW: Variables for copy/paste functionality
            let copiedCardData = null;
            let copiedCardLogo = null;
            let isCopying = false;
            
            // Layout configurations with calculated dimensions
            const layoutConfigs = {
                1: {
                    name: "1 Cart√£o",
                    layoutClass: "layout-1-card",
                    gridCols: 1,
                    gridRows: 1,
                    cardWidth: 180, // mm
                    cardHeight: 200, // mm
                    gap: 0, // mm
                    margin: 40, // mm
                    description: "(1√ó1) Cart√£o √∫nico grande"
                },
                2: {
                    name: "2 Cart√µes",
                    layoutClass: "layout-2-cards",
                    gridCols: 1,
                    gridRows: 2,
                    cardWidth: 180, // mm
                    cardHeight: 120, // mm
                    gap: 20, // mm
                    margin: 15, // mm
                    description: "(1√ó2) Cart√µes grandes"
                },
                4: {
                    name: "4 Cart√µes",
                    layoutClass: "layout-4-cards",
                    gridCols: 2,
                    gridRows: 2,
                    cardWidth: 90, // mm
                    cardHeight: 120, // mm
                    gap: 10, // mm
                    margin: 15, // mm
                    description: "(2√ó2) Cart√µes m√©dios"
                },
                6: {
                    name: "6 Cart√µes",
                    layoutClass: "layout-6-cards",
                    gridCols: 2,
                    gridRows: 3,
                    cardWidth: 90, // mm
                    cardHeight: 80, // mm
                    gap: 8, // mm
                    margin: 15, // mm
                    description: "(2√ó3) Cart√µes compactos"
                },
                8: {
                    name: "8 Cart√µes",
                    layoutClass: "layout-8-cards",
                    gridCols: 2,
                    gridRows: 4,
                    cardWidth: 90, // mm
                    cardHeight: 65, // mm
                    gap: 5, // mm
                    margin: 15, // mm
                    description: "(2√ó4) Cart√µes padr√£o"
                }
            };
            
            // Default data for cards
            const defaultCardData = {
                pacient: "Alex Silva",
                hospital: "Santa B√°rbara",
                speciality: "otorrinolaringologista",
                date: "23/01/2026",
                hour: "08:00",
                address: "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA"
            };
            
            // Store individual card data (max 8 cards)
            let cardData = Array(8).fill(null).map(() => ({...defaultCardData}));
            
            // Show feedback message
            function showFeedback(message, type = 'info') {
                // Remove any existing feedback
                const existingFeedback = document.querySelector('.feedback-message');
                if (existingFeedback) {
                    existingFeedback.remove();
                }
                
                // Create feedback element
                const feedback = document.createElement('div');
                feedback.className = `feedback-message feedback-${type}`;
                feedback.textContent = message;
                feedback.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 600;
                    z-index: 9999;
                    animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 300px;
                `;
                
                // Set color based on type
                if (type === 'success') {
                    feedback.style.backgroundColor = '#28a745';
                } else if (type === 'error') {
                    feedback.style.backgroundColor = '#dc3545';
                } else if (type === 'warning') {
                    feedback.style.backgroundColor = '#ffc107';
                    feedback.style.color = '#212529';
                } else {
                    feedback.style.backgroundColor = '#1a5f7a';
                }
                
                document.body.appendChild(feedback);
                
                // Remove after animation
                setTimeout(() => {
                    if (feedback.parentNode) {
                        feedback.remove();
                    }
                }, 3000);
            }
            
            // Helper function to set button loading state
            function setButtonLoading(button, isLoading) {
                if (isLoading) {
                    button.dataset.originalText = button.textContent;
                    button.innerHTML = '<span class="button-spinner">‚è≥</span> Processando...';
                    button.disabled = true;
                } else {
                    if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                    }
                    button.disabled = false;
                }
            }
            
            // Load saved addresses from localStorage
            function loadSavedAddresses() {
                const saved = localStorage.getItem('medicalAppointmentAddresses');
                if (saved) {
                    savedAddresses = JSON.parse(saved);
                } else {
                    // Add some default addresses
                    savedAddresses = [
                        { id: 1, name: "Cl√≠nica Santa B√°rbara", address: "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA, 40285-000" },
                        { id: 2, name: "Hospital Geral", address: "Rua do Salete, 100 - Barris, Salvador - BA, 40070-000" },
                        { id: 3, name: "Centro M√©dico", address: "Av. Tancredo Neves, 3133 - Caminho das √Årvores, Salvador - BA, 41820-020" }
                    ];
                    saveAddressesToStorage();
                }
                renderSavedAddresses();
            }
            
            // Load saved logos from localStorage
            function loadSavedLogos() {
                const saved = localStorage.getItem('medicalAppointmentLogos');
                if (saved) {
                    savedLogos = JSON.parse(saved);
                } else {
                    // Add some default logos (empty array - user will add their own)
                    savedLogos = [];
                    saveLogosToStorage();
                }
                renderSavedLogos();
            }
            
            // Load saved users from localStorage
            function loadSavedUsers() {
                const saved = localStorage.getItem('medicalAppointmentUsers');
                if (saved) {
                    savedUsers = JSON.parse(saved);
                } else {
                    // Add some default users
                    savedUsers = [
                        { id: 1, name: "Alex Silva", fullName: "Alex Silva" },
                        { id: 2, name: "Maria Santos", fullName: "Maria Santos" },
                        { id: 3, name: "Jo√£o Pereira", fullName: "Jo√£o Pereira" },
                        { id: 4, name: "Ana Oliveira", fullName: "Ana Oliveira" }
                    ];
                    saveUsersToStorage();
                }
                renderSavedUsers();
            }
            
            // NEW: Load saved hospitals from localStorage
            function loadSavedHospitals() {
                const saved = localStorage.getItem('medicalAppointmentHospitals');
                if (saved) {
                    savedHospitals = JSON.parse(saved);
                } else {
                    // Add some default hospitals
                    savedHospitals = [
                        { id: 1, name: "Santa B√°rbara", hospitalName: "Santa B√°rbara" },
                        { id: 2, name: "Hospital Geral", hospitalName: "Hospital Geral" },
                        { id: 3, name: "Centro M√©dico", hospitalName: "Centro M√©dico" }
                    ];
                    saveHospitalsToStorage();
                }
                renderSavedHospitals();
            }
            
            // Save addresses to localStorage
            function saveAddressesToStorage() {
                localStorage.setItem('medicalAppointmentAddresses', JSON.stringify(savedAddresses));
            }
            
            // Save logos to localStorage
            function saveLogosToStorage() {
                localStorage.setItem('medicalAppointmentLogos', JSON.stringify(savedLogos));
            }
            
            // Save users to localStorage
            function saveUsersToStorage() {
                localStorage.setItem('medicalAppointmentUsers', JSON.stringify(savedUsers));
            }
            
            // NEW: Save hospitals to localStorage
            function saveHospitalsToStorage() {
                localStorage.setItem('medicalAppointmentHospitals', JSON.stringify(savedHospitals));
            }
            
            // Render saved addresses in a container
            function renderSavedAddresses(container = null, onClickCallback = null) {
                const containers = container ? [container] : [globalSavedAddressesContainer, modalSavedAddressesContainer];
                
                containers.forEach(container => {
                    if (!container) return;
                    
                    if (savedAddresses.length === 0) {
                        container.innerHTML = '<div class="no-addresses">Nenhum endere√ßo salvo ainda</div>';
                        return;
                    }
                    
                    let html = '';
                    savedAddresses.forEach(address => {
                        html += `
                            <div class="saved-address-item" data-address-id="${address.id}">
                                <div class="address-info">
                                    <div class="address-label">${address.name}</div>
                                    <div class="address-text">${address.address}</div>
                                </div>
                                <div class="address-actions">
                                    <button class="address-action-btn use-btn" title="Usar este endere√ßo">üìã</button>
                                    <button class="address-action-btn delete-btn" title="Excluir endere√ßo">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Add event listeners
                    container.querySelectorAll('.use-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const addressId = parseInt(this.closest('.saved-address-item').dataset.addressId);
                            const address = savedAddresses.find(a => a.id === addressId);
                            if (address && onClickCallback) {
                                onClickCallback(address.address);
                            } else if (address) {
                                // Default behavior: fill the input
                                if (container === globalSavedAddressesContainer) {
                                    globalAddressInput.value = address.address;
                                    hideAutocomplete(globalAddressAutocomplete);
                                } else if (container === modalSavedAddressesContainer) {
                                    modalAddressInput.value = address.address;
                                    hideAutocomplete(modalAddressAutocomplete);
                                }
                            }
                        });
                    });
                    
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const addressId = parseInt(this.closest('.saved-address-item').dataset.addressId);
                            deleteAddress(addressId);
                        });
                    });
                    
                    container.querySelectorAll('.saved-address-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (!e.target.closest('.address-actions')) {
                                const addressId = parseInt(this.dataset.addressId);
                                const address = savedAddresses.find(a => a.id === addressId);
                                if (address && onClickCallback) {
                                    onClickCallback(address.address);
                                } else if (address) {
                                    // Default behavior: fill the input
                                    if (container === globalSavedAddressesContainer) {
                                        globalAddressInput.value = address.address;
                                        hideAutocomplete(globalAddressAutocomplete);
                                    } else if (container === modalSavedAddressesContainer) {
                                        modalAddressInput.value = address.address;
                                        hideAutocomplete(modalAddressAutocomplete);
                                    }
                                }
                            }
                        });
                    });
                });
            }
            
            // Render saved logos in a container
            function renderSavedLogos(container = null, onClickCallback = null) {
                const containers = container ? [container] : [globalSavedLogosContainer, modalSavedLogosContainer];
                
                containers.forEach(container => {
                    if (!container) return;
                    
                    if (savedLogos.length === 0) {
                        container.innerHTML = '<div class="no-logos">Nenhum logo salvo ainda</div>';
                        return;
                    }
                    
                    let html = '';
                    savedLogos.forEach(logo => {
                        html += `
                            <div class="saved-logo-item" data-logo-id="${logo.id}">
                                <div class="logo-info" style="display: flex; align-items: center; gap: 10px;">
                                    <img src="${logo.dataURL}" class="logo-preview-small" alt="${logo.name}">
                                    <div>
                                        <div class="logo-label">${logo.name}</div>
                                    </div>
                                </div>
                                <div class="logo-actions">
                                    <button class="logo-action-btn use-btn" title="Usar este logo">üìã</button>
                                    <button class="logo-action-btn delete-btn" title="Excluir logo">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Add event listeners
                    container.querySelectorAll('.use-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const logoId = parseInt(this.closest('.saved-logo-item').dataset.logoId);
                            const logo = savedLogos.find(l => l.id === logoId);
                            if (logo && onClickCallback) {
                                onClickCallback(logo.dataURL);
                            } else if (logo) {
                                // Default behavior: set the logo
                                if (container === globalSavedLogosContainer) {
                                    setGlobalLogo(logo.dataURL);
                                } else if (container === modalSavedLogosContainer && currentEditingCardIndex !== -1) {
                                    setModalLogo(logo.dataURL);
                                }
                            }
                        });
                    });
                    
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const logoId = parseInt(this.closest('.saved-logo-item').dataset.logoId);
                            deleteLogo(logoId);
                        });
                    });
                    
                    container.querySelectorAll('.saved-logo-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (!e.target.closest('.logo-actions')) {
                                const logoId = parseInt(this.dataset.logoId);
                                const logo = savedLogos.find(l => l.id === logoId);
                                if (logo && onClickCallback) {
                                    onClickCallback(logo.dataURL);
                                } else if (logo) {
                                    // Default behavior: set the logo
                                    if (container === globalSavedLogosContainer) {
                                        setGlobalLogo(logo.dataURL);
                                    } else if (container === modalSavedLogosContainer && currentEditingCardIndex !== -1) {
                                        setModalLogo(logo.dataURL);
                                    }
                                }
                            }
                        });
                    });
                });
            }
            
            // Render saved users in a container
            function renderSavedUsers(container = null, onClickCallback = null) {
                const containers = container ? [container] : [globalSavedUsersContainer, modalSavedUsersContainer];
                
                containers.forEach(container => {
                    if (!container) return;
                    
                    if (savedUsers.length === 0) {
                        container.innerHTML = '<div class="no-users">Nenhum nome salvo ainda</div>';
                        return;
                    }
                    
                    let html = '';
                    savedUsers.forEach(user => {
                        html += `
                            <div class="saved-user-item" data-user-id="${user.id}">
                                <div class="user-info">
                                    <div class="user-label">${user.name}</div>
                                    <div class="user-text">${user.fullName}</div>
                                </div>
                                <div class="user-actions">
                                    <button class="user-action-btn use-btn" title="Usar este nome">üìã</button>
                                    <button class="user-action-btn delete-btn" title="Excluir nome">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Add event listeners
                    container.querySelectorAll('.use-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const userId = parseInt(this.closest('.saved-user-item').dataset.userId);
                            const user = savedUsers.find(u => u.id === userId);
                            if (user && onClickCallback) {
                                onClickCallback(user.fullName);
                            } else if (user) {
                                // Default behavior: fill the input
                                if (container === globalSavedUsersContainer) {
                                    globalPacientInput.value = user.fullName;
                                    hideAutocomplete(globalUserAutocomplete);
                                } else if (container === modalSavedUsersContainer) {
                                    modalPacientInput.value = user.fullName;
                                    hideAutocomplete(modalUserAutocomplete);
                                }
                            }
                        });
                    });
                    
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const userId = parseInt(this.closest('.saved-user-item').dataset.userId);
                            deleteUser(userId);
                        });
                    });
                    
                    container.querySelectorAll('.saved-user-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (!e.target.closest('.user-actions')) {
                                const userId = parseInt(this.dataset.userId);
                                const user = savedUsers.find(u => u.id === userId);
                                if (user && onClickCallback) {
                                    onClickCallback(user.fullName);
                                } else if (user) {
                                    // Default behavior: fill the input
                                    if (container === globalSavedUsersContainer) {
                                        globalPacientInput.value = user.fullName;
                                        hideAutocomplete(globalUserAutocomplete);
                                    } else if (container === modalSavedUsersContainer) {
                                        modalPacientInput.value = user.fullName;
                                        hideAutocomplete(modalUserAutocomplete);
                                    }
                                }
                            }
                        });
                    });
                });
            }
            
            // Render saved hospitals in a container
            function renderSavedHospitals(container = null, onClickCallback = null) {
                const containers = container ? [container] : [globalSavedHospitalsContainer, modalSavedHospitalsContainer];
                
                containers.forEach(container => {
                    if (!container) return;
                    
                    if (savedHospitals.length === 0) {
                        container.innerHTML = '<div class="no-hospitals">Nenhum hospital/cl√≠nica salvo ainda</div>';
                        return;
                    }
                    
                    let html = '';
                    savedHospitals.forEach(hospital => {
                        html += `
                            <div class="saved-hospital-item" data-hospital-id="${hospital.id}">
                                <div class="hospital-info">
                                    <div class="hospital-label">${hospital.name}</div>
                                    <div class="hospital-text">${hospital.hospitalName}</div>
                                </div>
                                <div class="hospital-actions">
                                    <button class="hospital-action-btn use-btn" title="Usar este hospital/cl√≠nica">üìã</button>
                                    <button class="hospital-action-btn delete-btn" title="Excluir hospital/cl√≠nica">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                    
                    // Add event listeners
                    container.querySelectorAll('.use-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const hospitalId = parseInt(this.closest('.saved-hospital-item').dataset.hospitalId);
                            const hospital = savedHospitals.find(h => h.id === hospitalId);
                            if (hospital && onClickCallback) {
                                onClickCallback(hospital.hospitalName);
                            } else if (hospital) {
                                // Default behavior: fill the input
                                if (container === globalSavedHospitalsContainer) {
                                    globalHospitalInput.value = hospital.hospitalName;
                                    hideAutocomplete(globalHospitalAutocomplete);
                                } else if (container === modalSavedHospitalsContainer) {
                                    modalHospitalInput.value = hospital.hospitalName;
                                    hideAutocomplete(modalHospitalAutocomplete);
                                }
                            }
                        });
                    });
                    
                    container.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const hospitalId = parseInt(this.closest('.saved-hospital-item').dataset.hospitalId);
                            deleteHospital(hospitalId);
                        });
                    });
                    
                    container.querySelectorAll('.saved-hospital-item').forEach(item => {
                        item.addEventListener('click', function(e) {
                            if (!e.target.closest('.hospital-actions')) {
                                const hospitalId = parseInt(this.dataset.hospitalId);
                                const hospital = savedHospitals.find(h => h.id === hospitalId);
                                if (hospital && onClickCallback) {
                                    onClickCallback(hospital.hospitalName);
                                } else if (hospital) {
                                    // Default behavior: fill the input
                                    if (container === globalSavedHospitalsContainer) {
                                        globalHospitalInput.value = hospital.hospitalName;
                                        hideAutocomplete(globalHospitalAutocomplete);
                                    } else if (container === modalSavedHospitalsContainer) {
                                        modalHospitalInput.value = hospital.hospitalName;
                                        hideAutocomplete(modalHospitalAutocomplete);
                                    }
                                }
                            }
                        });
                    });
                });
            }
            
            // Show autocomplete suggestions for addresses
            function showAddressAutocompleteSuggestions(input, autocompleteContainer, addresses) {
                const query = input.value.toLowerCase();
                if (query.length < 2) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                const suggestions = savedAddresses.filter(address => 
                    address.name.toLowerCase().includes(query) || 
                    address.address.toLowerCase().includes(query)
                );
                
                if (suggestions.length === 0) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                let html = '';
                suggestions.forEach(address => {
                    html += `
                        <div class="address-suggestion" data-address="${address.address}">
                            <div class="address-name">${address.name}</div>
                            <div class="address-value">${address.address}</div>
                        </div>
                    `;
                });
                
                autocompleteContainer.innerHTML = html;
                autocompleteContainer.style.display = 'block';
                
                // Add event listeners to suggestions
                autocompleteContainer.querySelectorAll('.address-suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', function() {
                        const address = this.dataset.address;
                        input.value = address;
                        hideAutocomplete(autocompleteContainer);
                        input.focus();
                    });
                });
            }
            
            // Show autocomplete suggestions for logos
            function showLogoAutocompleteSuggestions(input, autocompleteContainer, logos) {
                const query = input ? input.value.toLowerCase() : '';
                if (query.length < 1) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                const suggestions = savedLogos.filter(logo => 
                    logo.name.toLowerCase().includes(query)
                );
                
                if (suggestions.length === 0) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                let html = '';
                suggestions.forEach(logo => {
                    html += `
                        <div class="logo-suggestion" data-logo-url="${logo.dataURL}">
                            <img src="${logo.dataURL}" class="logo-preview-img" alt="${logo.name}">
                            <div class="logo-info">
                                <div class="logo-name">${logo.name}</div>
                            </div>
                        </div>
                    `;
                });
                
                autocompleteContainer.innerHTML = html;
                autocompleteContainer.style.display = 'block';
                
                // Add event listeners to suggestions
                autocompleteContainer.querySelectorAll('.logo-suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', function() {
                        const logoDataURL = this.dataset.logoUrl;
                        if (autocompleteContainer === globalLogoAutocomplete) {
                            setGlobalLogo(logoDataURL);
                        } else if (autocompleteContainer === modalLogoAutocomplete && currentEditingCardIndex !== -1) {
                            setModalLogo(logoDataURL);
                        }
                        hideAutocomplete(autocompleteContainer);
                    });
                });
            }
            
            // Show autocomplete suggestions for users
            function showUserAutocompleteSuggestions(input, autocompleteContainer, users) {
                const query = input.value.toLowerCase();
                if (query.length < 2) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                const suggestions = savedUsers.filter(user => 
                    user.name.toLowerCase().includes(query) || 
                    user.fullName.toLowerCase().includes(query)
                );
                
                if (suggestions.length === 0) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                let html = '';
                suggestions.forEach(user => {
                    html += `
                        <div class="user-suggestion" data-user="${user.fullName}">
                            <div class="user-name">${user.name}</div>
                            <div class="user-value">${user.fullName}</div>
                        </div>
                    `;
                });
                
                autocompleteContainer.innerHTML = html;
                autocompleteContainer.style.display = 'block';
                
                // Add event listeners to suggestions
                autocompleteContainer.querySelectorAll('.user-suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', function() {
                        const user = this.dataset.user;
                        input.value = user;
                        hideAutocomplete(autocompleteContainer);
                        input.focus();
                    });
                });
            }
            
            // Show autocomplete suggestions for hospitals
            function showHospitalAutocompleteSuggestions(input, autocompleteContainer, hospitals) {
                const query = input.value.toLowerCase();
                if (query.length < 2) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                const suggestions = savedHospitals.filter(hospital => 
                    hospital.name.toLowerCase().includes(query) || 
                    hospital.hospitalName.toLowerCase().includes(query)
                );
                
                if (suggestions.length === 0) {
                    hideAutocomplete(autocompleteContainer);
                    return;
                }
                
                let html = '';
                suggestions.forEach(hospital => {
                    html += `
                        <div class="hospital-suggestion" data-hospital="${hospital.hospitalName}">
                            <div class="hospital-name">${hospital.name}</div>
                            <div class="hospital-value">${hospital.hospitalName}</div>
                        </div>
                    `;
                });
                
                autocompleteContainer.innerHTML = html;
                autocompleteContainer.style.display = 'block';
                
                // Add event listeners to suggestions
                autocompleteContainer.querySelectorAll('.hospital-suggestion').forEach(suggestion => {
                    suggestion.addEventListener('click', function() {
                        const hospital = this.dataset.hospital;
                        input.value = hospital;
                        hideAutocomplete(autocompleteContainer);
                        input.focus();
                    });
                });
            }
            
            // Hide autocomplete
            function hideAutocomplete(autocompleteContainer) {
                autocompleteContainer.style.display = 'none';
            }
            
            // Show error on input
            function showError(inputElement, errorElement, message) {
                inputElement.classList.add('error');
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
            
            // Clear error from input
            function clearError(inputElement, errorElement) {
                inputElement.classList.remove('error');
                errorElement.textContent = '';
                errorElement.classList.remove('show');
            }
            
            // Validate date input
            function validateDate(dateString) {
                if (!dateString) {
                    return { isValid: false, message: "Por favor, selecione uma data" };
                }
                
                const date = new Date(dateString);
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Set to beginning of today
                
                // Check if date is valid
                if (isNaN(date.getTime())) {
                    return { isValid: false, message: "Data inv√°lida" };
                }
                
                // Check if date is in the past
                if (date < today) {
                    return { isValid: false, message: "A data n√£o pode ser no passado" };
                }
                
                // Check if date is too far in the future (optional, e.g., 5 years)
                const maxDate = new Date();
                maxDate.setFullYear(today.getFullYear() + 5);
                if (date > maxDate) {
                    return { isValid: false, message: "A data n√£o pode ser mais de 5 anos no futuro" };
                }
                
                return { isValid: true, message: "" };
            }
            
            // Validate time input
            function validateTime(timeString) {
                if (!timeString) {
                    return { isValid: false, message: "Por favor, selecione um hor√°rio" };
                }
                
                // Check if time is in valid format (HH:MM)
                const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
                if (!timeRegex.test(timeString)) {
                    return { isValid: false, message: "Hor√°rio inv√°lido. Use o formato HH:MM" };
                }
                
                // Check if time is within reasonable hours (e.g., 6:00 to 22:00)
                const [hours, minutes] = timeString.split(':').map(Number);
                if (hours < 6 || hours > 22) {
                    return { isValid: false, message: "Hor√°rio deve ser entre 06:00 e 22:00" };
                }
                
                return { isValid: true, message: "" };
            }
            
            // Validate required text input
            function validateRequiredText(inputValue, fieldName) {
                if (!inputValue || inputValue.trim() === '') {
                    return { isValid: false, message: `Por favor, preencha o campo ${fieldName}` };
                }
                
                if (inputValue.trim().length < 2) {
                    return { isValid: false, message: `${fieldName} deve ter pelo menos 2 caracteres` };
                }
                
                return { isValid: true, message: "" };
            }
            
            // Validate modal form
            function validateModalForm() {
                let isValid = true;
                
                // Validate patient name
                const patientValidation = validateRequiredText(modalPacientInput.value, "nome do paciente");
                if (!patientValidation.isValid) {
                    showError(modalPacientInput, modalPacientError, patientValidation.message);
                    isValid = false;
                } else {
                    clearError(modalPacientInput, modalPacientError);
                }
                
                // Validate hospital name
                const hospitalValidation = validateRequiredText(modalHospitalInput.value, "hospital/cl√≠nica");
                if (!hospitalValidation.isValid) {
                    showError(modalHospitalInput, modalHospitalError, hospitalValidation.message);
                    isValid = false;
                } else {
                    clearError(modalHospitalInput, modalHospitalError);
                }
                
                // Validate address
                const addressValidation = validateRequiredText(modalAddressInput.value, "endere√ßo");
                if (!addressValidation.isValid) {
                    showError(modalAddressInput, modalAddressError, addressValidation.message);
                    isValid = false;
                } else {
                    clearError(modalAddressInput, modalAddressError);
                }
                
                // Validate date
                const dateValidation = validateDate(modalDateInput.value);
                if (!dateValidation.isValid) {
                    showError(modalDateInput, modalDateError, dateValidation.message);
                    isValid = false;
                } else {
                    clearError(modalDateInput, modalDateError);
                }
                
                // Validate time
                const timeValidation = validateTime(modalHourInput.value);
                if (!timeValidation.isValid) {
                    showError(modalHourInput, modalHourError, timeValidation.message);
                    isValid = false;
                } else {
                    clearError(modalHourInput, modalHourError);
                }
                
                return isValid;
            }
            
            // Open save address modal
            function openSaveAddressModal(address, context) {
                addressToSave = address;
                addressSaveContext = context;
                addressNameInput.value = '';
                addressValueInput.value = address;
                
                // Generate a default name based on the address
                const parts = address.split(',');
                if (parts.length > 0) {
                    addressNameInput.value = parts[0].trim();
                }
                
                saveAddressModalOverlay.style.display = 'flex';
                addressNameInput.focus();
                
                // Add ESC key listener
                document.addEventListener('keydown', handleSaveAddressEscKey);
                // Add Enter key listener
                document.addEventListener('keydown', handleSaveAddressEnterKey);
            }
            
            // Open save logo modal
            function openSaveLogoModal(logoDataURL, context) {
                logoToSave = logoDataURL;
                logoSaveContext = context;
                logoNameInput.value = '';
                saveLogoPreview.src = logoDataURL;
                
                // Generate a default name
                if (context === 'global' && globalHospitalInput.value) {
                    logoNameInput.value = `Logo ${globalHospitalInput.value}`;
                } else if (context === 'modal' && modalHospitalInput.value) {
                    logoNameInput.value = `Logo ${modalHospitalInput.value}`;
                } else {
                    logoNameInput.value = 'Meu Logo';
                }
                
                saveLogoModalOverlay.style.display = 'flex';
                logoNameInput.focus();
                
                // Add ESC key listener
                document.addEventListener('keydown', handleSaveLogoEscKey);
                // Add Enter key listener
                document.addEventListener('keydown', handleSaveLogoEnterKey);
            }
            
            // Open save user modal
            function openSaveUserModal(user, context) {
                userToSave = user;
                userSaveContext = context;
                userNameInput.value = '';
                userValueInput.value = user;
                
                // Generate a default name based on the user
                const parts = user.split(' ');
                if (parts.length > 0) {
                    userNameInput.value = user;
                }
                
                saveUserModalOverlay.style.display = 'flex';
                userNameInput.focus();
                
                // Add ESC key listener
                document.addEventListener('keydown', handleSaveUserEscKey);
                // Add Enter key listener
                document.addEventListener('keydown', handleSaveUserEnterKey);
            }
            
            // NEW: Open save hospital modal
            function openSaveHospitalModal(hospital, context) {
                hospitalToSave = hospital;
                hospitalSaveContext = context;
                hospitalNameInput.value = '';
                hospitalValueInput.value = hospital;
                
                // Generate a default name based on the hospital
                hospitalNameInput.value = hospital;
                
                saveHospitalModalOverlay.style.display = 'flex';
                hospitalNameInput.focus();
                
                // Add ESC key listener
                document.addEventListener('keydown', handleSaveHospitalEscKey);
                // Add Enter key listener
                document.addEventListener('keydown', handleSaveHospitalEnterKey);
            }
            
            // Close save address modal
            function closeSaveAddressModal() {
                saveAddressModalOverlay.style.display = 'none';
                addressToSave = null;
                clearError(addressNameInput, addressNameError);
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleSaveAddressEscKey);
                // Remove Enter key listener
                document.removeEventListener('keydown', handleSaveAddressEnterKey);
            }
            
            // Close save logo modal
            function closeSaveLogoModal() {
                saveLogoModalOverlay.style.display = 'none';
                logoToSave = null;
                clearError(logoNameInput, logoNameError);
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleSaveLogoEscKey);
                // Remove Enter key listener
                document.removeEventListener('keydown', handleSaveLogoEnterKey);
            }
            
            // Close save user modal
            function closeSaveUserModal() {
                saveUserModalOverlay.style.display = 'none';
                userToSave = null;
                clearError(userNameInput, userNameError);
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleSaveUserEscKey);
                // Remove Enter key listener
                document.removeEventListener('keydown', handleSaveUserEnterKey);
            }
            
            // NEW: Close save hospital modal
            function closeSaveHospitalModal() {
                saveHospitalModalOverlay.style.display = 'none';
                hospitalToSave = null;
                clearError(hospitalNameInput, hospitalNameError);
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleSaveHospitalEscKey);
                // Remove Enter key listener
                document.removeEventListener('keydown', handleSaveHospitalEnterKey);
            }
            
            // Handle ESC key for save address modal
            function handleSaveAddressEscKey(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    closeSaveAddressModal();
                }
            }
            
            // Handle ESC key for save logo modal
            function handleSaveLogoEscKey(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    closeSaveLogoModal();
                }
            }
            
            // Handle ESC key for save user modal
            function handleSaveUserEscKey(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    closeSaveUserModal();
                }
            }
            
            // NEW: Handle ESC key for save hospital modal
            function handleSaveHospitalEscKey(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    closeSaveHospitalModal();
                }
            }
            
            // Handle Enter key for save address modal
            function handleSaveAddressEnterKey(event) {
                if (event.key === 'Enter' && event.target === addressNameInput) {
                    event.preventDefault();
                    saveNewAddress(addressNameInput.value.trim(), addressValueInput.value.trim());
                }
            }
            
            // Handle Enter key for save logo modal
            function handleSaveLogoEnterKey(event) {
                if (event.key === 'Enter' && event.target === logoNameInput) {
                    event.preventDefault();
                    saveNewLogo(logoNameInput.value.trim(), logoToSave);
                }
            }
            
            // Handle Enter key for save user modal
            function handleSaveUserEnterKey(event) {
                if (event.key === 'Enter' && event.target === userNameInput) {
                    event.preventDefault();
                    saveNewUser(userNameInput.value.trim(), userValueInput.value.trim());
                }
            }
            
            // NEW: Handle Enter key for save hospital modal
            function handleSaveHospitalEnterKey(event) {
                if (event.key === 'Enter' && event.target === hospitalNameInput) {
                    event.preventDefault();
                    saveNewHospital(hospitalNameInput.value.trim(), hospitalValueInput.value.trim());
                }
            }
            
            // Save new address
            function saveNewAddress(name, address) {
                // Validate name
                const nameValidation = validateRequiredText(name, "nome do endere√ßo");
                if (!nameValidation.isValid) {
                    showError(addressNameInput, addressNameError, nameValidation.message);
                    return;
                }
                
                // Validate address
                const addressValidation = validateRequiredText(address, "endere√ßo");
                if (!addressValidation.isValid) {
                    showFeedback('Por favor, forne√ßa um endere√ßo v√°lido.', 'error');
                    return;
                }
                
                // Check if address already exists
                const existingAddress = savedAddresses.find(a => 
                    a.name.toLowerCase() === name.toLowerCase() || 
                    a.address.toLowerCase() === address.toLowerCase()
                );
                
                if (existingAddress) {
                    showFeedback('Este endere√ßo j√° est√° salvo.', 'warning');
                    return;
                }
                
                // Generate new ID
                const newId = savedAddresses.length > 0 ? Math.max(...savedAddresses.map(a => a.id)) + 1 : 1;
                
                // Add new address
                savedAddresses.push({
                    id: newId,
                    name: name.trim(),
                    address: address.trim()
                });
                
                // Save to localStorage
                saveAddressesToStorage();
                
                // Re-render addresses
                renderSavedAddresses();
                
                // Close modal
                closeSaveAddressModal();
                
                // Show success message
                showFeedback(`Endere√ßo "${name}" salvo com sucesso!`, 'success');
            }
            
            // Save new logo
            function saveNewLogo(name, logoDataURL) {
                // Validate name
                const nameValidation = validateRequiredText(name, "nome do logo");
                if (!nameValidation.isValid) {
                    showError(logoNameInput, logoNameError, nameValidation.message);
                    return;
                }
                
                if (!logoDataURL) {
                    showFeedback('Por favor, forne√ßa um logo v√°lido.', 'error');
                    return;
                }
                
                // Check if logo with same name already exists
                const existingLogo = savedLogos.find(l => 
                    l.name.toLowerCase() === name.toLowerCase()
                );
                
                if (existingLogo) {
                    showFeedback('J√° existe um logo salvo com este nome. Por favor, use um nome diferente.', 'warning');
                    return;
                }
                
                // Generate new ID
                const newId = savedLogos.length > 0 ? Math.max(...savedLogos.map(l => l.id)) + 1 : 1;
                
                // Add new logo
                savedLogos.push({
                    id: newId,
                    name: name.trim(),
                    dataURL: logoDataURL
                });
                
                // Save to localStorage
                saveLogosToStorage();
                
                // Re-render logos
                renderSavedLogos();
                
                // Close modal
                closeSaveLogoModal();
                
                // Show success message
                showFeedback(`Logo "${name}" salvo com sucesso!`, 'success');
            }
            
            // Save new user
            function saveNewUser(name, fullName) {
                // Validate name
                const nameValidation = validateRequiredText(name, "nome do paciente");
                if (!nameValidation.isValid) {
                    showError(userNameInput, userNameError, nameValidation.message);
                    return;
                }
                
                // Validate full name
                const fullNameValidation = validateRequiredText(fullName, "nome completo");
                if (!fullNameValidation.isValid) {
                    showFeedback('Por favor, forne√ßa um nome completo v√°lido.', 'error');
                    return;
                }
                
                // Check if user already exists
                const existingUser = savedUsers.find(u => 
                    u.name.toLowerCase() === name.toLowerCase() || 
                    u.fullName.toLowerCase() === fullName.toLowerCase()
                );
                
                if (existingUser) {
                    showFeedback('Este nome j√° est√° salvo.', 'warning');
                    return;
                }
                
                // Generate new ID
                const newId = savedUsers.length > 0 ? Math.max(...savedUsers.map(u => u.id)) + 1 : 1;
                
                // Add new user
                savedUsers.push({
                    id: newId,
                    name: name.trim(),
                    fullName: fullName.trim()
                });
                
                // Save to localStorage
                saveUsersToStorage();
                
                // Re-render users
                renderSavedUsers();
                
                // Close modal
                closeSaveUserModal();
                
                // Show success message
                showFeedback(`Nome "${name}" salvo com sucesso!`, 'success');
            }
            
            // NEW: Save new hospital
            function saveNewHospital(name, hospitalName) {
                // Validate name
                const nameValidation = validateRequiredText(name, "nome do hospital/cl√≠nica");
                if (!nameValidation.isValid) {
                    showError(hospitalNameInput, hospitalNameError, nameValidation.message);
                    return;
                }
                
                // Validate hospital name
                const hospitalValidation = validateRequiredText(hospitalName, "hospital/cl√≠nica");
                if (!hospitalValidation.isValid) {
                    showFeedback('Por favor, forne√ßa um nome de hospital/cl√≠nica v√°lido.', 'error');
                    return;
                }
                
                // Check if hospital already exists
                const existingHospital = savedHospitals.find(h => 
                    h.name.toLowerCase() === name.toLowerCase() || 
                    h.hospitalName.toLowerCase() === hospitalName.toLowerCase()
                );
                
                if (existingHospital) {
                    showFeedback('Este hospital/cl√≠nica j√° est√° salvo.', 'warning');
                    return;
                }
                
                // Generate new ID
                const newId = savedHospitals.length > 0 ? Math.max(...savedHospitals.map(h => h.id)) + 1 : 1;
                
                // Add new hospital
                savedHospitals.push({
                    id: newId,
                    name: name.trim(),
                    hospitalName: hospitalName.trim()
                });
                
                // Save to localStorage
                saveHospitalsToStorage();
                
                // Re-render hospitals
                renderSavedHospitals();
                
                // Close modal
                closeSaveHospitalModal();
                
                // Show success message
                showFeedback(`Hospital/Cl√≠nica "${name}" salvo com sucesso!`, 'success');
            }
            
            // Delete address
            function deleteAddress(addressId) {
                if (confirm('Tem certeza que deseja excluir este endere√ßo salvo?')) {
                    savedAddresses = savedAddresses.filter(a => a.id !== addressId);
                    saveAddressesToStorage();
                    renderSavedAddresses();
                    showFeedback('Endere√ßo exclu√≠do com sucesso!', 'success');
                }
            }
            
            // Delete logo
            function deleteLogo(logoId) {
                if (confirm('Tem certeza que deseja excluir este logo salvo?')) {
                    savedLogos = savedLogos.filter(l => l.id !== logoId);
                    saveLogosToStorage();
                    renderSavedLogos();
                    showFeedback('Logo exclu√≠do com sucesso!', 'success');
                }
            }
            
            // Delete user
            function deleteUser(userId) {
                if (confirm('Tem certeza que deseja excluir este nome salvo?')) {
                    savedUsers = savedUsers.filter(u => u.id !== userId);
                    saveUsersToStorage();
                    renderSavedUsers();
                    showFeedback('Nome exclu√≠do com sucesso!', 'success');
                }
            }
            
            // NEW: Delete hospital
            function deleteHospital(hospitalId) {
                if (confirm('Tem certeza que deseja excluir este hospital/cl√≠nica salvo?')) {
                    savedHospitals = savedHospitals.filter(h => h.id !== hospitalId);
                    saveHospitalsToStorage();
                    renderSavedHospitals();
                    showFeedback('Hospital/Cl√≠nica exclu√≠do com sucesso!', 'success');
                }
            }
            
            // Clear all addresses
            function clearAllAddresses() {
                if (savedAddresses.length === 0) {
                    showFeedback('N√£o h√° endere√ßos para limpar.', 'warning');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir TODOS os endere√ßos salvos?')) {
                    savedAddresses = [];
                    saveAddressesToStorage();
                    renderSavedAddresses();
                    showFeedback('Todos os endere√ßos foram exclu√≠dos!', 'success');
                }
            }
            
            // Clear all logos
            function clearAllLogos() {
                if (savedLogos.length === 0) {
                    showFeedback('N√£o h√° logos para limpar.', 'warning');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir TODOS os logos salvos?')) {
                    savedLogos = [];
                    saveLogosToStorage();
                    renderSavedLogos();
                    showFeedback('Todos os logos foram exclu√≠dos!', 'success');
                }
            }
            
            // Clear all users
            function clearAllUsers() {
                if (savedUsers.length === 0) {
                    showFeedback('N√£o h√° nomes para limpar.', 'warning');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir TODOS os nomes salvos?')) {
                    savedUsers = [];
                    saveUsersToStorage();
                    renderSavedUsers();
                    showFeedback('Todos os nomes foram exclu√≠dos!', 'success');
                }
            }
            
            // NEW: Clear all hospitals
            function clearAllHospitals() {
                if (savedHospitals.length === 0) {
                    showFeedback('N√£o h√° hospitais para limpar.', 'warning');
                    return;
                }
                
                if (confirm('Tem certeza que deseja excluir TODOS os hospitais/cl√≠nicas salvos?')) {
                    savedHospitals = [];
                    saveHospitalsToStorage();
                    renderSavedHospitals();
                    showFeedback('Todos os hospitais/cl√≠nicas foram exclu√≠dos!', 'success');
                }
            }
            
            // Set global logo
            function setGlobalLogo(logoDataURL) {
                globalLogoDataURL = logoDataURL;
                
                // Show preview
                globalLogoPreview.src = logoDataURL;
                globalLogoPreview.classList.remove('hidden');
                defaultLogoPlaceholder.classList.add('hidden');
                
                // Show remove button
                removeGlobalLogoBtn.classList.remove('hidden');
                
                // Update all cards that don't have individual logos
                for (let i = 0; i < currentLayout; i++) {
                    if (individualLogos[i] === null) {
                        updateCardLogo(i, globalLogoDataURL, false);
                    }
                }
            }
            
            // Set modal logo (for individual card)
            function setModalLogo(logoDataURL) {
                if (currentEditingCardIndex === -1) return;
                
                // Store individual logo for current card
                individualLogos[currentEditingCardIndex] = logoDataURL;
                
                // Update modal preview
                modalLogoPreview.src = logoDataURL;
                modalLogoPreview.classList.remove('hidden');
                modalDefaultLogoPlaceholder.classList.add('hidden');
                modalRemoveLogoBtn.classList.remove('hidden');
                
                // Update card logo immediately
                updateCardLogo(currentEditingCardIndex, logoDataURL, true);
            }
            
            // NEW: Copy card data and logo
            function copyCard(cardIndex) {
                if (cardIndex < 0 || cardIndex >= currentLayout) return;
                
                // Copy card data
                copiedCardData = {...cardData[cardIndex]};
                
                // Copy card logo (individual or global)
                copiedCardLogo = individualLogos[cardIndex] || globalLogoDataURL;
                
                // Set copying state
                isCopying = true;
                
                // Update UI to show which card was copied
                const cards = document.querySelectorAll('.appointment-card');
                cards.forEach((card, index) => {
                    const copyBadge = card.querySelector('.copy-badge');
                    if (index === cardIndex) {
                        copyBadge.classList.add('copied');
                        copyBadge.innerHTML = 'üìã';
                    } else {
                        copyBadge.classList.remove('copied');
                        copyBadge.innerHTML = 'üìã';
                    }
                });
                
                showFeedback(`Cart√£o ${cardIndex + 1} copiado! Clique em outro cart√£o para colar.`, 'success');
                
                // Reset copying state after 30 seconds
                setTimeout(() => {
                    if (isCopying) {
                        isCopying = false;
                        const cards = document.querySelectorAll('.appointment-card');
                        cards.forEach(card => {
                            const copyBadge = card.querySelector('.copy-badge');
                            copyBadge.classList.remove('copied');
                            copyBadge.innerHTML = 'üìã';
                        });
                        showFeedback('Modo de c√≥pia cancelado. Clique em um cart√£o para copiar novamente.', 'info');
                    }
                }, 30000);
            }
            
            // NEW: Paste card data and logo
            function pasteCard(targetCardIndex) {
                if (!isCopying || !copiedCardData) {
                    showFeedback('Nenhum cart√£o copiado. Clique no badge amarelo de um cart√£o primeiro.', 'warning');
                    return;
                }
                
                if (targetCardIndex < 0 || targetCardIndex >= currentLayout) return;
                
                // Apply copied data to target card
                cardData[targetCardIndex] = {...copiedCardData};
                
                // Apply copied logo to target card
                if (copiedCardLogo) {
                    individualLogos[targetCardIndex] = copiedCardLogo;
                }
                
                // Update the card display
                updateCardDisplay(targetCardIndex);
                
                // Update the card logo
                updateCardLogo(targetCardIndex, copiedCardLogo || globalLogoDataURL, !!copiedCardLogo);
                
                // Reset copying state
                isCopying = false;
                const cards = document.querySelectorAll('.appointment-card');
                cards.forEach(card => {
                    const copyBadge = card.querySelector('.copy-badge');
                    copyBadge.classList.remove('copied');
                    copyBadge.innerHTML = 'üìã';
                });
                
                showFeedback(`Cart√£o ${targetCardIndex + 1} atualizado com os dados copiados!`, 'success');
            }
            
            // Update paper info based on selected layout
            function updatePaperInfo() {
                const config = layoutConfigs[currentLayout];
                
                paperInfo.innerHTML = `
                    <h4>üìÑ Folha A4 - ${config.name}</h4>
                    <ul>
                        <li><strong>Layout:</strong> ${config.gridCols} coluna(s) √ó ${config.gridRows} linha(s)</li>
                        <li><strong>Tamanho do cart√£o:</strong> ${config.cardWidth}mm √ó ${config.cardHeight}mm</li>
                        <li><strong>Margens:</strong> ${config.margin}mm em todas as bordas</li>
                        ${config.gap > 0 ? `<li><strong>Espa√ßamento:</strong> ${config.gap}mm entre cart√µes</li>` : ''}
                        <li><strong>Descri√ß√£o:</strong> ${config.description}</li>
                    </ul>
                    <p><strong>Instru√ß√£o:</strong> Imprima em modo "Ajustar √† p√°gina" para melhor resultado.</p>
                `;
                
                layoutInfo.textContent = `‚ö° ${config.name} otimizados para folha A4`;
                if (currentLayout === 1) {
                    sizeInfo.textContent = `üìè Cart√£o √∫nico: ‚âà ${config.cardWidth}mm √ó ${config.cardHeight}mm`;
                } else {
                    sizeInfo.textContent = `üìè Cada cart√£o: ‚âà ${config.cardWidth}mm √ó ${config.cardHeight}mm`;
                }
            }
            
            // Format date from YYYY-MM-DD to DD/MM/YYYY
            function formatDate(dateString) {
                if (!dateString) return '';
                // Check if already in DD/MM/YYYY format
                if (dateString.includes('/')) {
                    return dateString;
                }
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }
            
            // Format date from DD/MM/YYYY to YYYY-MM-DD
            function formatDateForInput(dateString) {
                if (!dateString) return '';
                if (dateString.includes('-')) {
                    return dateString;
                }
                const [day, month, year] = dateString.split('/');
                return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
            }
            
            // Format time from HH:MM to HH:MM
            function formatTime(timeString) {
                if (!timeString) return '';
                return timeString;
            }
            
            // Truncate text based on layout
            function truncateText(text, layout) {
                const maxLengths = {
                    1: 120, // 1 card - largest
                    2: 80,  // 2 cards - larger
                    4: 60,  // 4 cards - medium
                    6: 50,  // 6 cards - compact
                    8: 40   // 8 cards - smallest
                };
                
                const maxLength = maxLengths[layout] || 50;
                
                // Don't truncate dates (they follow DD/MM/YYYY format)
                if (text.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    return text;
                }
                
                if (text.length > maxLength) {
                    return text.substring(0, maxLength - 3) + '...';
                }
                return text;
            }
            
            // Generate appointment cards based on selected layout
            function generateAppointments() {
                // Clear the grid first
                appointmentsGrid.innerHTML = '';
                
                // Update grid layout class
                const config = layoutConfigs[currentLayout];
                appointmentsGrid.className = `appointments-grid ${config.layoutClass}`;
                
                // Create cards based on current layout
                for (let i = 0; i < currentLayout; i++) {
                    const data = cardData[i];
                    const card = document.createElement('div');
                    card.className = 'appointment-card';
                    card.id = `appointment-card-${i}`;
                    card.dataset.index = i;
                    
                    // Determine which logo to show (individual or global)
                    const individualLogo = individualLogos[i];
                    const showIndividualLogo = individualLogo !== null;
                    const logoDataURL = showIndividualLogo ? individualLogo : globalLogoDataURL;
                    
                    let logoHTML = '';
                    if (logoDataURL) {
                        logoHTML = `
                            <img id="card-logo-${i}" class="card-logo" src="${logoDataURL}" alt="Logo">
                            ${showIndividualLogo ? '<div class="logo-badge">‚úì</div>' : ''}
                        `;
                    } else {
                        logoHTML = `<div id="card-default-placeholder-${i}" class="default-logo-placeholder">
                            <div class="logo-icon">üè•</div>
                            <div>Logo</div>
                            <small>Clique para adicionar</small>
                        </div>`;
                    }
                    
                    // Truncate text based on layout
                    const truncatedAddress = truncateText(data.address, currentLayout);
                    const truncatedPacient = truncateText(data.pacient, currentLayout);
                    const truncatedHospital = truncateText(data.hospital, currentLayout);
                    
                    card.innerHTML = `
                        <div class="card-number">${i + 1}</div>
                        <!-- NEW: Copy badge -->
                        <div class="copy-badge" title="Copiar este cart√£o">üìã</div>
                        <div class="card-header">
                            <div class="card-logo-container" data-card-index="${i}">
                                ${logoHTML}
                            </div>
                            <div class="hospital-name" id="card-hospital-${i}">${truncatedHospital}</div>
                        </div>
                        
                        <div class="card-title">AGENDAMENTO</div>
                        
                        <div class="appointment-details">
                            <div class="detail-row">
                                <span class="detail-label">Nome:</span>
                                <span class="detail-value" id="card-pacient-${i}">${truncatedPacient}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Cl√≠nica:</span>
                                <span class="detail-value" id="card-clinic-${i}">${truncatedHospital}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Especialidade:</span>
                                <span class="detail-value" id="card-speciality-${i}">${data.speciality}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Data:</span>
                                <span class="detail-value date-value" id="card-date-${i}">${data.date}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Hora:</span>
                                <span class="detail-value" id="card-hour-${i}">${data.hour}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Local:</span>
                                <span class="detail-value" id="card-address-${i}">${truncatedAddress}</span>
                            </div>
                        </div>
                        
                        <div class="card-footer">
                            <p>Chegar 15 min antes</p>
                        </div>
                        
                        <div class="watermark">CONSULTA</div>
                    `;
                    
                    // Add click event for editing card text
                    card.addEventListener('click', function(e) {
                        // Don't open modal if clicking on logo container or copy badge
                        if (!e.target.closest('.card-logo-container') && !e.target.closest('.copy-badge')) {
                            const index = parseInt(this.dataset.index);
                            
                            // If we're in copy mode, paste instead of opening edit modal
                            if (isCopying && index !== currentEditingCardIndex) {
                                pasteCard(index);
                            } else {
                                openEditModal(index);
                            }
                        }
                    });
                    
                    // Add click event for logo container (individual logo editing)
                    const logoContainer = card.querySelector('.card-logo-container');
                    logoContainer.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent card click from firing
                        const index = parseInt(this.dataset.cardIndex);
                        openLogoUpload(index, this);
                    });
                    
                    // Add click event for copy badge
                    const copyBadge = card.querySelector('.copy-badge');
                    copyBadge.addEventListener('click', function(e) {
                        e.stopPropagation(); // Prevent card click from firing
                        const index = parseInt(card.dataset.index);
                        copyCard(index);
                    });
                    
                    appointmentsGrid.appendChild(card);
                }
            }
            
            // Open logo upload for specific card
            function openLogoUpload(cardIndex, logoContainer) {
                // Create a file input dialog
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                fileInput.style.display = 'none';
                
                fileInput.addEventListener('change', function() {
                    if (this.files && this.files[0]) {
                        const file = this.files[0];
                        
                        // Check if file is an image
                        if (!file.type.match('image.*')) {
                            showFeedback('Por favor, selecione um arquivo de imagem (JPG, PNG, etc.)', 'error');
                            return;
                        }
                        
                        // Check file size (limit to 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showFeedback('A imagem deve ter menos de 5MB', 'error');
                            return;
                        }
                        
                        showFeedback('Carregando imagem...', 'info');
                        
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            // Store individual logo for this card
                            individualLogos[cardIndex] = e.target.result;
                            
                            // Update the card's logo
                            updateCardLogo(cardIndex, e.target.result, true);
                            showFeedback('Logo individual carregado com sucesso!', 'success');
                        };
                        
                        reader.onerror = function() {
                            showFeedback('Erro ao ler o arquivo. Por favor, tente novamente.', 'error');
                        };
                        
                        reader.readAsDataURL(file);
                    }
                    
                    // Clean up
                    document.body.removeChild(fileInput);
                });
                
                // Trigger file selection
                document.body.appendChild(fileInput);
                fileInput.click();
            }
            
            // Update specific card's logo
            function updateCardLogo(cardIndex, logoDataURL, isIndividual = true) {
                const card = document.getElementById(`appointment-card-${cardIndex}`);
                if (!card) return;
                
                const logoContainer = card.querySelector('.card-logo-container');
                if (!logoContainer) return;
                
                // Clear logo container
                logoContainer.innerHTML = '';
                
                // Add new logo
                if (logoDataURL) {
                    const img = document.createElement('img');
                    img.className = 'card-logo';
                    img.src = logoDataURL;
                    img.alt = 'Logo';
                    logoContainer.appendChild(img);
                    
                    // Add badge if it's an individual logo
                    if (isIndividual) {
                        const badge = document.createElement('div');
                        badge.className = 'logo-badge';
                        badge.textContent = '‚úì';
                        logoContainer.appendChild(badge);
                    }
                } else {
                    // Add default placeholder
                    const placeholder = document.createElement('div');
                    placeholder.className = 'default-logo-placeholder';
                    placeholder.innerHTML = `
                        <div class="logo-icon">üè•</div>
                        <div>Logo</div>
                        <small>Clique para adicionar</small>
                    `;
                    logoContainer.appendChild(placeholder);
                    
                    // Add click event to placeholder
                    placeholder.addEventListener('click', function(e) {
                        e.stopPropagation();
                        openLogoUpload(cardIndex, logoContainer);
                    });
                }
                
                // Re-add click event to logo container
                logoContainer.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openLogoUpload(cardIndex, this);
                });
            }
            
            // Open edit modal
            function openEditModal(index) {
                currentEditingCardIndex = index;
                const data = cardData[index];
                
                // Remove editing class from all cards
                document.querySelectorAll('.appointment-card').forEach(card => {
                    card.classList.remove('editing');
                });
                
                // Add editing class to current card
                const currentCard = document.getElementById(`appointment-card-${index}`);
                if (currentCard) {
                    currentCard.classList.add('editing');
                }
                
                // Update modal with current data
                modalCardNumberSpan.textContent = index + 1;
                modalPacientInput.value = data.pacient;
                modalHospitalInput.value = data.hospital;
                modalSpecialityInput.value = data.speciality;
                modalDateInput.value = formatDateForInput(data.date);
                modalHourInput.value = data.hour;
                modalAddressInput.value = data.address;
                
                // Update modal logo preview
                const individualLogo = individualLogos[index];
                if (individualLogo) {
                    modalLogoPreview.src = individualLogo;
                    modalLogoPreview.classList.remove('hidden');
                    modalDefaultLogoPlaceholder.classList.add('hidden');
                    modalRemoveLogoBtn.classList.remove('hidden');
                } else {
                    modalLogoPreview.classList.add('hidden');
                    modalDefaultLogoPlaceholder.classList.remove('hidden');
                    modalRemoveLogoBtn.classList.add('hidden');
                }
                
                // Render saved addresses in modal
                renderSavedAddresses(modalSavedAddressesContainer, (address) => {
                    modalAddressInput.value = address;
                    hideAutocomplete(modalAddressAutocomplete);
                });
                
                // Render saved logos in modal
                renderSavedLogos(modalSavedLogosContainer, (logoDataURL) => {
                    setModalLogo(logoDataURL);
                });
                
                // Render saved users in modal
                renderSavedUsers(modalSavedUsersContainer, (user) => {
                    modalPacientInput.value = user;
                    hideAutocomplete(modalUserAutocomplete);
                });
                
                // Render saved hospitals in modal
                renderSavedHospitals(modalSavedHospitalsContainer, (hospitalName) => {
                    modalHospitalInput.value = hospitalName;
                    hideAutocomplete(modalHospitalAutocomplete);
                });
                
                // Clear any previous errors
                clearError(modalPacientInput, modalPacientError);
                clearError(modalHospitalInput, modalHospitalError);
                clearError(modalAddressInput, modalAddressError);
                clearError(modalDateInput, modalDateError);
                clearError(modalHourInput, modalHourError);
                
                // Show modal
                modalOverlay.style.display = 'flex';
                
                // Focus on first input
                setTimeout(() => {
                    modalPacientInput.focus();
                }, 100);
                
                // Add ESC key listener
                document.addEventListener('keydown', handleEscKey);
                // Add Enter key listeners to all modal fields
                setupModalEnterKeyListeners();
            }
            
            // Setup Enter key listeners for modal fields
            function setupModalEnterKeyListeners() {
                // Remove existing listeners first
                removeModalEnterKeyListeners();
                
                // Add Enter key listener to each input field
                const modalInputs = [
                    modalPacientInput,
                    modalHospitalInput,
                    modalSpecialityInput,
                    modalDateInput,
                    modalHourInput,
                    modalAddressInput
                ];
                
                modalInputs.forEach(input => {
                    input.addEventListener('keydown', handleModalInputEnterKey);
                });
            }
            
            // Remove Enter key listeners
            function removeModalEnterKeyListeners() {
                const modalInputs = [
                    modalPacientInput,
                    modalHospitalInput,
                    modalSpecialityInput,
                    modalDateInput,
                    modalHourInput,
                    modalAddressInput
                ];
                
                modalInputs.forEach(input => {
                    input.removeEventListener('keydown', handleModalInputEnterKey);
                });
            }
            
            // Handle Enter key in modal input fields
            function handleModalInputEnterKey(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    saveCardChanges();
                }
            }
            
            // Handle ESC key press
            function handleEscKey(event) {
                if (event.key === 'Escape' || event.key === 'Esc') {
                    closeEditModal();
                }
            }
            
            // Save changes from modal
            function saveCardChanges() {
                if (currentEditingCardIndex === -1) return;
                
                // Validate form before saving
                if (!validateModalForm()) {
                    showFeedback('Por favor, corrija os erros no formul√°rio antes de salvar.', 'error');
                    return;
                }
                
                // Update card data
                cardData[currentEditingCardIndex] = {
                    pacient: FirstOneUpperCase(modalPacientInput.value) || "N√£o informado",
                    hospital: FirstOneUpperCase(modalHospitalInput.value) || "N√£o informado",
                    speciality: modalSpecialityInput.value || "N√£o informado",
                    date: formatDate(modalDateInput.value) || "N√£o informado",
                    hour: modalHourInput.value || "N√£o informado",
                    address: FirstOneUpperCase(modalAddressInput.value) || "N√£o informado"
                };
                
                // Update the specific card
                updateCardDisplay(currentEditingCardIndex);
                
                // Close modal
                closeEditModal();
                
                // Show feedback
                showFeedback(`Cart√£o ${currentEditingCardIndex + 1} atualizado com sucesso!`, 'success');
            }
            
            // Update specific card display
            function updateCardDisplay(index) {
                const data = cardData[index];
                const card = document.getElementById(`appointment-card-${index}`);
                
                if (card) {
                    // Truncate text based on layout
                    const truncatedAddress = truncateText(data.address, currentLayout);
                    const truncatedPacient = truncateText(data.pacient, currentLayout);
                    const truncatedHospital = truncateText(data.hospital, currentLayout);
                    
                    // Update card content
                    document.getElementById(`card-pacient-${index}`).textContent = truncatedPacient;
                    document.getElementById(`card-hospital-${index}`).textContent = truncatedHospital;
                    document.getElementById(`card-clinic-${index}`).textContent = truncatedHospital;
                    document.getElementById(`card-speciality-${index}`).textContent = data.speciality;
                    document.getElementById(`card-date-${index}`).textContent = data.date;
                    document.getElementById(`card-hour-${index}`).textContent = data.hour;
                    document.getElementById(`card-address-${index}`).textContent = truncatedAddress;
                }
            }
            
            // Close edit modal
            function closeEditModal() {
                modalOverlay.style.display = 'none';
                currentEditingCardIndex = -1;
                
                // Remove editing class from all cards
                document.querySelectorAll('.appointment-card').forEach(card => {
                    card.classList.remove('editing');
                });
                
                // Remove ESC key listener
                document.removeEventListener('keydown', handleEscKey);
                // Remove Enter key listeners
                removeModalEnterKeyListeners();
            }
            
            // Apply settings to all cards
            function applyToAllCards() {
                const pacient = FirstOneUpperCase(globalPacientInput.value) || "Alex Silva";
                const hospital = FirstOneUpperCase(globalHospitalInput.value) || "Santa B√°rbara";
                const speciality = globalSpecialityInput.value || "otorrinolaringologista";
                const address = FirstOneUpperCase(globalAddressInput.value) || "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA";
                
                // Get date and time values with validation
                let date = formatDate(globalDateInput.value) || "23/01/2026";
                let hour = formatTime(globalHourInput.value) || "08:00";
                
                // Validate date if provided
                if (globalDateInput.value) {
                    const dateValidation = validateDate(globalDateInput.value);
                    if (!dateValidation.isValid) {
                        showError(globalDateInput, globalDateError, dateValidation.message);
                        showFeedback('Erro na data padr√£o. Por favor, corrija antes de aplicar.', 'error');
                        return;
                    } else {
                        clearError(globalDateInput, globalDateError);
                    }
                }
                
                // Validate time if provided
                if (globalHourInput.value) {
                    const timeValidation = validateTime(globalHourInput.value);
                    if (!timeValidation.isValid) {
                        showError(globalHourInput, globalHourError, timeValidation.message);
                        showFeedback('Erro no hor√°rio padr√£o. Por favor, corrija antes de aplicar.', 'error');
                        return;
                    } else {
                        clearError(globalHourInput, globalHourError);
                    }
                }
                
                // Update all card data including date and time
                for (let i = 0; i < currentLayout; i++) {
                    cardData[i].pacient = pacient;
                    cardData[i].hospital = hospital;
                    cardData[i].speciality = speciality;
                    cardData[i].address = address;
                    cardData[i].date = date;
                    cardData[i].hour = hour;
                }
                
                // Regenerate all cards
                generateAppointments();
                
                // Show feedback
                showFeedback(`Configura√ß√µes aplicadas a ${currentLayout} cart√£o(s)!`, 'success');
            }
            
            // Reset all cards to default
            function resetAllCards() {
                if (confirm('Tem certeza que deseja redefinir TODOS os cart√µes para os valores padr√£o?')) {
                    // Reset global inputs
                    globalPacientInput.value = "Alex Silva";
                    globalHospitalInput.value = "Santa B√°rbara";
                    globalSpecialityInput.value = "otorrinolaringologista";
                    globalAddressInput.value = "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA";
                    
                    // Reset date and time
                    globalDateInput.value = "2026-01-23";
                    globalHourInput.value = "08:00";
                    
                    // Clear any errors
                    clearError(globalDateInput, globalDateError);
                    clearError(globalHourInput, globalHourError);
                    
                    // Reset global logo
                    globalLogoDataURL = null;
                    globalLogoPreview.src = '';
                    globalLogoPreview.classList.add('hidden');
                    defaultLogoPlaceholder.classList.remove('hidden');
                    removeGlobalLogoBtn.classList.add('hidden');
                    globalLogoUploadInput.value = '';
                    
                    // Reset card data
                    for (let i = 0; i < 8; i++) {
                        cardData[i] = {...defaultCardData};
                        individualLogos[i] = null;
                    }
                    
                    // Reset copy/paste state
                    isCopying = false;
                    copiedCardData = null;
                    copiedCardLogo = null;
                    
                    // Regenerate all cards
                    generateAppointments();
                    
                    // Show feedback
                    showFeedback('Todos os cart√µes foram redefinidos para os valores padr√£o!', 'success');
                }
            }
            
            // Handle global logo upload
            globalUploadBtn.addEventListener('click', () => {
                globalLogoUploadInput.click();
            });
            
            globalLogoUploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Check if file is an image
                    if (!file.type.match('image.*')) {
                        showFeedback('Por favor, selecione um arquivo de imagem (JPG, PNG, etc.)', 'error');
                        return;
                    }
                    
                    // Check file size (limit to 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showFeedback('A imagem deve ter menos de 5MB', 'error');
                        return;
                    }
                    
                    showFeedback('Carregando imagem...', 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        setGlobalLogo(e.target.result);
                        showFeedback('Logo padr√£o carregado com sucesso!', 'success');
                    };
                    
                    reader.onerror = function() {
                        showFeedback('Erro ao ler o arquivo. Por favor, tente novamente.', 'error');
                    };
                    
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle save global logo
            saveGlobalLogoBtn.addEventListener('click', function() {
                if (globalLogoDataURL) {
                    openSaveLogoModal(globalLogoDataURL, 'global');
                } else {
                    showFeedback('Por favor, carregue um logo primeiro para poder salv√°-lo.', 'warning');
                }
            });
            
            // Handle global logo removal
            removeGlobalLogoBtn.addEventListener('click', function() {
                globalLogoDataURL = null;
                
                // Hide preview and show default placeholder
                globalLogoPreview.classList.add('hidden');
                defaultLogoPlaceholder.classList.remove('hidden');
                
                // Hide remove button
                removeGlobalLogoBtn.classList.add('hidden');
                
                // Reset file input
                globalLogoUploadInput.value = '';
                
                // Update all cards that don't have individual logos
                for (let i = 0; i < currentLayout; i++) {
                    if (individualLogos[i] === null) {
                        updateCardLogo(i, null, false);
                    }
                }
                
                showFeedback('Logo padr√£o removido!', 'success');
            });
            
            // Handle modal logo upload
            modalUploadLogoBtn.addEventListener('click', () => {
                modalLogoUploadInput.click();
            });
            
            modalLogoUploadInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Check if file is an image
                    if (!file.type.match('image.*')) {
                        showFeedback('Por favor, selecione um arquivo de imagem (JPG, PNG, etc.)', 'error');
                        return;
                    }
                    
                    // Check file size (limit to 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showFeedback('A imagem deve ter menos de 5MB', 'error');
                        return;
                    }
                    
                    showFeedback('Carregando imagem...', 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const logoDataURL = e.target.result;
                        setModalLogo(logoDataURL);
                        showFeedback('Logo individual carregado com sucesso!', 'success');
                    };
                    
                    reader.onerror = function() {
                        showFeedback('Erro ao ler o arquivo. Por favor, tente novamente.', 'error');
                    };
                    
                    reader.readAsDataURL(file);
                    
                    // Reset file input
                    this.value = '';
                }
            });
            
            // Handle save modal logo
            saveModalLogoBtn.addEventListener('click', function() {
                if (currentEditingCardIndex !== -1 && individualLogos[currentEditingCardIndex]) {
                    openSaveLogoModal(individualLogos[currentEditingCardIndex], 'modal');
                } else {
                    showFeedback('Por favor, carregue um logo primeiro para poder salv√°-lo.', 'warning');
                }
            });
            
            // Handle modal logo removal
            modalRemoveLogoBtn.addEventListener('click', function() {
                // Remove individual logo
                individualLogos[currentEditingCardIndex] = null;
                
                // Update modal preview
                modalLogoPreview.classList.add('hidden');
                modalDefaultLogoPlaceholder.classList.remove('hidden');
                modalRemoveLogoBtn.classList.add('hidden');
                
                // Update card logo (use global logo if available)
                updateCardLogo(currentEditingCardIndex, globalLogoDataURL, false);
                
                showFeedback('Logo individual removido!', 'success');
            });
            
            // Handle use global logo button
            modalUseGlobalLogoBtn.addEventListener('click', function() {
                if (globalLogoDataURL) {
                    // Remove individual logo
                    individualLogos[currentEditingCardIndex] = null;
                    
                    // Update modal preview
                    modalLogoPreview.classList.add('hidden');
                    modalDefaultLogoPlaceholder.classList.remove('hidden');
                    modalRemoveLogoBtn.classList.add('hidden');
                    
                    // Update card logo
                    updateCardLogo(currentEditingCardIndex, globalLogoDataURL, false);
                    
                    showFeedback('Usando logo padr√£o para este cart√£o!', 'success');
                } else {
                    showFeedback('Nenhum logo padr√£o definido. Por favor, fa√ßa upload de um logo padr√£o primeiro.', 'warning');
                }
            });
            
            // Handle layout selection
            layoutOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const layout = parseInt(this.dataset.layout);
                    
                    // Update selected layout
                    currentLayout = layout;
                    
                    // Update UI
                    layoutOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Update paper info
                    updatePaperInfo();
                    
                    // Regenerate appointments
                    generateAppointments();
                    
                    // Show feedback
                    showFeedback(`Layout alterado para ${layoutConfigs[layout].name}`, 'info');
                });
            });
            
            // Event listeners for address autocomplete
            globalAddressInput.addEventListener('input', function() {
                showAddressAutocompleteSuggestions(this, globalAddressAutocomplete, savedAddresses);
            });
            
            globalAddressInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showAddressAutocompleteSuggestions(this, globalAddressAutocomplete, savedAddresses);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!globalAddressInput.contains(e.target) && !globalAddressAutocomplete.contains(e.target)) {
                    hideAutocomplete(globalAddressAutocomplete);
                }
            });
            
            modalAddressInput.addEventListener('input', function() {
                showAddressAutocompleteSuggestions(this, modalAddressAutocomplete, savedAddresses);
            });
            
            modalAddressInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showAddressAutocompleteSuggestions(this, modalAddressAutocomplete, savedAddresses);
                }
            });
            
            // Event listeners for user autocomplete
            globalPacientInput.addEventListener('input', function() {
                showUserAutocompleteSuggestions(this, globalUserAutocomplete, savedUsers);
            });
            
            globalPacientInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showUserAutocompleteSuggestions(this, globalUserAutocomplete, savedUsers);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!globalPacientInput.contains(e.target) && !globalUserAutocomplete.contains(e.target)) {
                    hideAutocomplete(globalUserAutocomplete);
                }
            });
            
            modalPacientInput.addEventListener('input', function() {
                showUserAutocompleteSuggestions(this, modalUserAutocomplete, savedUsers);
            });
            
            modalPacientInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showUserAutocompleteSuggestions(this, modalUserAutocomplete, savedUsers);
                }
            });
            
            // Event listeners for hospital autocomplete
            globalHospitalInput.addEventListener('input', function() {
                showHospitalAutocompleteSuggestions(this, globalHospitalAutocomplete, savedHospitals);
            });
            
            globalHospitalInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showHospitalAutocompleteSuggestions(this, globalHospitalAutocomplete, savedHospitals);
                }
            });
            
            document.addEventListener('click', function(e) {
                if (!globalHospitalInput.contains(e.target) && !globalHospitalAutocomplete.contains(e.target)) {
                    hideAutocomplete(globalHospitalAutocomplete);
                }
            });
            
            modalHospitalInput.addEventListener('input', function() {
                showHospitalAutocompleteSuggestions(this, modalHospitalAutocomplete, savedHospitals);
            });
            
            modalHospitalInput.addEventListener('focus', function() {
                if (this.value.length >= 2) {
                    showHospitalAutocompleteSuggestions(this, modalHospitalAutocomplete, savedHospitals);
                }
            });
            
            // Event listeners for logo autocomplete (search functionality)
            document.addEventListener('click', function(e) {
                // Show logo autocomplete when clicking on logo containers
                if (e.target.closest('.logo-preview-container') || e.target.closest('.default-logo-placeholder')) {
                    const container = e.target.closest('.logo-upload') ? globalLogoAutocomplete : modalLogoAutocomplete;
                    showLogoAutocompleteSuggestions(null, container, savedLogos);
                }
            });
            
            // Event listeners for save address buttons
            saveGlobalAddressBtn.addEventListener('click', function() {
                const address = globalAddressInput.value.trim();
                if (address) {
                    openSaveAddressModal(address, 'global');
                } else {
                    showFeedback('Por favor, digite um endere√ßo para salvar.', 'warning');
                }
            });
            
            saveModalAddressBtn.addEventListener('click', function() {
                const address = modalAddressInput.value.trim();
                if (address) {
                    openSaveAddressModal(address, 'modal');
                } else {
                    showFeedback('Por favor, digite um endere√ßo para salvar.', 'warning');
                }
            });
            
            // Event listeners for save user buttons
            saveGlobalUserBtn.addEventListener('click', function() {
                const user = globalPacientInput.value.trim();
                if (user) {
                    openSaveUserModal(user, 'global');
                } else {
                    showFeedback('Por favor, digite um nome para salvar.', 'warning');
                }
            });
            
            saveModalUserBtn.addEventListener('click', function() {
                const user = modalPacientInput.value.trim();
                if (user) {
                    openSaveUserModal(user, 'modal');
                } else {
                    showFeedback('Por favor, digite um nome para salvar.', 'warning');
                }
            });
            
            // NEW: Event listeners for save hospital buttons
            saveGlobalHospitalBtn.addEventListener('click', function() {
                const hospital = globalHospitalInput.value.trim();
                if (hospital) {
                    openSaveHospitalModal(hospital, 'global');
                } else {
                    showFeedback('Por favor, digite um nome de hospital/cl√≠nica para salvar.', 'warning');
                }
            });
            
            saveModalHospitalBtn.addEventListener('click', function() {
                const hospital = modalHospitalInput.value.trim();
                if (hospital) {
                    openSaveHospitalModal(hospital, 'modal');
                } else {
                    showFeedback('Por favor, digite um nome de hospital/cl√≠nica para salvar.', 'warning');
                }
            });
            
            // Event listeners for save patient buttons
            saveGlobalPacientBtn.addEventListener('click', function() {
                const user = globalPacientInput.value.trim();
                if (user) {
                    openSaveUserModal(user, 'global');
                } else {
                    showFeedback('Por favor, digite um nome para salvar.', 'warning');
                }
            });
            
            saveModalPacientBtn.addEventListener('click', function() {
                const user = modalPacientInput.value.trim();
                if (user) {
                    openSaveUserModal(user, 'modal');
                } else {
                    showFeedback('Por favor, digite um nome para salvar.', 'warning');
                }
            });
            
            // Event listeners for save address field buttons
            saveGlobalAddressFieldBtn.addEventListener('click', function() {
                const address = globalAddressInput.value.trim();
                if (address) {
                    openSaveAddressModal(address, 'global');
                } else {
                    showFeedback('Por favor, digite um endere√ßo para salvar.', 'warning');
                }
            });
            
            saveModalAddressFieldBtn.addEventListener('click', function() {
                const address = modalAddressInput.value.trim();
                if (address) {
                    openSaveAddressModal(address, 'modal');
                } else {
                    showFeedback('Por favor, digite um endere√ßo para salvar.', 'warning');
                }
            });
            
            // NEW: Event listeners for global date and time changes with validation
            globalDateInput.addEventListener('change', function() {
                if (this.value) {
                    const dateValidation = validateDate(this.value);
                    if (!dateValidation.isValid) {
                        showError(this, globalDateError, dateValidation.message);
                        return;
                    } else {
                        clearError(this, globalDateError);
                        const formattedDate = formatDate(this.value);
                        for (let i = 0; i < currentLayout; i++) {
                            cardData[i].date = formattedDate;
                            updateCardDisplay(i);
                        }
                        showFeedback(`Data atualizada para todos os cart√µes: ${formattedDate}`, 'info');
                    }
                } else {
                    clearError(this, globalDateError);
                }
            });
            
            globalHourInput.addEventListener('change', function() {
                if (this.value) {
                    const timeValidation = validateTime(this.value);
                    if (!timeValidation.isValid) {
                        showError(this, globalHourError, timeValidation.message);
                        return;
                    } else {
                        clearError(this, globalHourError);
                        const formattedTime = formatTime(this.value);
                        for (let i = 0; i < currentLayout; i++) {
                            cardData[i].hour = formattedTime;
                            updateCardDisplay(i);
                        }
                        showFeedback(`Hor√°rio atualizado para todos os cart√µes: ${formattedTime}`, 'info');
                    }
                } else {
                    clearError(this, globalHourError);
                }
            });
            
            // Event listeners for save address modal
            saveAddressConfirmBtn.addEventListener('click', function() {
                const name = addressNameInput.value.trim();
                const address = addressValueInput.value.trim();
                saveNewAddress(name, address);
            });
            
            saveAddressCancelBtn.addEventListener('click', closeSaveAddressModal);
            saveAddressModalCloseBtn.addEventListener('click', closeSaveAddressModal);
            
            // Event listeners for save logo modal
            saveLogoConfirmBtn.addEventListener('click', function() {
                const name = logoNameInput.value.trim();
                saveNewLogo(name, logoToSave);
            });
            
            saveLogoCancelBtn.addEventListener('click', closeSaveLogoModal);
            saveLogoModalCloseBtn.addEventListener('click', closeSaveLogoModal);
            
            // Event listeners for save user modal
            saveUserConfirmBtn.addEventListener('click', function() {
                const name = userNameInput.value.trim();
                const fullName = userValueInput.value.trim();
                saveNewUser(name, fullName);
            });
            
            saveUserCancelBtn.addEventListener('click', closeSaveUserModal);
            saveUserModalCloseBtn.addEventListener('click', closeSaveUserModal);
            
            // NEW: Event listeners for save hospital modal
            saveHospitalConfirmBtn.addEventListener('click', function() {
                const name = hospitalNameInput.value.trim();
                const hospitalName = hospitalValueInput.value.trim();
                saveNewHospital(name, hospitalName);
            });
            
            saveHospitalCancelBtn.addEventListener('click', closeSaveHospitalModal);
            saveHospitalModalCloseBtn.addEventListener('click', closeSaveHospitalModal);
            
            // =============================================
            // FIXED MODAL BEHAVIOR: CLICK OUTSIDE WON'T CLOSE
            // =============================================
            
            // Prevent ALL modals from closing when clicking outside
            modalOverlay.addEventListener('click', function(e) {
                // Don't close when clicking on overlay
                e.stopPropagation();
            });
            
            saveAddressModalOverlay.addEventListener('click', function(e) {
                // Don't close when clicking on overlay
                e.stopPropagation();
            });
            
            saveLogoModalOverlay.addEventListener('click', function(e) {
                // Don't close when clicking on overlay
                e.stopPropagation();
            });
            
            saveUserModalOverlay.addEventListener('click', function(e) {
                // Don't close when clicking on overlay
                e.stopPropagation();
            });
            
            saveHospitalModalOverlay.addEventListener('click', function(e) {
                // Don't close when clicking on overlay
                e.stopPropagation();
            });
            
            // Prevent modal content clicks from bubbling to overlay
            modalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            saveAddressModalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            saveLogoModalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            saveUserModalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            saveHospitalModalContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // =============================================
            // END OF FIXED MODAL BEHAVIOR
            // =============================================
            
            // Clear all addresses button
            clearGlobalAddressesBtn.addEventListener('click', clearAllAddresses);
            
            // Clear all logos button
            clearGlobalLogosBtn.addEventListener('click', clearAllLogos);
            
            // Clear all users button
            clearGlobalUsersBtn.addEventListener('click', clearAllUsers);
            
            // Clear all hospitals button
            clearGlobalHospitalsBtn.addEventListener('click', clearAllHospitals);
            
            // Generate PDF for printing
            downloadPdfBtn.addEventListener('click', function() {
                const paperSheet = document.querySelector('.paper-sheet');
                
                // Close any open modal first
                closeEditModal();
                closeSaveAddressModal();
                closeSaveLogoModal();
                closeSaveUserModal();
                closeSaveHospitalModal();
                
                // Show loading feedback
                showFeedback('Gerando PDF... Aguarde!', 'info');
                setButtonLoading(this, true);
                
                // Temporarily hide card numbers and badges for PDF
                const cardNumbers = document.querySelectorAll('.card-number');
                const logoBadges = document.querySelectorAll('.logo-badge');
                const copyBadges = document.querySelectorAll('.copy-badge');
                const originalDisplayNumbers = [];
                const originalDisplayBadges = [];
                const originalDisplayCopyBadges = [];
                
                cardNumbers.forEach((number, index) => {
                    originalDisplayNumbers[index] = number.style.display;
                    number.style.display = 'none';
                });
                
                logoBadges.forEach((badge, index) => {
                    originalDisplayBadges[index] = badge.style.display;
                    badge.style.display = 'none';
                });
                
                copyBadges.forEach((badge, index) => {
                    originalDisplayCopyBadges[index] = badge.style.display;
                    badge.style.display = 'none';
                });
                
                html2canvas(paperSheet, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: paperSheet.offsetWidth,
                    height: paperSheet.offsetHeight
                }).then(canvas => {
                    // Restore displays
                    cardNumbers.forEach((number, index) => {
                        number.style.display = originalDisplayNumbers[index];
                    });
                    
                    logoBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayBadges[index];
                    });
                    
                    copyBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayCopyBadges[index];
                    });
                    
                    // Create PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Convert canvas to image data
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Calculate dimensions to fit A4
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // Add image to PDF
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    
                    // Download PDF
                    pdf.save(`${currentLayout}-agendamentos-medicos-a4.pdf`);
                    
                    // Show success feedback
                    showFeedback('PDF gerado com sucesso! Download iniciado.', 'success');
                    
                    // Reset button
                    setButtonLoading(this, false);
                    
                }).catch(error => {
                    // Restore displays
                    cardNumbers.forEach((number, index) => {
                        number.style.display = originalDisplayNumbers[index];
                    });
                    
                    logoBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayBadges[index];
                    });
                    
                    copyBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayCopyBadges[index];
                    });
                    
                    console.error('Error generating PDF:', error);
                    showFeedback('Erro ao gerar PDF. Tente novamente.', 'error');
                    setButtonLoading(this, false);
                });
            });
            
            // Generate and download page as image
            downloadImageBtn.addEventListener('click', function() {
                const paperSheet = document.querySelector('.paper-sheet');
                
                // Close any open modal first
                closeEditModal();
                closeSaveAddressModal();
                closeSaveLogoModal();
                closeSaveUserModal();
                closeSaveHospitalModal();
                
                // Show loading feedback
                showFeedback('Gerando imagem... Aguarde!', 'info');
                setButtonLoading(this, true);
                
                // Temporarily hide card numbers and badges for image
                const cardNumbers = document.querySelectorAll('.card-number');
                const logoBadges = document.querySelectorAll('.logo-badge');
                const copyBadges = document.querySelectorAll('.copy-badge');
                const originalDisplayNumbers = [];
                const originalDisplayBadges = [];
                const originalDisplayCopyBadges = [];
                
                cardNumbers.forEach((number, index) => {
                    originalDisplayNumbers[index] = number.style.display;
                    number.style.display = 'none';
                });
                
                logoBadges.forEach((badge, index) => {
                    originalDisplayBadges[index] = badge.style.display;
                    badge.style.display = 'none';
                });
                
                copyBadges.forEach((badge, index) => {
                    originalDisplayCopyBadges[index] = badge.style.display;
                    badge.style.display = 'none';
                });
                
                html2canvas(paperSheet, {
                    scale: 2,
                    backgroundColor: '#ffffff',
                    logging: false,
                    useCORS: true,
                    allowTaint: true,
                    width: paperSheet.offsetWidth,
                    height: paperSheet.offsetHeight
                }).then(canvas => {
                    // Restore displays
                    cardNumbers.forEach((number, index) => {
                        number.style.display = originalDisplayNumbers[index];
                    });
                    
                    logoBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayBadges[index];
                    });
                    
                    copyBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayCopyBadges[index];
                    });
                    
                    const link = document.createElement('a');
                    link.download = `${currentLayout}-agendamentos-medicos-a4.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    
                    // Show success feedback
                    showFeedback('Imagem gerada com sucesso! Download iniciado.', 'success');
                    
                    // Reset button
                    setButtonLoading(this, false);
                    
                }).catch(error => {
                    // Restore displays
                    cardNumbers.forEach((number, index) => {
                        number.style.display = originalDisplayNumbers[index];
                    });
                    
                    logoBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayBadges[index];
                    });
                    
                    copyBadges.forEach((badge, index) => {
                        badge.style.display = originalDisplayCopyBadges[index];
                    });
                    
                    console.error('Error generating image:', error);
                    showFeedback('Erro ao gerar imagem. Tente novamente.', 'error');
                    setButtonLoading(this, false);
                });
            });
            
            // Print page
            printBtn.addEventListener('click', function() {
                // Close any open modal first
                closeEditModal();
                closeSaveAddressModal();
                closeSaveLogoModal();
                closeSaveUserModal();
                closeSaveHospitalModal();
                
                // Show feedback
                showFeedback('Preparando para impress√£o...', 'info');
                
                // Print the paper sheet
                const printContent = document.querySelector('.paper-sheet').outerHTML;
                const originalContent = document.body.innerHTML;
                
                document.body.innerHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Imprimir ${currentLayout} Agendamentos M√©dicos - A4</title>
                        <style>
                            body { 
                                margin: 0;
                                padding: 0;
                                font-family: Arial, sans-serif;
                            }
                            .paper-sheet {
                                width: 210mm;
                                height: 297mm;
                                background-color: white;
                                margin: 0;
                                padding: 15mm;
                                box-sizing: border-box;
                            }
                            .appointments-grid {
                                display: grid;
                                width: 100%;
                                height: 100%;
                            }
                            .appointment-card {
                                background-color: white;
                                border: 1px solid #000;
                                border-radius: 3mm;
                                padding: 3mm;
                                position: relative;
                                overflow: hidden;
                                page-break-inside: avoid;
                                break-inside: avoid;
                                box-sizing: border-box;
                            }
                            .card-logo {
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain;
                            }
                            .default-logo-placeholder {
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                color: #666;
                                font-style: italic;
                                border: 1px dashed #ccc;
                                border-radius: 2mm;
                                padding: 2mm;
                                text-align: center;
                            }
                            @media print {
                                .appointment-card {
                                    border: 1px solid #000 !important;
                                    box-shadow: none !important;
                                }
                                .card-number, .logo-badge, .copy-badge {
                                    display: none;
                                }
                            }
                        </style>
                    </head>
                    <body>${printContent}</body>
                    </html>
                `;
                
                window.print();
                document.body.innerHTML = originalContent;
                generateAppointments();
                
                showFeedback('Impress√£o configurada! Verifique a impressora.', 'success');
            });
            
            // Event listeners
            applyAllBtn.addEventListener('click', applyToAllCards);
            resetAllBtn.addEventListener('click', resetAllCards);
            modalSaveBtn.addEventListener('click', saveCardChanges);
            modalCancelBtn.addEventListener('click', closeEditModal);
            modalCloseBtn.addEventListener('click', closeEditModal);
            
            // Initialize on page load
            window.addEventListener('DOMContentLoaded', function() {
                // Load saved addresses, logos, and users
                loadSavedAddresses();
                loadSavedLogos();
                loadSavedUsers();
                loadSavedHospitals(); // NEW: Load hospitals
                
                // Initialize all cards with default data
                for (let i = 0; i < 8; i++) {
                    cardData[i] = {...defaultCardData};
                    individualLogos[i] = null;
                }
                
                // Initialize paper info
                updatePaperInfo();
                
                // Render saved addresses in global container
                renderSavedAddresses(globalSavedAddressesContainer, (address) => {
                    globalAddressInput.value = address;
                    hideAutocomplete(globalAddressAutocomplete);
                });
                
                // Render saved logos in global container
                renderSavedLogos(globalSavedLogosContainer, (logoDataURL) => {
                    setGlobalLogo(logoDataURL);
                });
                
                // Render saved users in global container
                renderSavedUsers(globalSavedUsersContainer, (user) => {
                    globalPacientInput.value = user;
                    hideAutocomplete(globalUserAutocomplete);
                });
                
                // Render saved hospitals in global container
                renderSavedHospitals(globalSavedHospitalsContainer, (hospitalName) => {
                    globalHospitalInput.value = hospitalName;
                    hideAutocomplete(globalHospitalAutocomplete);
                });
                
                // Generate initial appointments
                generateAppointments();
                
                // Add Enter key listener for global patient input
                globalPacientInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyToAllCards();
                    }
                });
                
                // Add Enter key listener for global hospital input
                globalHospitalInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyToAllCards();
                    }
                });
                
                // Add Enter key listener for global address input
                globalAddressInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyToAllCards();
                    }
                });
            });
        </script>
    </body>
</html>