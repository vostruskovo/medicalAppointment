<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Appointment Generator - Saved Logos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f0f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        header {
            text-align: center;
            padding: 20px;
            background-color: #1a5f7a;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .language-selector {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .language-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .language-options {
            position: absolute;
            top: 100%;
            right: 0;
            background: gray;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 1001;
            display: none;
            min-width: 150px;
            margin-top: 5px;
        }
        
        .language-option {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }
        
        .language-option:hover {
            /*background-color: #f0f7ff;*/
        }
        
        .language-option.selected {
            /*background-color: #e8f4fc;*/
            font-weight: bold;
        }
        
        .language-flag {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .control-panel {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        
        .preview-section {
            flex: 2;
            min-width: 300px;
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 1.4rem;
            color: #1a5f7a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f0ff;
        }
        
        .form-group {
            margin-bottom: 20px;
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #1a5f7a;
            outline: none;
        }
        
        .address-autocomplete, .logo-autocomplete, .user-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 6px 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .address-suggestion, .logo-suggestion, .user-suggestion {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
        }
        
        .address-suggestion:hover, .logo-suggestion:hover, .user-suggestion:hover {
            background-color: #f0f7ff;
        }
        
        .address-suggestion:last-child, .logo-suggestion:last-child, .user-suggestion:last-child {
            border-bottom: none;
        }
        
        .address-suggestion .address-name,
        .logo-suggestion .logo-name,
        .user-suggestion .user-name {
            font-weight: 600;
            color: #1a5f7a;
            margin-bottom: 3px;
        }
        
        .address-suggestion .address-value,
        .user-suggestion .user-value {
            font-size: 0.9rem;
            color: #666;
        }
        
        .logo-suggestion .logo-preview-img {
            width: 40px;
            height: 40px;
            object-fit: contain;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
            background-color: white;
        }
        
        .logo-suggestion .logo-info,
        .user-suggestion .user-info {
            flex: 1;
        }
        
        .save-address-btn, .save-logo-btn, .save-user-btn {
            position: absolute;
            right: 10px;
            top: 40px;
            background: none;
            border: none;
            color: #1a5f7a;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        
        .save-address-btn:hover, .save-logo-btn:hover, .save-user-btn:hover {
            background-color: #f0f7ff;
        }
        
        .saved-addresses-container, .saved-logos-container, .saved-users-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .saved-addresses-title, .saved-logos-title, .saved-users-title {
            font-size: 1rem;
            color: #1a5f7a;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .saved-address-item, .saved-logo-item, .saved-user-item {
            background: white;
            border: 1px solid #e0f0ff;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        
        .saved-address-item:hover, .saved-logo-item:hover, .saved-user-item:hover {
            border-color: #1a5f7a;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }
        
        .address-info, .logo-info, .user-info {
            flex: 1;
        }
        
        .address-label, .logo-label, .user-label {
            font-weight: 600;
            color: #1a5f7a;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        
        .address-text, .user-text {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.3;
        }
        
        .logo-preview-small {
            width: 50px;
            height: 30px;
            object-fit: contain;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 2px;
            background-color: white;
        }
        
        .address-actions, .logo-actions, .user-actions {
            display: flex;
            gap: 5px;
        }
        
        .address-action-btn, .logo-action-btn, .user-action-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .address-action-btn:hover, .logo-action-btn:hover, .user-action-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .address-action-btn.use-btn:hover,
        .logo-action-btn.use-btn:hover,
        .user-action-btn.use-btn:hover {
            background-color: #e8f4fc;
            color: #1a5f7a;
        }
        
        .address-action-btn.delete-btn:hover,
        .logo-action-btn.delete-btn:hover,
        .user-action-btn.delete-btn:hover {
            background-color: #f8e8e8;
            color: #dc3545;
        }
        
        .no-addresses, .no-logos, .no-users {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 20px;
        }
        
        .clear-addresses-btn, .clear-logos-btn, .clear-users-btn {
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }
        
        .clear-addresses-btn:hover, .clear-logos-btn:hover, .clear-users-btn:hover {
            color: #c82333;
        }
        
        .logo-upload {
            border: 2px dashed #ccc;
            border-radius: 6px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            position: relative;
        }
        
        .logo-preview {
            max-width: 200px;
            max-height: 120px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
        }
        
        .hidden {
            display: none;
        }
        
        .button {
            background-color: #1a5f7a;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .button:hover {
            background-color: #0d4a63;
        }
        
        .button.secondary {
            background-color: #28a745;
        }
        
        .button.secondary:hover {
            background-color: #1e7e34;
        }
        
        .button.danger {
            background-color: #dc3545;
        }
        
        .button.danger:hover {
            background-color: #c82333;
        }
        
        .button.warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .button.warning:hover {
            background-color: #e0a800;
        }
        
        .preview-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            min-height: 500px;
            overflow: auto;
        }
        
        /* Paper simulation */
        .paper-sheet {
            width: 794px; /* A4 width in pixels at 96 DPI (210mm * 96 / 25.4) */
            height: 1123px; /* A4 height in pixels (297mm * 96 / 25.4) */
            background-color: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: 0 auto;
            page-break-inside: avoid;
            break-inside: avoid;
        }
        
        /* Dynamic grid layout based on number of appointments */
        .appointments-grid {
            width: 100%;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            display: grid;
        }
        
        /* Layout configurations */
        .layout-1-card {
            grid-template-columns: 1fr;
            grid-template-rows: 1fr;
            gap: 0;
            padding: 80px;
        }
        
        .layout-2-cards {
            grid-template-columns: 1fr;
            grid-template-rows: repeat(2, 1fr);
            gap: 40px;
            padding: 40px;
        }
        
        .layout-4-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 30px;
        }
        
        .layout-6-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 15px;
            padding: 25px;
        }
        
        .layout-8-cards {
            grid-template-columns: repeat(2, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
        }
        
        .appointment-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            page-break-inside: avoid;
            break-inside: avoid;
            box-sizing: border-box;
        }
        
        /* Card sizes based on layout */
        .layout-1-card .appointment-card {
            padding: 40px;
        }
        
        .layout-2-cards .appointment-card {
            padding: 25px;
        }
        
        .layout-4-cards .appointment-card {
            padding: 20px;
        }
        
        .layout-6-cards .appointment-card {
            padding: 15px;
        }
        
        .layout-8-cards .appointment-card {
            padding: 12px;
        }
        
        .appointment-card:hover {
            border-color: #1a5f7a;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .appointment-card.editing {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0f0ff;
        }
        
        .card-logo-container {
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .card-logo {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            transition: opacity 0.3s;
        }
        
        .card-logo:hover {
            opacity: 0.8;
        }
        
        /* Logo sizes based on layout */
        .layout-1-card .card-logo {
            max-width: 180px;
            max-height: 120px;
        }
        
        .layout-2-cards .card-logo {
            max-width: 120px;
            max-height: 80px;
        }
        
        .layout-4-cards .card-logo {
            max-width: 80px;
            max-height: 60px;
        }
        
        .layout-6-cards .card-logo {
            max-width: 70px;
            max-height: 50px;
        }
        
        .layout-8-cards .card-logo {
            max-width: 60px;
            max-height: 40px;
        }
        
        .hospital-name {
            color: #1a5f7a;
            font-weight: 700;
            flex-grow: 1;
            text-align: center;
            line-height: 1.2;
            display: none;
        }
        
        /* Hospital name sizes based on layout */
        .layout-1-card .hospital-name {
            font-size: 1.8rem;
        }
        
        .layout-2-cards .hospital-name {
            font-size: 1.4rem;
        }
        
        .layout-4-cards .hospital-name {
            font-size: 1.1rem;
        }
        
        .layout-6-cards .hospital-name {
            font-size: 1rem;
        }
        
        .layout-8-cards .hospital-name {
            font-size: 0.95rem;
        }
        
        .card-title {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        /* Title sizes based on layout */
        .layout-1-card .card-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
        }
        
        .layout-2-cards .card-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
        }
        
        .layout-4-cards .card-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }
        
        .layout-6-cards .card-title {
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .layout-8-cards .card-title {
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .appointment-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 5px;
            margin-bottom: 10px;
            flex-grow: 1;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 3px;
            align-items: center;
            min-height: 1.4em;
        }
        
        .detail-label {
            font-weight: 600;
            color: #1a5f7a;
            min-width: 70px;
            flex-shrink: 0;
        }
        
        .detail-value {
            color: #2c3e50;
            flex-grow: 1;
            word-break: break-word;
            line-height: 1.2;
            text-align: left;
            min-height: 1.2em;
            padding-left: 10px;
        }
        
        /* Date value specific styling */
        .date-value {
            font-weight: 600;
            color: #1a5f7a;
            letter-spacing: 0.5px;
            min-width: 100px;
        }
        
        /* Detail sizes based on layout */
        .layout-1-card .detail-label,
        .layout-1-card .detail-value {
            font-size: 1.1rem;
        }
        
        .layout-2-cards .detail-label,
        .layout-2-cards .detail-value {
            font-size: 0.95rem;
        }
        
        .layout-4-cards .detail-label,
        .layout-4-cards .detail-value {
            font-size: 0.85rem;
        }
        
        .layout-6-cards .detail-label,
        .layout-6-cards .detail-value {
            font-size: 0.8rem;
        }
        
        .layout-8-cards .detail-label,
        .layout-8-cards .detail-value {
            font-size: 0.75rem;
        }
        
        /* Date-specific font sizes */
        .layout-1-card .date-value {
            font-size: 1.2rem !important;
        }
        
        .layout-6-cards .date-value,
        .layout-8-cards .date-value {
            font-size: 0.85rem !important;
        }
        
        .card-footer {
            text-align: center;
            margin-top: 8px;
            padding-top: 6px;
            border-top: 1px dashed #ddd;
            color: #666;
            font-style: italic;
            display:none;
        }
        
        /* Footer sizes based on layout */
        .layout-1-card .card-footer {
            font-size: 0.9rem;
        }
        
        .layout-2-cards .card-footer {
            font-size: 0.85rem;
        }
        
        .layout-4-cards .card-footer {
            font-size: 0.8rem;
        }
        
        .layout-6-cards .card-footer {
            font-size: 0.75rem;
        }
        
        .layout-8-cards .card-footer {
            font-size: 0.7rem;
        }
        
        .watermark {
            position: absolute;
            bottom: 4px;
            right: 4px;
            color: rgba(0, 0, 0, 0.05);
            font-weight: bold;
            transform: rotate(-15deg);
            pointer-events: none;
            visibility:hidden;
        }
        
        /* Watermark sizes based on layout */
        .layout-1-card .watermark {
            font-size: 4rem;
        }
        
        .layout-2-cards .watermark {
            font-size: 3rem;
        }
        
        .layout-4-cards .watermark {
            font-size: 2.5rem;
        }
        
        .layout-6-cards .watermark {
            font-size: 2rem;
        }
        
        .layout-8-cards .watermark {
            font-size: 1.8rem;
        }
        
        .card-number {
            position: absolute;
            top: 6px;
            right: 6px;
            background-color: #1a5f7a;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .logo-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #28a745;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            font-weight: bold;
            z-index: 10;
        }
        
        .logo-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }
        
        .logo-preview-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 15px;
        }
        
        .default-logo-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #666;
            font-style: italic;
            border: 1px dashed #ccc;
            border-radius: 4px;
            padding: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .default-logo-placeholder:hover {
            border-color: #1a5f7a;
            background-color: #f0f7ff;
        }
        
        /* Placeholder sizes based on layout */
        .layout-1-card .default-logo-placeholder {
            min-height: 80px;
            width: 150px;
            font-size: 0.9rem;
        }
        
        .layout-2-cards .default-logo-placeholder {
            min-height: 60px;
            width: 100px;
            font-size: 0.8rem;
        }
        
        .layout-4-cards .default-logo-placeholder {
            min-height: 50px;
            width: 80px;
            font-size: 0.7rem;
        }
        
        .layout-6-cards .default-logo-placeholder {
            min-height: 40px;
            width: 70px;
            font-size: 0.65rem;
        }
        
        .layout-8-cards .default-logo-placeholder {
            min-height: 35px;
            width: 60px;
            font-size: 0.6rem;
        }
        
        .logo-icon {
            margin-bottom: 3px;
        }
        
        /* Icon sizes based on layout */
        .layout-1-card .logo-icon {
            font-size: 2rem;
        }
        
        .layout-2-cards .logo-icon {
            font-size: 1.5rem;
        }
        
        .layout-4-cards .logo-icon {
            font-size: 1.3rem;
        }
        
        .layout-6-cards .logo-icon {
            font-size: 1.1rem;
        }
        
        .layout-8-cards .logo-icon {
            font-size: 1rem;
        }
        
        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .appointment-count {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .count-display {
            font-size: 1.1rem;
            color: #1a5f7a;
            font-weight: bold;
            text-align: center;
        }
        
        .layout-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .layout-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background-color: white;
        }
        
        .layout-option:hover {
            border-color: #1a5f7a;
            background-color: #f0f7ff;
        }
        
        .layout-option.selected {
            border-color: #1a5f7a;
            background-color: #e8f4fc;
            font-weight: bold;
        }
        
        .layout-option .layout-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .layout-option .layout-text {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .layout-option .layout-desc {
            font-size: 0.8rem;
            color: #666;
        }
        
        .paper-info {
            background-color: #e8f4fc;
            border: 1px solid #b8d4e5;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        
        .paper-info h4 {
            color: #1a5f7a;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .paper-info ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .paper-info li {
            margin-bottom: 5px;
        }
        
        /* Modal for editing */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }
        
        .modal-close:hover {
            background-color: #f0f0f0;
            color: #333;
        }
        
        .modal-title {
            font-size: 1.5rem;
            color: #1a5f7a;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0f0ff;
            padding-right: 30px;
        }
        
        .modal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .modal-logo-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .modal-logo-preview {
            max-width: 150px;
            max-height: 100px;
            margin: 15px auto;
            display: block;
            object-fit: contain;
        }
        
        .modal-address-section {
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        
        .modal-saved-addresses,
        .modal-saved-logos,
        .modal-saved-users {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .esc-hint {
            color: #666;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 10px;
            font-style: italic;
        }
        
        .preview-info {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Logo selection interface */
        .logo-selection-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }
        
        .logo-selection-item {
            width: 60px;
            height: 60px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            overflow: hidden;
            position: relative;
        }
        
        .logo-selection-item:hover {
            border-color: #1a5f7a;
            transform: scale(1.05);
        }
        
        .logo-selection-item.selected {
            border-color: #28a745;
            border-width: 3px;
        }
        
        .logo-selection-img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            padding: 5px;
        }
        
        .logo-selection-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            font-size: 0.6rem;
            padding: 2px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .paper-sheet,
            .paper-sheet * {
                visibility: visible;
            }
            
            .paper-sheet {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                box-shadow: none;
                border: none;
            }
            
            .appointment-card {
                box-shadow: none;
                border: 1px solid #000;
                break-inside: avoid;
                page-break-inside: avoid;
            }
            
            .card-number, .logo-badge {
                display: none;
            }
        }
        
        /* Feedback animations */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .button-spinner {
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }
        
        @media (max-width: 1200px) {
            .paper-sheet {
                transform: scale(0.8);
                transform-origin: top center;
            }
        }
        
        @media (max-width: 900px) {
            .paper-sheet {
                transform: scale(0.6);
                transform-origin: top center;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .paper-sheet {
                transform: scale(0.5);
                transform-origin: top center;
            }
            
            .layout-options {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .actions, .form-actions, .modal-actions {
                flex-direction: column;
            }
            
            .button {
                width: 100%;
            }
            
            .card-header {
                flex-direction: column;
                text-align: center;
            }
            
            .card-logo-container {
                margin-right: 0;
                margin-bottom: 5px;
            }
            
            .detail-row {
                flex-direction: row !important;
            }
            
            .detail-label {
                min-width: 60px !important;
                margin-bottom: 0;
            }
            
            .save-address-btn, .save-logo-btn, .save-user-btn {
                top: 42px;
                right: 5px;
            }
            
            .language-selector {
                position: relative;
                top: 0;
                right: 0;
                margin-bottom: 15px;
                display: flex;
                justify-content: center;
            }
            
            .language-btn {
                background-color: #1a5f7a;
            }
        }
        
        @media (max-width: 480px) {
            .layout-options {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="language-selector">
                <button class="language-btn" id="language-btn">
                    <span id="current-language">üá∫üá∏ EN</span> ‚ñº
                </button>
                <div class="language-options" id="language-options">
                    <div class="language-option selected" data-lang="en">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMCAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjE1IiBmaWxsPSIjMDAwMDgwIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI4IiB5PSIwIiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI4IiB5PSI3IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjE1IiB4PSIwIiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSI4IiBoZWlnaHQ9IjE1IiB4PSIxMiIgZmlsbD0iI2ZmZiIvPgo8cmVjdCB3aWR0aD0iMjAiIGhlaWdodD0iMyIgeT0iNiIgZmlsbD0iI2NjMDAwMCIvPgo8cmVjdCB3aWR0aD0iMjAiIGhlaWdodD0iMyIgeT0iOSIgZmlsbD0iI2NjMDAwMCIvPgo8cmVjdCB3aWR0aD0iMyIgaGVpZ2h0PSIxNSIgeD0iOSIgZmlsbD0iI2NjMDAwMCIvPgo8L3N2Zz4=" class="language-flag" alt="US Flag">
                        <span>English (EN)</span>
                    </div>
                    <div class="language-option" data-lang="pt">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMCAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjE1IiBmaWxsPSIjMDA5YjNlIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSIxNSIgZmlsbD0idXJsKCNwcmVmaXhfX3BhdHRlcm4wKSIvPgo8ZGVmcz4KPHBhdHRlcm4gaWQ9InByZWZpeF9fcGF0dGVybjAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHdpZHRoPSIxMCIgaGVpZ2h0PSIxMCIgcGF0dGVyblRyYW5zZm9ybT0icm90YXRlKDEzNSkgc2NhbGUoMi44MjgpIj4KPHBhdGggZD0iTTMgMEw0IDAgTCA0IDEgTCAzIDEgWiIgZmlsbD0iI2ZmZiIvPgo8L3BhdHRlcm4+CjwvZGVmcz4KPHJlY3QgeD0iNyIgd2lkdGg9IjYiIGhlaWdodD0iMTUiIGZpbGw9IiNmZmYiLz4KPGNpcmNsZSBjeD0iMTAiIGN5PSI3LjUiIHI9IjMuNSIgZmlsbD0iIzAwOWIzZSIvPgo8cGF0aCBkPSJNMTAgNS41IEwxMS41IDcuNSAxMCA4LjUgOC41IDcuNVoiIGZpbGw9IiNmZmYiLz4KPHBhdGggZD0iTTguNSA4IEwxMC43NSA3IDEwLjc1IDggWiIgZmlsbD0iI2ZmZiIvPgo8cGF0aCBkPSJNMTEgOCBMMTAuNzUgNyAxMC43NSA4IFoiIGZpbGw9IiNmZmYiLz4KPC9zdmc+" class="language-flag" alt="Brazil Flag">
                        <span>Portugu√™s (PT)</span>
                    </div>
                    <div class="language-option" data-lang="es">
                        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMTUiIHZpZXdCb3g9IjAgMCAyMCAxNSIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjIwIiBoZWlnaHQ9IjE1IiBmaWxsPSIjY2MwMDAwIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI1IiB5PSIwIiBmaWxsPSIjZmYwIi8+CjxyZWN0IHdpZHRoPSIyMCIgaGVpZ2h0PSI1IiB5PSIxMCIgZmlsbD0iI2ZmMCIvPgo8cmVjdCB4PSI4IiB3aWR0aD0iNCIgaGVpZ2h0PSI3IiB5PSI0IiBmaWxsPSIjY2MwMDAwIi8+CjxyZWN0IHg9IjciIHdpZHRoPSI2IiBoZWlnaHQ9IjUiIHk9IjUiIGZpbGw9IiNmZjAiLz4KPC9zdmc+" class="language-flag" alt="Spain Flag">
                        <span>Espa√±ol (ES)</span>
                    </div>
                </div>
            </div>
            <h1 id="header-title">Medical Appointment Generator - Saved Logos & Addresses</h1>
            <p class="subtitle" id="header-subtitle">Save and reuse logos, addresses and patient names - Works completely offline</p>
        </header>
        
        <div class="main-content">
            <section class="control-panel">
                <h2 class="section-title" id="settings-title">Settings</h2>
                
                <div class="appointment-count">
                    <div class="count-display" id="layout-config-title">Layout Configuration</div>
                    <p style="text-align: center; font-size: 0.9rem; margin-top: 5px;" id="layout-instruction">Choose how many cards to create on A4 sheet</p>
                </div>
                
                <div class="form-group">
                    <label id="cards-quantity-label">Number of Cards:</label>
                    <div class="layout-options">
                        <div class="layout-option" data-layout="1">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text" id="layout-1-text">1 Card</div>
                            <div class="layout-desc" id="layout-1-desc">(1√ó1) Single Large</div>
                        </div>
                        <div class="layout-option selected" data-layout="2">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text" id="layout-2-text">2 Cards</div>
                            <div class="layout-desc" id="layout-2-desc">(1√ó2) Large</div>
                        </div>
                        <div class="layout-option" data-layout="4">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text" id="layout-4-text">4 Cards</div>
                            <div class="layout-desc" id="layout-4-desc">(2√ó2) Medium</div>
                        </div>
                        <div class="layout-option" data-layout="6">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text" id="layout-6-text">6 Cards</div>
                            <div class="layout-desc" id="layout-6-desc">(2√ó3) Compact</div>
                        </div>
                        <div class="layout-option" data-layout="8">
                            <div class="layout-icon">üìÑ</div>
                            <div class="layout-text" id="layout-8-text">8 Cards</div>
                            <div class="layout-desc" id="layout-8-desc">(2√ó4) Standard</div>
                        </div>
                    </div>
                </div>
                
                <div class="paper-info" id="paper-info">
                    <!-- Dynamic paper info will be inserted here -->
                </div>
                
                <div class="form-group">
                    <label for="global-pacient" id="patient-label">Patient (all cards):</label>
                    <div class="address-input-container">
                        <input type="text" id="global-pacient" placeholder="Patient name for all cards" value="Alex Silva">
                        <button type="button" class="save-user-btn" id="save-global-user-btn" title="Save this name">
                            üíæ
                        </button>
                        <div class="user-autocomplete" id="global-user-autocomplete"></div>
                    </div>
                    
                    <div class="saved-users-container" id="global-saved-users">
                        <div class="saved-users-title">
                            <span id="saved-names-title">Saved Names</span>
                            <button class="clear-users-btn" id="clear-global-users">Clear All</button>
                        </div>
                        <!-- Saved users will be loaded here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="global-hospital" id="hospital-label">Hospital/Clinic (all cards):</label>
                    <input type="text" id="global-hospital" placeholder="Hospital/clinic name for all cards" value="Santa B√°rbara">
                </div>
                
                <div class="form-group">
                    <label for="global-speciality" id="speciality-label">Specialty (all cards):</label>
                    <select id="global-speciality">
                        <option value="otorrinolaringologista">ENT Specialist</option>
                        <option value="cardiologista">Cardiologist</option>
                        <option value="dermatologista">Dermatologist</option>
                        <option value="oftalmologista">Ophthalmologist</option>
                        <option value="ortopedista">Orthopedist</option>
                        <option value="pediatra">Pediatrician</option>
                        <option value="ginecologista">Gynecologist</option>
                        <option value="clinico geral">General Practitioner</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="global-address" id="address-label">Address (all cards):</label>
                    <div class="address-input-container">
                        <input type="text" id="global-address" placeholder="Type or select a saved address" value="Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA">
                        <button type="button" class="save-address-btn" id="save-global-address-btn" title="Save this address">
                            üíæ
                        </button>
                        <div class="address-autocomplete" id="global-address-autocomplete"></div>
                    </div>
                    
                    <div class="saved-addresses-container" id="global-saved-addresses">
                        <div class="saved-addresses-title">
                            <span id="saved-addresses-title">Saved Addresses</span>
                            <button class="clear-addresses-btn" id="clear-global-addresses">Clear All</button>
                        </div>
                        <!-- Saved addresses will be loaded here -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label id="default-logo-label">Default Logo:</label>
                    <div class="logo-upload">
                        <div class="logo-preview-container">
                            <div id="default-logo-placeholder" class="default-logo-placeholder">
                                <div class="logo-icon">üè•</div>
                                <div id="no-logo-text">No logo</div>
                                <small id="click-add-logo">Click to add</small>
                            </div>
                            <img id="global-logo-preview" class="logo-preview hidden" alt="Default logo preview">
                        </div>
                        
                        <div class="logo-controls">
                            <input type="file" id="global-logo-upload" accept="image/*" class="hidden">
                            <button type="button" id="global-upload-btn" class="button">Select New Logo</button>
                            <button type="button" id="save-global-logo-btn" class="button secondary" title="Save this logo">üíæ Save Logo</button>
                            <button type="button" id="remove-global-logo-btn" class="button danger hidden">Remove Logo</button>
                        </div>
                        
                        <div class="saved-logos-container" id="global-saved-logos">
                            <div class="saved-logos-title">
                                <span id="saved-logos-title">Saved Logos</span>
                                <button class="clear-logos-btn" id="clear-global-logos">Clear All</button>
                            </div>
                            <!-- Saved logos will be loaded here -->
                        </div>
                        
                        <div class="logo-autocomplete" id="global-logo-autocomplete"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" id="apply-all-btn" class="button">Apply to All Cards</button>
                    <button type="button" id="reset-all-btn" class="button danger">Reset Everything</button>
                </div>
            </section>
            
            <section class="preview-section">
                <h2 class="section-title" id="preview-title">A4 Print Preview</h2>
                
                <div class="preview-container">
                    <div class="paper-sheet">
                        <div class="appointments-grid layout-2-cards" id="appointments-grid">
                            <!-- Dynamic appointment cards will be generated here -->
                        </div>
                    </div>
                    
                    <div class="preview-info">
                        <p id="layout-info">‚ö° 2 large cards optimized for A4 sheet</p>
                        <p id="size-info">üìè Each card: ‚âà 180mm √ó 120mm</p>
                        <p>üë§ <strong id="names-tip">Names:</strong> Save patient names for future use by clicking üíæ</p>
                        <p>üñºÔ∏è <strong id="logos-tip">Logos:</strong> Save logos for future use by clicking üíæ</p>
                        <p>üíæ <strong id="addresses-tip">Addresses:</strong> Type and press üíæ to save addresses</p>
                    </div>
                </div>
                
                <div class="actions">
                    <button type="button" id="download-pdf-btn" class="button secondary">Download PDF for Printing</button>
                    <button type="button" id="print-btn" class="button">Print Now</button>
                    <button type="button" id="download-image-btn" class="button">Download as Image</button>
                </div>
            </section>
        </div>
        
        <footer style="text-align: center; margin-top: 20px; color: #666; font-size: 0.9rem;">
            <p id="footer-text">Medical appointment generation system - Logos, addresses and names saved locally - Works completely offline</p>
        </footer>
    </div>

    <!-- Modal for editing card -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal-content" id="modal-content">
            <button class="modal-close" id="modal-close-btn" title="Close (ESC)">√ó</button>
            <h3 class="modal-title">Edit Card <span id="modal-card-number">1</span></h3>
            
            <div class="form-group">
                <label for="modal-pacient" id="modal-patient-label">Patient Name:</label>
                <div class="address-input-container">
                    <input type="text" id="modal-pacient" placeholder="Patient name">
                    <button type="button" class="save-user-btn" id="save-modal-user-btn" title="Save this name">
                        üíæ
                    </button>
                    <div class="user-autocomplete" id="modal-user-autocomplete"></div>
                </div>
                
                <div class="modal-saved-users" id="modal-saved-users">
                    <!-- Saved users for modal will be loaded here -->
                </div>
            </div>
            
            <div class="form-group">
                <label for="modal-hospital" id="modal-hospital-label">Hospital/Clinic:</label>
                <input type="text" id="modal-hospital" placeholder="Hospital/clinic name">
            </div>
            
            <div class="form-group">
                <label for="modal-speciality" id="modal-speciality-label">Specialty:</label>
                <select id="modal-speciality">
                    <option value="otorrinolaringologista">ENT Specialist</option>
                    <option value="cardiologista">Cardiologist</option>
                    <option value="dermatologista">Dermatologist</option>
                    <option value="oftalmologista">Ophthalmologist</option>
                    <option value="ortopedista">Orthopedist</option>
                    <option value="pediatra">Pediatrician</option>
                    <option value="ginecologista">Gynecologist</option>
                    <option value="clinico geral">General Practitioner</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="modal-date" id="modal-date-label">Appointment Date:</label>
                <input type="date" id="modal-date">
            </div>
            
            <div class="form-group">
                <label for="modal-hour" id="modal-hour-label">Time:</label>
                <input type="time" id="modal-hour">
            </div>
            
            <div class="modal-address-section">
                <h4 id="modal-address-title">Appointment Address</h4>
                <div class="address-input-container">
                    <input type="text" id="modal-address" placeholder="Type or select a saved address">
                    <button type="button" class="save-address-btn" id="save-modal-address-btn" title="Save this address">
                        üíæ
                    </button>
                    <div class="address-autocomplete" id="modal-address-autocomplete"></div>
                </div>
                
                <div class="modal-saved-addresses" id="modal-saved-addresses">
                    <!-- Saved addresses for modal will be loaded here -->
                </div>
            </div>
            
            <div class="modal-logo-section">
                <h4 id="modal-logo-title">Card Logo</h4>
                <p id="modal-logo-description">This logo will appear only on this specific card</p>
                
                <div class="logo-preview-container">
                    <div id="modal-default-logo-placeholder" class="default-logo-placeholder">
                        <div class="logo-icon">üè•</div>
                        <div id="modal-use-default-text">Use default logo</div>
                        <small id="modal-add-individual-text">Click to add individual logo</small>
                    </div>
                    <img id="modal-logo-preview" class="modal-logo-preview hidden" alt="Individual logo preview">
                </div>
                
                <div class="logo-controls">
                    <input type="file" id="modal-logo-upload" accept="image/*" class="hidden">
                    <button type="button" id="modal-upload-logo-btn" class="button">Upload New Logo</button>
                    <button type="button" id="save-modal-logo-btn" class="button secondary">üíæ Save Logo</button>
                    <button type="button" id="modal-remove-logo-btn" class="button danger hidden">Remove Individual Logo</button>
                </div>
                
                <div class="logo-controls">
                    <button type="button" id="modal-use-global-logo-btn" class="button secondary">Use Default Logo</button>
                </div>
                
                <div class="modal-saved-logos" id="modal-saved-logos">
                    <!-- Saved logos for modal will be loaded here -->
                </div>
                
                <div class="logo-autocomplete" id="modal-logo-autocomplete"></div>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="modal-save-btn" class="button secondary">Save Changes</button>
                <button type="button" id="modal-cancel-btn" class="button danger">Cancel</button>
            </div>
            
            <div class="esc-hint" id="esc-hint-text">Press ESC to cancel and close</div>
        </div>
    </div>

    <!-- Modal for saving address -->
    <div class="modal-overlay" id="save-address-modal-overlay">
        <div class="modal-content" id="save-address-modal-content">
            <button class="modal-close" id="save-address-modal-close-btn" title="Close (ESC)">√ó</button>
            <h3 class="modal-title">Save Address</h3>
            
            <div class="form-group">
                <label for="address-name" id="address-name-label">Name for this address:</label>
                <input type="text" id="address-name" placeholder="Ex: Santa B√°rbara Clinic, General Hospital, etc.">
            </div>
            
            <div class="form-group">
                <label for="address-value" id="address-value-label">Full address:</label>
                <textarea id="address-value" rows="3" placeholder="Full address..." readonly></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="save-address-confirm-btn" class="button secondary">Save Address</button>
                <button type="button" id="save-address-cancel-btn" class="button danger">Cancel</button>
            </div>
            
            <div class="esc-hint">Press ESC to cancel</div>
        </div>
    </div>

    <!-- Modal for saving logo -->
    <div class="modal-overlay" id="save-logo-modal-overlay">
        <div class="modal-content" id="save-logo-modal-content">
            <button class="modal-close" id="save-logo-modal-close-btn" title="Close (ESC)">√ó</button>
            <h3 class="modal-title">Save Logo</h3>
            
            <div class="form-group">
                <label for="logo-name" id="logo-name-label">Name for this logo:</label>
                    <input type="text" id="logo-name" placeholder="Ex: Santa B√°rbara Logo, General Hospital, etc.">
            </div>
            
            <div class="form-group">
                <label id="logo-preview-label">Logo preview:</label>
                <div class="logo-preview-container">
                    <img id="save-logo-preview" class="logo-preview" alt="Logo preview to be saved">
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="save-logo-confirm-btn" class="button secondary">Save Logo</button>
                <button type="button" id="save-logo-cancel-btn" class="button danger">Cancel</button>
            </div>
            
            <div class="esc-hint">Press ESC to cancel</div>
        </div>
    </div>

    <!-- Modal for saving user -->
    <div class="modal-overlay" id="save-user-modal-overlay">
        <div class="modal-content" id="save-user-modal-content">
            <button class="modal-close" id="save-user-modal-close-btn" title="Close (ESC)">√ó</button>
            <h3 class="modal-title">Save Patient Name</h3>
            
            <div class="form-group">
                <label for="user-name" id="user-name-label">Name for this patient:</label>
                <input type="text" id="user-name" placeholder="Ex: Alex Silva, Maria Santos, Jo√£o Pereira, etc.">
            </div>
            
            <div class="form-group">
                <label for="user-value" id="user-value-label">Patient's full name:</label>
                <textarea id="user-value" rows="2" placeholder="Patient's full name..." readonly></textarea>
            </div>
            
            <div class="modal-actions">
                <button type="button" id="save-user-confirm-btn" class="button secondary">Save Name</button>
                <button type="button" id="save-user-cancel-btn" class="button danger">Cancel</button>
            </div>
            
            <div class="esc-hint">Press ESC to cancel</div>
        </div>
    </div>

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Language dictionary
        const translations = {
            en: {
                // Header
                'header-title': 'Medical Appointment Generator - Saved Logos & Addresses',
                'header-subtitle': 'Save and reuse logos, addresses and patient names - Works completely offline',
                
                // Settings
                'settings-title': 'Settings',
                'layout-config-title': 'Layout Configuration',
                'layout-instruction': 'Choose how many cards to create on A4 sheet',
                'cards-quantity-label': 'Number of Cards:',
                'layout-1-text': '1 Card',
                'layout-1-desc': '(1√ó1) Single Large',
                'layout-2-text': '2 Cards',
                'layout-2-desc': '(1√ó2) Large',
                'layout-4-text': '4 Cards',
                'layout-4-desc': '(2√ó2) Medium',
                'layout-6-text': '6 Cards',
                'layout-6-desc': '(2√ó3) Compact',
                'layout-8-text': '8 Cards',
                'layout-8-desc': '(2√ó4) Standard',
                
                // Form labels
                'patient-label': 'Patient (all cards):',
                'saved-names-title': 'Saved Names',
                'hospital-label': 'Hospital/Clinic (all cards):',
                'speciality-label': 'Specialty (all cards):',
                'address-label': 'Address (all cards):',
                'saved-addresses-title': 'Saved Addresses',
                'default-logo-label': 'Default Logo:',
                'no-logo-text': 'No logo',
                'click-add-logo': 'Click to add',
                'saved-logos-title': 'Saved Logos',
                
                // Buttons
                'apply-all-btn': 'Apply to All Cards',
                'reset-all-btn': 'Reset Everything',
                'clear-all': 'Clear All',
                
                // Preview
                'preview-title': 'A4 Print Preview',
                'names-tip': 'Names:',
                'logos-tip': 'Logos:',
                'addresses-tip': 'Addresses:',
                
                // Download buttons
                'download-pdf-btn': 'Download PDF for Printing',
                'print-btn': 'Print Now',
                'download-image-btn': 'Download as Image',
                
                // Footer
                'footer-text': 'Medical appointment generation system - Logos, addresses and names saved locally - Works completely offline',
                
                // Modal
                'modal-patient-label': 'Patient Name:',
                'modal-hospital-label': 'Hospital/Clinic:',
                'modal-speciality-label': 'Specialty:',
                'modal-date-label': 'Appointment Date:',
                'modal-hour-label': 'Time:',
                'modal-address-title': 'Appointment Address',
                'modal-logo-title': 'Card Logo',
                'modal-logo-description': 'This logo will appear only on this specific card',
                'modal-use-default-text': 'Use default logo',
                'modal-add-individual-text': 'Click to add individual logo',
                'modal-save-btn': 'Save Changes',
                'modal-cancel-btn': 'Cancel',
                'esc-hint-text': 'Press ESC to cancel and close',
                
                // Save modals
                'address-name-label': 'Name for this address:',
                'address-value-label': 'Full address:',
                'save-address-btn': 'Save Address',
                'logo-name-label': 'Name for this logo:',
                'logo-preview-label': 'Logo preview:',
                'save-logo-btn': 'Save Logo',
                'user-name-label': 'Name for this patient:',
                'user-value-label': 'Patient\'s full name:',
                'save-user-btn': 'Save Name',
                
                // Card content
                'card-title': 'APPOINTMENT',
                'name-label': 'Name:',
                'clinic-label': 'Clinic:',
                'speciality-label-card': 'Specialty:',
                'date-label': 'Date:',
                'time-label': 'Time:',
                'location-label': 'Location:',
                'card-footer': 'Arrive 15 min before',
                'watermark': 'APPOINTMENT',
                
                // Specialties
                'otorrinolaringologista': 'ENT Specialist',
                'cardiologista': 'Cardiologist',
                'dermatologista': 'Dermatologist',
                'oftalmologista': 'Ophthalmologist',
                'ortopedista': 'Orthopedist',
                'pediatra': 'Pediatrician',
                'ginecologista': 'Gynecologist',
                'clinico geral': 'General Practitioner',
                
                // Placeholders
                'patient-placeholder': 'Patient name for all cards',
                'hospital-placeholder': 'Hospital/clinic name for all cards',
                'address-placeholder': 'Type or select a saved address',
                'modal-patient-placeholder': 'Patient name',
                'modal-hospital-placeholder': 'Hospital/clinic name',
                'modal-address-placeholder': 'Type or select a saved address',
                
                // Messages
                'no-addresses': 'No saved addresses yet',
                'no-logos': 'No saved logos yet',
                'no-users': 'No saved names yet',
                
                // Layout info
                'layout-info-1': '‚ö° 1 single large card optimized for A4 sheet',
                'layout-info-2': '‚ö° 2 large cards optimized for A4 sheet',
                'layout-info-4': '‚ö° 4 medium cards optimized for A4 sheet',
                'layout-info-6': '‚ö° 6 compact cards optimized for A4 sheet',
                'layout-info-8': '‚ö° 8 standard cards optimized for A4 sheet',
                'size-info-single': 'üìè Single card: ‚âà {{width}}mm √ó {{height}}mm',
                'size-info-multiple': 'üìè Each card: ‚âà {{width}}mm √ó {{height}}mm'
            },
            
            pt: {
                // Header
                'header-title': 'Gerador de Agendamentos M√©dicos - Logos & Endere√ßos Salvos',
                'header-subtitle': 'Salve e reutilize logos, endere√ßos e nomes de pacientes - Funciona totalmente offline',
                
                // Settings
                'settings-title': 'Configura√ß√µes',
                'layout-config-title': 'Configura√ß√£o do Layout',
                'layout-instruction': 'Escolha quantos cart√µes criar na folha A4',
                'cards-quantity-label': 'Quantidade de Cart√µes:',
                'layout-1-text': '1 Cart√£o',
                'layout-1-desc': '(1√ó1) √önico Grande',
                'layout-2-text': '2 Cart√µes',
                'layout-2-desc': '(1√ó2) Grande',
                'layout-4-text': '4 Cart√µes',
                'layout-4-desc': '(2√ó2) M√©dio',
                'layout-6-text': '6 Cart√µes',
                'layout-6-desc': '(2√ó3) Compacto',
                'layout-8-text': '8 Cart√µes',
                'layout-8-desc': '(2√ó4) Padr√£o',
                
                // Form labels
                'patient-label': 'Paciente (geral):',
                'saved-names-title': 'Nomes Salvos',
                'hospital-label': 'Hospital/Cl√≠nica (geral):',
                'speciality-label': 'Especialidade (geral):',
                'address-label': 'Endere√ßo (geral):',
                'saved-addresses-title': 'Endere√ßos Salvos',
                'default-logo-label': 'Logo Padr√£o:',
                'no-logo-text': 'Sem logo',
                'click-add-logo': 'Clique para adicionar',
                'saved-logos-title': 'Logos Salvos',
                
                // Buttons
                'apply-all-btn': 'Aplicar Texto a Todos',
                'reset-all-btn': 'Redefinir Tudo',
                'clear-all': 'Limpar Todos',
                
                // Preview
                'preview-title': 'Pr√©-visualiza√ß√£o para Impress√£o A4',
                'names-tip': 'Nomes:',
                'logos-tip': 'Logos:',
                'addresses-tip': 'Endere√ßos:',
                
                // Download buttons
                'download-pdf-btn': 'Baixar PDF para Impress√£o',
                'print-btn': 'Imprimir Agora',
                'download-image-btn': 'Baixar como Imagem',
                
                // Footer
                'footer-text': 'Sistema de gera√ß√£o de agendamentos m√©dicos - Logos, endere√ßos e nomes salvos localmente - Funciona totalmente offline',
                
                // Modal
                'modal-patient-label': 'Nome do Paciente:',
                'modal-hospital-label': 'Hospital/Cl√≠nica:',
                'modal-speciality-label': 'Especialidade:',
                'modal-date-label': 'Data da Consulta:',
                'modal-hour-label': 'Hor√°rio:',
                'modal-address-title': 'Endere√ßo da Consulta',
                'modal-logo-title': 'Logo do Cart√£o',
                'modal-logo-description': 'Este logo aparecer√° apenas neste cart√£o espec√≠fico',
                'modal-use-default-text': 'Usar logo padr√£o',
                'modal-add-individual-text': 'Clique para adicionar logo individual',
                'modal-save-btn': 'Salvar Altera√ß√µes',
                'modal-cancel-btn': 'Cancelar',
                'esc-hint-text': 'Pressione ESC para cancelar e fechar',
                
                // Save modals
                'address-name-label': 'Nome para este endere√ßo:',
                'address-value-label': 'Endere√ßo completo:',
                'save-address-btn': 'Salvar Endere√ßo',
                'logo-name-label': 'Nome para este logo:',
                'logo-preview-label': 'Pr√©-visualiza√ß√£o do logo:',
                'save-logo-btn': 'Salvar Logo',
                'user-name-label': 'Nome para este paciente:',
                'user-value-label': 'Nome completo do paciente:',
                'save-user-btn': 'Salvar Nome',
                
                // Card content
                'card-title': 'AGENDAMENTO',
                'name-label': 'Nome:',
                'clinic-label': 'Cl√≠nica:',
                'speciality-label-card': 'Especialidade:',
                'date-label': 'Data:',
                'time-label': 'Hora:',
                'location-label': 'Local:',
                'card-footer': 'Chegar 15 min antes',
                'watermark': 'CONSULTA',
                
                // Specialties
                'otorrinolaringologista': 'Otorrinolaringologista',
                'cardiologista': 'Cardiologista',
                'dermatologista': 'Dermatologista',
                'oftalmologista': 'Oftalmologista',
                'ortopedista': 'Ortopedista',
                'pediatra': 'Pediatra',
                'ginecologista': 'Ginecologista',
                'clinico geral': 'Cl√≠nico Geral',
                
                // Placeholders
                'patient-placeholder': 'Nome do paciente para todos',
                'hospital-placeholder': 'Nome do hospital/cl√≠nica para todos',
                'address-placeholder': 'Digite ou selecione um endere√ßo salvo',
                'modal-patient-placeholder': 'Nome do paciente',
                'modal-hospital-placeholder': 'Nome do hospital/cl√≠nica',
                'modal-address-placeholder': 'Digite ou selecione um endere√ßo salvo',
                
                // Messages
                'no-addresses': 'Nenhum endere√ßo salvo ainda',
                'no-logos': 'Nenhum logo salvo ainda',
                'no-users': 'Nenhum nome salvo ainda',
                
                // Layout info
                'layout-info-1': '‚ö° 1 cart√£o √∫nico grande otimizado para folha A4',
                'layout-info-2': '‚ö° 2 cart√µes grandes otimizados para folha A4',
                'layout-info-4': '‚ö° 4 cart√µes m√©dios otimizados para folha A4',
                'layout-info-6': '‚ö° 6 cart√µes compactos otimizados para folha A4',
                'layout-info-8': '‚ö° 8 cart√µes padr√£o otimizados para folha A4',
                'size-info-single': 'üìè Cart√£o √∫nico: ‚âà {{width}}mm √ó {{height}}mm',
                'size-info-multiple': 'üìè Cada cart√£o: ‚âà {{width}}mm √ó {{height}}mm'
            },
            
            es: {
                // Header
                'header-title': 'Generador de Citas M√©dicas - Logos y Direcciones Guardados',
                'header-subtitle': 'Guarde y reutilice logos, direcciones y nombres de pacientes - Funciona completamente sin conexi√≥n',
                
                // Settings
                'settings-title': 'Configuraciones',
                'layout-config-title': 'Configuraci√≥n del Dise√±o',
                'layout-instruction': 'Elija cu√°ntas tarjetas crear en la hoja A4',
                'cards-quantity-label': 'Cantidad de Tarjetas:',
                'layout-1-text': '1 Tarjeta',
                'layout-1-desc': '(1√ó1) √önica Grande',
                'layout-2-text': '2 Tarjetas',
                'layout-2-desc': '(1√ó2) Grandes',
                'layout-4-text': '4 Tarjetas',
                'layout-4-desc': '(2√ó2) Medianas',
                'layout-6-text': '6 Tarjetas',
                'layout-6-desc': '(2√ó3) Compactas',
                'layout-8-text': '8 Tarjetas',
                'layout-8-desc': '(2√ó4) Est√°ndar',
                
                // Form labels
                'patient-label': 'Paciente (todas):',
                'saved-names-title': 'Nombres Guardados',
                'hospital-label': 'Hospital/Cl√≠nica (todas):',
                'speciality-label': 'Especialidad (todas):',
                'address-label': 'Direcci√≥n (todas):',
                'saved-addresses-title': 'Direcciones Guardadas',
                'default-logo-label': 'Logo Predeterminado:',
                'no-logo-text': 'Sin logo',
                'click-add-logo': 'Haga clic para agregar',
                'saved-logos-title': 'Logos Guardados',
                
                // Buttons
                'apply-all-btn': 'Aplicar a Todas las Tarjetas',
                'reset-all-btn': 'Restablecer Todo',
                'clear-all': 'Limpiar Todo',
                
                // Preview
                'preview-title': 'Vista Previa para Impresi√≥n A4',
                'names-tip': 'Nombres:',
                'logos-tip': 'Logos:',
                'addresses-tip': 'Direcciones:',
                
                // Download buttons
                'download-pdf-btn': 'Descargar PDF para Imprimir',
                'print-btn': 'Imprimir Ahora',
                'download-image-btn': 'Descargar como Imagen',
                
                // Footer
                'footer-text': 'Sistema de generaci√≥n de citas m√©dicas - Logos, direcciones y nombres guardados localmente - Funciona completamente sin conexi√≥n',
                
                // Modal
                'modal-patient-label': 'Nombre del Paciente:',
                'modal-hospital-label': 'Hospital/Cl√≠nica:',
                'modal-speciality-label': 'Especialidad:',
                'modal-date-label': 'Fecha de la Cita:',
                'modal-hour-label': 'Hora:',
                'modal-address-title': 'Direcci√≥n de la Cita',
                'modal-logo-title': 'Logo de la Tarjeta',
                'modal-logo-description': 'Este logo aparecer√° solo en esta tarjeta espec√≠fica',
                'modal-use-default-text': 'Usar logo predeterminado',
                'modal-add-individual-text': 'Haga clic para agregar logo individual',
                'modal-save-btn': 'Guardar Cambios',
                'modal-cancel-btn': 'Cancelar',
                'esc-hint-text': 'Presione ESC para cancelar y cerrar',
                
                // Save modals
                'address-name-label': 'Nombre para esta direcci√≥n:',
                'address-value-label': 'Direcci√≥n completa:',
                'save-address-btn': 'Guardar Direcci√≥n',
                'logo-name-label': 'Nombre para este logo:',
                'logo-preview-label': 'Vista previa del logo:',
                'save-logo-btn': 'Guardar Logo',
                'user-name-label': 'Nombre para este paciente:',
                'user-value-label': 'Nombre completo del paciente:',
                'save-user-btn': 'Guardar Nombre',
                
                // Card content
                'card-title': 'CITA M√âDICA',
                'name-label': 'Nombre:',
                'clinic-label': 'Cl√≠nica:',
                'speciality-label-card': 'Especialidad:',
                'date-label': 'Fecha:',
                'time-label': 'Hora:',
                'location-label': 'Lugar:',
                'card-footer': 'Llegar 15 min antes',
                'watermark': 'CITA',
                
                // Specialties
                'otorrinolaringologista': 'Otorrinolaring√≥logo',
                'cardiologista': 'Cardi√≥logo',
                'dermatologista': 'Dermat√≥logo',
                'oftalmologista': 'Oftalm√≥logo',
                'ortopedista': 'Ortopedista',
                'pediatra': 'Pediatra',
                'ginecologista': 'Ginec√≥logo',
                'clinico geral': 'M√©dico General',
                
                // Placeholders
                'patient-placeholder': 'Nombre del paciente para todos',
                'hospital-placeholder': 'Nombre del hospital/cl√≠nica para todos',
                'address-placeholder': 'Escriba o seleccione una direcci√≥n guardada',
                'modal-patient-placeholder': 'Nombre del paciente',
                'modal-hospital-placeholder': 'Nombre del hospital/cl√≠nica',
                'modal-address-placeholder': 'Escriba o seleccione una direcci√≥n guardada',
                
                // Messages
                'no-addresses': 'No hay direcciones guardadas a√∫n',
                'no-logos': 'No hay logos guardados a√∫n',
                'no-users': 'No hay nombres guardados a√∫n',
                
                // Layout info
                'layout-info-1': '‚ö° 1 tarjeta grande √∫nica optimizada para hoja A4',
                'layout-info-2': '‚ö° 2 tarjetas grandes optimizadas para hoja A4',
                'layout-info-4': '‚ö° 4 tarjetas medianas optimizadas para hoja A4',
                'layout-info-6': '‚ö° 6 tarjetas compactas optimizadas para hoja A4',
                'layout-info-8': '‚ö° 8 tarjetas est√°ndar optimizadas para hoja A4',
                'size-info-single': 'üìè Tarjeta √∫nica: ‚âà {{width}}mm √ó {{height}}mm',
                'size-info-multiple': 'üìè Cada tarjeta: ‚âà {{width}}mm √ó {{height}}mm'
            }
        };

        // Current language
        let currentLanguage = 'en';

        // Function to translate the entire interface
        function translateInterface(lang) {
            currentLanguage = lang;
            
            // Update language button
            document.getElementById('current-language').textContent = 
                lang === 'en' ? 'üá∫üá∏ EN' : 
                lang === 'pt' ? 'üáßüá∑ PT' : 
                'üá™üá∏ ES';
            
            // Update language options selection
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.lang === lang) {
                    option.classList.add('selected');
                }
            });
            
            // Get translation dictionary
            const t = translations[lang];
            
            // Translate all elements with translation keys
            Object.keys(t).forEach(key => {
                const elements = document.querySelectorAll(`[id="${key}"]`);
                elements.forEach(element => {
                    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
                        if (key.includes('placeholder')) {
                            element.placeholder = t[key];
                        } else if (element.type !== 'button' && element.type !== 'submit') {
                            element.value = t[key];
                        }
                    } else if (element.tagName === 'OPTION') {
                        // Handle specialty options
                        element.textContent = t[key];
                    } else {
                        element.textContent = t[key];
                    }
                });
            });
            
            // Special handling for specialty selectors
            const specialtySelectors = ['global-speciality', 'modal-speciality'];
            specialtySelectors.forEach(selector => {
                const select = document.getElementById(selector);
                if (select) {
                    Array.from(select.options).forEach(option => {
                        const translatedValue = t[option.value];
                        if (translatedValue) {
                            option.textContent = translatedValue;
                        }
                    });
                }
            });
            
            // Update layout info
            updateLayoutInfo();
            
            // Update card content
            regenerateCardContent();
            
            // Save language preference
            localStorage.setItem('medicalAppointmentLanguage', lang);
        }

        // Update layout info based on language
        function updateLayoutInfo() {
            const config = layoutConfigs[currentLayout];
            const t = translations[currentLanguage];
            
            const layoutInfoMap = {
                1: t['layout-info-1'],
                2: t['layout-info-2'],
                4: t['layout-info-4'],
                6: t['layout-info-6'],
                8: t['layout-info-8']
            };
            
            const sizeInfoTemplate = currentLayout === 1 ? t['size-info-single'] : t['size-info-multiple'];
            const sizeInfo = sizeInfoTemplate
                .replace('{{width}}', config.cardWidth)
                .replace('{{height}}', config.cardHeight);
            
            document.getElementById('layout-info').textContent = layoutInfoMap[currentLayout] || layoutInfoMap[2];
            document.getElementById('size-info').textContent = sizeInfo;
        }

        // Regenerate card content with new language
        function regenerateCardContent() {
            const t = translations[currentLanguage];
            
            // Update all existing cards
            document.querySelectorAll('.appointment-card').forEach((card, index) => {
                if (index < currentLayout) {
                    // Update labels in the card
                    const labelElements = card.querySelectorAll('.detail-label');
                    if (labelElements.length >= 6) {
                        labelElements[0].textContent = t['name-label'] + ':';
                        labelElements[1].textContent = t['clinic-label'] + ':';
                        labelElements[2].textContent = t['speciality-label-card'] + ':';
                        labelElements[3].textContent = t['date-label'] + ':';
                        labelElements[4].textContent = t['time-label'] + ':';
                        labelElements[5].textContent = t['location-label'] + ':';
                    }
                    
                    // Update card title
                    const titleElement = card.querySelector('.card-title');
                    if (titleElement) {
                        titleElement.textContent = t['card-title'];
                    }
                    
                    // Update footer
                    const footerElement = card.querySelector('.card-footer');
                    if (footerElement) {
                        footerElement.textContent = t['card-footer'];
                    }
                    
                    // Update watermark
                    const watermarkElement = card.querySelector('.watermark');
                    if (watermarkElement) {
                        watermarkElement.textContent = t['watermark'];
                    }
                    
                    // Update specialty text
                    const specialtyElement = card.querySelector('.detail-value:nth-child(3)');
                    if (specialtyElement) {
                        const specialtyValue = cardData[index].speciality;
                        specialtyElement.textContent = t[specialtyValue] || specialtyValue;
                    }
                }
            });
        }

        // Initialize the page with saved language or default
        function initLanguage() {
            const savedLanguage = localStorage.getItem('medicalAppointmentLanguage') || 'en';
            translateInterface(savedLanguage);
        }

        // Language selector functionality
        document.getElementById('language-btn').addEventListener('click', function() {
            const options = document.getElementById('language-options');
            options.style.display = options.style.display === 'block' ? 'none' : 'block';
        });

        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.dataset.lang;
                translateInterface(lang);
                document.getElementById('language-options').style.display = 'none';
                showFeedback(`Language changed to ${lang === 'en' ? 'English' : lang === 'pt' ? 'Portuguese' : 'Spanish'}`, 'success');
            });
        });

        // Close language dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.language-selector')) {
                document.getElementById('language-options').style.display = 'none';
            }
        });

        // Element references
        const globalPacientInput = document.getElementById('global-pacient');
        const globalHospitalInput = document.getElementById('global-hospital');
        const globalSpecialityInput = document.getElementById('global-speciality');
        const globalAddressInput = document.getElementById('global-address');
        const globalAddressAutocomplete = document.getElementById('global-address-autocomplete');
        const globalUserAutocomplete = document.getElementById('global-user-autocomplete');
        const saveGlobalAddressBtn = document.getElementById('save-global-address-btn');
        const saveGlobalUserBtn = document.getElementById('save-global-user-btn');
        const globalSavedAddressesContainer = document.getElementById('global-saved-addresses');
        const globalSavedUsersContainer = document.getElementById('global-saved-users');
        const clearGlobalAddressesBtn = document.getElementById('clear-global-addresses');
        const clearGlobalUsersBtn = document.getElementById('clear-global-users');
        
        const globalLogoUploadInput = document.getElementById('global-logo-upload');
        const globalUploadBtn = document.getElementById('global-upload-btn');
        const saveGlobalLogoBtn = document.getElementById('save-global-logo-btn');
        const removeGlobalLogoBtn = document.getElementById('remove-global-logo-btn');
        const globalLogoPreview = document.getElementById('global-logo-preview');
        const defaultLogoPlaceholder = document.getElementById('default-logo-placeholder');
        const globalSavedLogosContainer = document.getElementById('global-saved-logos');
        const clearGlobalLogosBtn = document.getElementById('clear-global-logos');
        const globalLogoAutocomplete = document.getElementById('global-logo-autocomplete');
        
        const layoutOptions = document.querySelectorAll('.layout-option');
        const paperInfo = document.getElementById('paper-info');
        const layoutInfo = document.getElementById('layout-info');
        const sizeInfo = document.getElementById('size-info');
        
        // Modal elements
        const modalOverlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalPacientInput = document.getElementById('modal-pacient');
        const modalHospitalInput = document.getElementById('modal-hospital');
        const modalSpecialityInput = document.getElementById('modal-speciality');
        const modalDateInput = document.getElementById('modal-date');
        const modalHourInput = document.getElementById('modal-hour');
        const modalAddressInput = document.getElementById('modal-address');
        const modalAddressAutocomplete = document.getElementById('modal-address-autocomplete');
        const modalUserAutocomplete = document.getElementById('modal-user-autocomplete');
        const saveModalAddressBtn = document.getElementById('save-modal-address-btn');
        const saveModalUserBtn = document.getElementById('save-modal-user-btn');
        const modalSavedAddressesContainer = document.getElementById('modal-saved-addresses');
        const modalSavedUsersContainer = document.getElementById('modal-saved-users');
        const modalCardNumberSpan = document.getElementById('modal-card-number');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        
        // Modal logo elements
        const modalLogoUploadInput = document.getElementById('modal-logo-upload');
        const modalUploadLogoBtn = document.getElementById('modal-upload-logo-btn');
        const saveModalLogoBtn = document.getElementById('save-modal-logo-btn');
        const modalRemoveLogoBtn = document.getElementById('modal-remove-logo-btn');
        const modalUseGlobalLogoBtn = document.getElementById('modal-use-global-logo-btn');
        const modalLogoPreview = document.getElementById('modal-logo-preview');
        const modalDefaultLogoPlaceholder = document.getElementById('modal-default-logo-placeholder');
        const modalSavedLogosContainer = document.getElementById('modal-saved-logos');
        const modalLogoAutocomplete = document.getElementById('modal-logo-autocomplete');
        
        // Save address modal elements
        const saveAddressModalOverlay = document.getElementById('save-address-modal-overlay');
        const saveAddressModalContent = document.getElementById('save-address-modal-content');
        const saveAddressModalCloseBtn = document.getElementById('save-address-modal-close-btn');
        const addressNameInput = document.getElementById('address-name');
        const addressValueInput = document.getElementById('address-value');
        const saveAddressConfirmBtn = document.getElementById('save-address-confirm-btn');
        const saveAddressCancelBtn = document.getElementById('save-address-cancel-btn');
        
        // Save logo modal elements
        const saveLogoModalOverlay = document.getElementById('save-logo-modal-overlay');
        const saveLogoModalContent = document.getElementById('save-logo-modal-content');
        const saveLogoModalCloseBtn = document.getElementById('save-logo-modal-close-btn');
        const logoNameInput = document.getElementById('logo-name');
        const saveLogoPreview = document.getElementById('save-logo-preview');
        const saveLogoConfirmBtn = document.getElementById('save-logo-confirm-btn');
        const saveLogoCancelBtn = document.getElementById('save-logo-cancel-btn');
        
        // Save user modal elements
        const saveUserModalOverlay = document.getElementById('save-user-modal-overlay');
        const saveUserModalContent = document.getElementById('save-user-modal-content');
        const saveUserModalCloseBtn = document.getElementById('save-user-modal-close-btn');
        const userNameInput = document.getElementById('user-name');
        const userValueInput = document.getElementById('user-value');
        const saveUserConfirmBtn = document.getElementById('save-user-confirm-btn');
        const saveUserCancelBtn = document.getElementById('save-user-cancel-btn');
        
        // Grid container
        const appointmentsGrid = document.getElementById('appointments-grid');
        
        // Buttons
        const applyAllBtn = document.getElementById('apply-all-btn');
        const resetAllBtn = document.getElementById('reset-all-btn');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadImageBtn = document.getElementById('download-image-btn');
        const printBtn = document.getElementById('print-btn');
        
        // Store global and individual logo data
        let globalLogoDataURL = null;
        let currentEditingCardIndex = -1;
        let currentLayout = 2; // Default: 2 cards
        let individualLogos = Array(8).fill(null); // Store individual logos for each card
        
        // Store saved addresses, logos, and users
        let savedAddresses = [];
        let savedLogos = [];
        let savedUsers = [];
        let addressToSave = null;
        let logoToSave = null;
        let userToSave = null;
        let addressSaveContext = 'global'; // 'global' or 'modal'
        let logoSaveContext = 'global'; // 'global' or 'modal'
        let userSaveContext = 'global'; // 'global' or 'modal'
        
        // Layout configurations with calculated dimensions
        const layoutConfigs = {
            1: {
                name: "1 Cart√£o",
                layoutClass: "layout-1-card",
                gridCols: 1,
                gridRows: 1,
                cardWidth: 180, // mm
                cardHeight: 200, // mm
                gap: 0, // mm
                margin: 40, // mm
                description: "(1√ó1) Cart√£o √∫nico grande"
            },
            2: {
                name: "2 Cart√µes",
                layoutClass: "layout-2-cards",
                gridCols: 1,
                gridRows: 2,
                cardWidth: 180, // mm
                cardHeight: 120, // mm
                gap: 20, // mm
                margin: 15, // mm
                description: "(1√ó2) Cart√µes grandes"
            },
            4: {
                name: "4 Cart√µes",
                layoutClass: "layout-4-cards",
                gridCols: 2,
                gridRows: 2,
                cardWidth: 90, // mm
                cardHeight: 120, // mm
                gap: 10, // mm
                margin: 15, // mm
                description: "(2√ó2) Cart√µes m√©dios"
            },
            6: {
                name: "6 Cart√µes",
                layoutClass: "layout-6-cards",
                gridCols: 2,
                gridRows: 3,
                cardWidth: 90, // mm
                cardHeight: 80, // mm
                gap: 8, // mm
                margin: 15, // mm
                description: "(2√ó3) Cart√µes compactos"
            },
            8: {
                name: "8 Cart√µes",
                layoutClass: "layout-8-cards",
                gridCols: 2,
                gridRows: 4,
                cardWidth: 90, // mm
                cardHeight: 65, // mm
                gap: 5, // mm
                margin: 15, // mm
                description: "(2√ó4) Cart√µes padr√£o"
            }
        };
        
        // Default data for cards
        const defaultCardData = {
            pacient: "Alex Silva",
            hospital: "Santa B√°rbara",
            speciality: "otorrinolaringologista",
            date: new Date().toLocaleDateString('en-GB').replace(/\//g, '/'),
            hour: "08:00",
            address: "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA"
        };
        
        // Store individual card data (max 8 cards)
        let cardData = Array(8).fill(null).map(() => ({...defaultCardData}));
        
        // Show feedback message
        function showFeedback(message, type = 'info') {
            // Remove any existing feedback
            const existingFeedback = document.querySelector('.feedback-message');
            if (existingFeedback) {
                existingFeedback.remove();
            }
            
            // Create feedback element
            const feedback = document.createElement('div');
            feedback.className = `feedback-message feedback-${type}`;
            feedback.textContent = message;
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 9999;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 300px;
            `;
            
            // Set color based on type
            if (type === 'success') {
                feedback.style.backgroundColor = '#28a745';
            } else if (type === 'error') {
                feedback.style.backgroundColor = '#dc3545';
            } else if (type === 'warning') {
                feedback.style.backgroundColor = '#ffc107';
                feedback.style.color = '#212529';
            } else {
                feedback.style.backgroundColor = '#1a5f7a';
            }
            
            document.body.appendChild(feedback);
            
            // Remove after animation
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.remove();
                }
            }, 3000);
        }
        
        // Helper function to set button loading state
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.dataset.originalText = button.textContent;
                button.innerHTML = '<span class="button-spinner">‚è≥</span> Processing...';
                button.disabled = true;
            } else {
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
                button.disabled = false;
            }
        }
        
        // Load saved addresses from localStorage
        function loadSavedAddresses() {
            const saved = localStorage.getItem('medicalAppointmentAddresses');
            if (saved) {
                savedAddresses = JSON.parse(saved);
            } else {
                // Add some default addresses
                savedAddresses = [
                    { id: 1, name: "Cl√≠nica Santa B√°rbara", address: "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA, 40285-000" },
                    { id: 2, name: "Hospital Geral", address: "Rua do Salete, 100 - Barris, Salvador - BA, 40070-000" },
                    { id: 3, name: "Centro M√©dico", address: "Av. Tancredo Neves, 3133 - Caminho das √Årvores, Salvador - BA, 41820-020" }
                ];
                saveAddressesToStorage();
            }
            renderSavedAddresses();
        }
        
        // Load saved logos from localStorage
        function loadSavedLogos() {
            const saved = localStorage.getItem('medicalAppointmentLogos');
            if (saved) {
                savedLogos = JSON.parse(saved);
            } else {
                // Add some default logos (empty array - user will add their own)
                savedLogos = [];
                saveLogosToStorage();
            }
            renderSavedLogos();
        }
        
        // Load saved users from localStorage
        function loadSavedUsers() {
            const saved = localStorage.getItem('medicalAppointmentUsers');
            if (saved) {
                savedUsers = JSON.parse(saved);
            } else {
                // Add some default users
                savedUsers = [
                    { id: 1, name: "Alex Silva", fullName: "Alex Silva" },
                    { id: 2, name: "Maria Santos", fullName: "Maria Santos" },
                    { id: 3, name: "Jo√£o Pereira", fullName: "Jo√£o Pereira" },
                    { id: 4, name: "Ana Oliveira", fullName: "Ana Oliveira" }
                ];
                saveUsersToStorage();
            }
            renderSavedUsers();
        }
        
        // Save addresses to localStorage
        function saveAddressesToStorage() {
            localStorage.setItem('medicalAppointmentAddresses', JSON.stringify(savedAddresses));
        }
        
        // Save logos to localStorage
        function saveLogosToStorage() {
            localStorage.setItem('medicalAppointmentLogos', JSON.stringify(savedLogos));
        }
        
        // Save users to localStorage
        function saveUsersToStorage() {
            localStorage.setItem('medicalAppointmentUsers', JSON.stringify(savedUsers));
        }
        
        // Render saved addresses in a container
        function renderSavedAddresses(container = null, onClickCallback = null) {
            const containers = container ? [container] : [globalSavedAddressesContainer, modalSavedAddressesContainer];
            
            containers.forEach(container => {
                if (!container) return;
                
                if (savedAddresses.length === 0) {
                    container.innerHTML = '<div class="no-addresses" id="no-addresses">' + translations[currentLanguage]['no-addresses'] + '</div>';
                    return;
                }
                
                let html = '';
                savedAddresses.forEach(address => {
                    html += `
                        <div class="saved-address-item" data-address-id="${address.id}">
                            <div class="address-info">
                                <div class="address-label">${address.name}</div>
                                <div class="address-text">${address.address}</div>
                            </div>
                            <div class="address-actions">
                                <button class="address-action-btn use-btn" title="Usar este endere√ßo">üìã</button>
                                <button class="address-action-btn delete-btn" title="Excluir endere√ßo">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Add event listeners
                container.querySelectorAll('.use-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const addressId = parseInt(this.closest('.saved-address-item').dataset.addressId);
                        const address = savedAddresses.find(a => a.id === addressId);
                        if (address && onClickCallback) {
                            onClickCallback(address.address);
                        } else if (address) {
                            // Default behavior: fill the input
                            if (container === globalSavedAddressesContainer) {
                                globalAddressInput.value = address.address;
                                hideAutocomplete(globalAddressAutocomplete);
                            } else if (container === modalSavedAddressesContainer) {
                                modalAddressInput.value = address.address;
                                hideAutocomplete(modalAddressAutocomplete);
                            }
                        }
                    });
                });
                
                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const addressId = parseInt(this.closest('.saved-address-item').dataset.addressId);
                        deleteAddress(addressId);
                    });
                });
                
                container.querySelectorAll('.saved-address-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.closest('.address-actions')) {
                            const addressId = parseInt(this.dataset.addressId);
                            const address = savedAddresses.find(a => a.id === addressId);
                            if (address && onClickCallback) {
                                onClickCallback(address.address);
                            } else if (address) {
                                // Default behavior: fill the input
                                if (container === globalSavedAddressesContainer) {
                                    globalAddressInput.value = address.address;
                                    hideAutocomplete(globalAddressAutocomplete);
                                } else if (container === modalSavedAddressesContainer) {
                                    modalAddressInput.value = address.address;
                                    hideAutocomplete(modalAddressAutocomplete);
                                }
                            }
                        }
                    });
                });
            });
        }
        
        // Render saved logos in a container
        function renderSavedLogos(container = null, onClickCallback = null) {
            const containers = container ? [container] : [globalSavedLogosContainer, modalSavedLogosContainer];
            
            containers.forEach(container => {
                if (!container) return;
                
                if (savedLogos.length === 0) {
                    container.innerHTML = '<div class="no-logos" id="no-logos">' + translations[currentLanguage]['no-logos'] + '</div>';
                    return;
                }
                
                let html = '';
                savedLogos.forEach(logo => {
                    html += `
                        <div class="saved-logo-item" data-logo-id="${logo.id}">
                            <div class="logo-info" style="display: flex; align-items: center; gap: 10px;">
                                <img src="${logo.dataURL}" class="logo-preview-small" alt="${logo.name}">
                                <div>
                                    <div class="logo-label">${logo.name}</div>
                                </div>
                            </div>
                            <div class="logo-actions">
                                <button class="logo-action-btn use-btn" title="Usar este logo">üìã</button>
                                <button class="logo-action-btn delete-btn" title="Excluir logo">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Add event listeners
                container.querySelectorAll('.use-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const logoId = parseInt(this.closest('.saved-logo-item').dataset.logoId);
                        const logo = savedLogos.find(l => l.id === logoId);
                        if (logo && onClickCallback) {
                            onClickCallback(logo.dataURL);
                        } else if (logo) {
                            // Default behavior: set the logo
                            if (container === globalSavedLogosContainer) {
                                setGlobalLogo(logo.dataURL);
                            } else if (container === modalSavedLogosContainer && currentEditingCardIndex !== -1) {
                                setModalLogo(logo.dataURL);
                            }
                        }
                    });
                });
                
                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const logoId = parseInt(this.closest('.saved-logo-item').dataset.logoId);
                        deleteLogo(logoId);
                    });
                });
                
                container.querySelectorAll('.saved-logo-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.closest('.logo-actions')) {
                            const logoId = parseInt(this.dataset.logoId);
                            const logo = savedLogos.find(l => l.id === logoId);
                            if (logo && onClickCallback) {
                                onClickCallback(logo.dataURL);
                            } else if (logo) {
                                // Default behavior: set the logo
                                if (container === globalSavedLogosContainer) {
                                    setGlobalLogo(logo.dataURL);
                                } else if (container === modalSavedLogosContainer && currentEditingCardIndex !== -1) {
                                    setModalLogo(logo.dataURL);
                                }
                            }
                        }
                    });
                });
            });
        }
        
        // Render saved users in a container
        function renderSavedUsers(container = null, onClickCallback = null) {
            const containers = container ? [container] : [globalSavedUsersContainer, modalSavedUsersContainer];
            
            containers.forEach(container => {
                if (!container) return;
                
                if (savedUsers.length === 0) {
                    container.innerHTML = '<div class="no-users" id="no-users">' + translations[currentLanguage]['no-users'] + '</div>';
                    return;
                }
                
                let html = '';
                savedUsers.forEach(user => {
                    html += `
                        <div class="saved-user-item" data-user-id="${user.id}">
                            <div class="user-info">
                                <div class="user-label">${user.name}</div>
                                <div class="user-text">${user.fullName}</div>
                            </div>
                            <div class="user-actions">
                                <button class="user-action-btn use-btn" title="Usar este nome">üìã</button>
                                <button class="user-action-btn delete-btn" title="Excluir nome">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Add event listeners
                container.querySelectorAll('.use-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const userId = parseInt(this.closest('.saved-user-item').dataset.userId);
                        const user = savedUsers.find(u => u.id === userId);
                        if (user && onClickCallback) {
                            onClickCallback(user.fullName);
                        } else if (user) {
                            // Default behavior: fill the input
                            if (container === globalSavedUsersContainer) {
                                globalPacientInput.value = user.fullName;
                                hideAutocomplete(globalUserAutocomplete);
                            } else if (container === modalSavedUsersContainer) {
                                modalPacientInput.value = user.fullName;
                                hideAutocomplete(modalUserAutocomplete);
                            }
                        }
                    });
                });
                
                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const userId = parseInt(this.closest('.saved-user-item').dataset.userId);
                        deleteUser(userId);
                    });
                });
                
                container.querySelectorAll('.saved-user-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (!e.target.closest('.user-actions')) {
                            const userId = parseInt(this.dataset.userId);
                            const user = savedUsers.find(u => u.id === userId);
                            if (user && onClickCallback) {
                                onClickCallback(user.fullName);
                            } else if (user) {
                                // Default behavior: fill the input
                                if (container === globalSavedUsersContainer) {
                                    globalPacientInput.value = user.fullName;
                                    hideAutocomplete(globalUserAutocomplete);
                                } else if (container === modalSavedUsersContainer) {
                                    modalPacientInput.value = user.fullName;
                                    hideAutocomplete(modalUserAutocomplete);
                                }
                            }
                        }
                    });
                });
            });
        }
        
        // Show autocomplete suggestions for addresses
        function showAddressAutocompleteSuggestions(input, autocompleteContainer, addresses) {
            const query = input.value.toLowerCase();
            if (query.length < 2) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            const suggestions = savedAddresses.filter(address => 
                address.name.toLowerCase().includes(query) || 
                address.address.toLowerCase().includes(query)
            );
            
            if (suggestions.length === 0) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            let html = '';
            suggestions.forEach(address => {
                html += `
                    <div class="address-suggestion" data-address="${address.address}">
                        <div class="address-name">${address.name}</div>
                        <div class="address-value">${address.address}</div>
                    </div>
                `;
            });
            
            autocompleteContainer.innerHTML = html;
            autocompleteContainer.style.display = 'block';
            
            // Add event listeners to suggestions
            autocompleteContainer.querySelectorAll('.address-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const address = this.dataset.address;
                    input.value = address;
                    hideAutocomplete(autocompleteContainer);
                    input.focus();
                });
            });
        }
        
        // Show autocomplete suggestions for logos
        function showLogoAutocompleteSuggestions(input, autocompleteContainer, logos) {
            const query = input ? input.value.toLowerCase() : '';
            if (query.length < 1) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            const suggestions = savedLogos.filter(logo => 
                logo.name.toLowerCase().includes(query)
            );
            
            if (suggestions.length === 0) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            let html = '';
            suggestions.forEach(logo => {
                html += `
                    <div class="logo-suggestion" data-logo-url="${logo.dataURL}">
                        <img src="${logo.dataURL}" class="logo-preview-img" alt="${logo.name}">
                        <div class="logo-info">
                            <div class="logo-name">${logo.name}</div>
                        </div>
                    </div>
                `;
            });
            
            autocompleteContainer.innerHTML = html;
            autocompleteContainer.style.display = 'block';
            
            // Add event listeners to suggestions
            autocompleteContainer.querySelectorAll('.logo-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const logoDataURL = this.dataset.logoUrl;
                    if (autocompleteContainer === globalLogoAutocomplete) {
                        setGlobalLogo(logoDataURL);
                    } else if (autocompleteContainer === modalLogoAutocomplete && currentEditingCardIndex !== -1) {
                        setModalLogo(logoDataURL);
                    }
                    hideAutocomplete(autocompleteContainer);
                });
            });
        }
        
        // Show autocomplete suggestions for users
        function showUserAutocompleteSuggestions(input, autocompleteContainer, users) {
            const query = input.value.toLowerCase();
            if (query.length < 2) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            const suggestions = savedUsers.filter(user => 
                user.name.toLowerCase().includes(query) || 
                user.fullName.toLowerCase().includes(query)
            );
            
            if (suggestions.length === 0) {
                hideAutocomplete(autocompleteContainer);
                return;
            }
            
            let html = '';
            suggestions.forEach(user => {
                html += `
                    <div class="user-suggestion" data-user="${user.fullName}">
                        <div class="user-name">${user.name}</div>
                        <div class="user-value">${user.fullName}</div>
                    </div>
                `;
            });
            
            autocompleteContainer.innerHTML = html;
            autocompleteContainer.style.display = 'block';
            
            // Add event listeners to suggestions
            autocompleteContainer.querySelectorAll('.user-suggestion').forEach(suggestion => {
                suggestion.addEventListener('click', function() {
                    const user = this.dataset.user;
                    input.value = user;
                    hideAutocomplete(autocompleteContainer);
                    input.focus();
                });
            });
        }
        
        // Hide autocomplete
        function hideAutocomplete(autocompleteContainer) {
            autocompleteContainer.style.display = 'none';
        }
        
        // Open save address modal
        function openSaveAddressModal(address, context) {
            addressToSave = address;
            addressSaveContext = context;
            addressNameInput.value = '';
            addressValueInput.value = address;
            
            // Generate a default name based on the address
            const parts = address.split(',');
            if (parts.length > 0) {
                addressNameInput.value = parts[0].trim();
            }
            
            saveAddressModalOverlay.style.display = 'flex';
            addressNameInput.focus();
            
            // Add ESC key listener
            document.addEventListener('keydown', handleSaveAddressEscKey);
        }
        
        // Open save logo modal
        function openSaveLogoModal(logoDataURL, context) {
            logoToSave = logoDataURL;
            logoSaveContext = context;
            logoNameInput.value = '';
            saveLogoPreview.src = logoDataURL;
            
            // Generate a default name
            if (context === 'global' && globalHospitalInput.value) {
                logoNameInput.value = `Logo ${globalHospitalInput.value}`;
            } else if (context === 'modal' && modalHospitalInput.value) {
                logoNameInput.value = `Logo ${modalHospitalInput.value}`;
            } else {
                logoNameInput.value = 'My Logo';
            }
            
            saveLogoModalOverlay.style.display = 'flex';
            logoNameInput.focus();
            
            // Add ESC key listener
            document.addEventListener('keydown', handleSaveLogoEscKey);
        }
        
        // Open save user modal
        function openSaveUserModal(user, context) {
            userToSave = user;
            userSaveContext = context;
            userNameInput.value = '';
            userValueInput.value = user;
            
            // Generate a default name based on the user
            const parts = user.split(' ');
            if (parts.length > 0) {
                userNameInput.value = user;
            }
            
            saveUserModalOverlay.style.display = 'flex';
            userNameInput.focus();
            
            // Add ESC key listener
            document.addEventListener('keydown', handleSaveUserEscKey);
        }
        
        // Close save address modal
        function closeSaveAddressModal() {
            saveAddressModalOverlay.style.display = 'none';
            addressToSave = null;
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleSaveAddressEscKey);
        }
        
        // Close save logo modal
        function closeSaveLogoModal() {
            saveLogoModalOverlay.style.display = 'none';
            logoToSave = null;
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleSaveLogoEscKey);
        }
        
        // Close save user modal
        function closeSaveUserModal() {
            saveUserModalOverlay.style.display = 'none';
            userToSave = null;
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleSaveUserEscKey);
        }
        
        // Handle ESC key for save address modal
        function handleSaveAddressEscKey(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                closeSaveAddressModal();
            }
        }
        
        // Handle ESC key for save logo modal
        function handleSaveLogoEscKey(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                closeSaveLogoModal();
            }
        }
        
        // Handle ESC key for save user modal
        function handleSaveUserEscKey(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                closeSaveUserModal();
            }
        }
        
        // Save new address
        function saveNewAddress(name, address) {
            if (!name.trim() || !address.trim()) {
                showFeedback('Please provide a valid name and address.', 'error');
                return;
            }
            
            // Check if address already exists
            const existingAddress = savedAddresses.find(a => 
                a.name.toLowerCase() === name.toLowerCase() || 
                a.address.toLowerCase() === address.toLowerCase()
            );
            
            if (existingAddress) {
                showFeedback('This address is already saved.', 'warning');
                return;
            }
            
            // Generate new ID
            const newId = savedAddresses.length > 0 ? Math.max(...savedAddresses.map(a => a.id)) + 1 : 1;
            
            // Add new address
            savedAddresses.push({
                id: newId,
                name: name.trim(),
                address: address.trim()
            });
            
            // Save to localStorage
            saveAddressesToStorage();
            
            // Re-render addresses
            renderSavedAddresses();
            
            // Close modal
            closeSaveAddressModal();
            
            // Show success message
            showFeedback(`Address "${name}" saved successfully!`, 'success');
        }
        
        // Save new logo
        function saveNewLogo(name, logoDataURL) {
            if (!name.trim() || !logoDataURL) {
                showFeedback('Please provide a valid name and logo.', 'error');
                return;
            }
            
            // Check if logo with same name already exists
            const existingLogo = savedLogos.find(l => 
                l.name.toLowerCase() === name.toLowerCase()
            );
            
            if (existingLogo) {
                showFeedback('A logo with this name already exists. Please use a different name.', 'warning');
                return;
            }
            
            // Generate new ID
            const newId = savedLogos.length > 0 ? Math.max(...savedLogos.map(l => l.id)) + 1 : 1;
            
            // Add new logo
            savedLogos.push({
                id: newId,
                name: name.trim(),
                dataURL: logoDataURL
            });
            
            // Save to localStorage
            saveLogosToStorage();
            
            // Re-render logos
            renderSavedLogos();
            
            // Close modal
            closeSaveLogoModal();
            
            // Show success message
            showFeedback(`Logo "${name}" saved successfully!`, 'success');
        }
        
        // Save new user
        function saveNewUser(name, fullName) {
            if (!name.trim() || !fullName.trim()) {
                showFeedback('Please provide a valid name and full name.', 'error');
                return;
            }
            
            // Check if user already exists
            const existingUser = savedUsers.find(u => 
                u.name.toLowerCase() === name.toLowerCase() || 
                u.fullName.toLowerCase() === fullName.toLowerCase()
            );
            
            if (existingUser) {
                showFeedback('This name is already saved.', 'warning');
                return;
            }
            
            // Generate new ID
            const newId = savedUsers.length > 0 ? Math.max(...savedUsers.map(u => u.id)) + 1 : 1;
            
            // Add new user
            savedUsers.push({
                id: newId,
                name: name.trim(),
                fullName: fullName.trim()
            });
            
            // Save to localStorage
            saveUsersToStorage();
            
            // Re-render users
            renderSavedUsers();
            
            // Close modal
            closeSaveUserModal();
            
            // Show success message
            showFeedback(`Name "${name}" saved successfully!`, 'success');
        }
        
        // Delete address
        function deleteAddress(addressId) {
            if (confirm('Are you sure you want to delete this saved address?')) {
                savedAddresses = savedAddresses.filter(a => a.id !== addressId);
                saveAddressesToStorage();
                renderSavedAddresses();
                showFeedback('Address deleted successfully!', 'success');
            }
        }
        
        // Delete logo
        function deleteLogo(logoId) {
            if (confirm('Are you sure you want to delete this saved logo?')) {
                savedLogos = savedLogos.filter(l => l.id !== logoId);
                saveLogosToStorage();
                renderSavedLogos();
                showFeedback('Logo deleted successfully!', 'success');
            }
        }
        
        // Delete user
        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this saved name?')) {
                savedUsers = savedUsers.filter(u => u.id !== userId);
                saveUsersToStorage();
                renderSavedUsers();
                showFeedback('Name deleted successfully!', 'success');
            }
        }
        
        // Clear all addresses
        function clearAllAddresses() {
            if (savedAddresses.length === 0) {
                showFeedback('There are no addresses to clear.', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL saved addresses?')) {
                savedAddresses = [];
                saveAddressesToStorage();
                renderSavedAddresses();
                showFeedback('All addresses have been deleted!', 'success');
            }
        }
        
        // Clear all logos
        function clearAllLogos() {
            if (savedLogos.length === 0) {
                showFeedback('There are no logos to clear.', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL saved logos?')) {
                savedLogos = [];
                saveLogosToStorage();
                renderSavedLogos();
                showFeedback('All logos have been deleted!', 'success');
            }
        }
        
        // Clear all users
        function clearAllUsers() {
            if (savedUsers.length === 0) {
                showFeedback('There are no names to clear.', 'warning');
                return;
            }
            
            if (confirm('Are you sure you want to delete ALL saved names?')) {
                savedUsers = [];
                saveUsersToStorage();
                renderSavedUsers();
                showFeedback('All names have been deleted!', 'success');
            }
        }
        
        // Set global logo
        function setGlobalLogo(logoDataURL) {
            globalLogoDataURL = logoDataURL;
            
            // Show preview
            globalLogoPreview.src = logoDataURL;
            globalLogoPreview.classList.remove('hidden');
            defaultLogoPlaceholder.classList.add('hidden');
            
            // Show remove button
            removeGlobalLogoBtn.classList.remove('hidden');
            
            // Update all cards that don't have individual logos
            for (let i = 0; i < currentLayout; i++) {
                if (individualLogos[i] === null) {
                    updateCardLogo(i, globalLogoDataURL, false);
                }
            }
        }
        
        // Set modal logo (for individual card)
        function setModalLogo(logoDataURL) {
            if (currentEditingCardIndex === -1) return;
            
            // Store individual logo for current card
            individualLogos[currentEditingCardIndex] = logoDataURL;
            
            // Update modal preview
            modalLogoPreview.src = logoDataURL;
            modalLogoPreview.classList.remove('hidden');
            modalDefaultLogoPlaceholder.classList.add('hidden');
            modalRemoveLogoBtn.classList.remove('hidden');
            
            // Update card logo immediately
            updateCardLogo(currentEditingCardIndex, logoDataURL, true);
        }
        
        // Update paper info based on selected layout
        function updatePaperInfo() {
            const config = layoutConfigs[currentLayout];
            const t = translations[currentLanguage];
            
            paperInfo.innerHTML = `
                <h4>üìÑ A4 Sheet - ${config.name}</h4>
                <ul>
                    <li><strong>Layout:</strong> ${config.gridCols} column(s) √ó ${config.gridRows} row(s)</li>
                    <li><strong>Card size:</strong> ${config.cardWidth}mm √ó ${config.cardHeight}mm</li>
                    <li><strong>Margins:</strong> ${config.margin}mm on all edges</li>
                    ${config.gap > 0 ? `<li><strong>Spacing:</strong> ${config.gap}mm between cards</li>` : ''}
                    <li><strong>Description:</strong> ${config.description}</li>
                </ul>
                <p><strong>Instruction:</strong> Print in "Fit to page" mode for best results.</p>
            `;
            
            updateLayoutInfo();
        }
        
        // Format date from YYYY-MM-DD to DD/MM/YYYY
        function formatDate(dateString) {
            if (!dateString) return '';
            // Check if already in DD/MM/YYYY format
            if (dateString.includes('/')) {
                return dateString;
            }
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }
        
        // Format date from DD/MM/YYYY to YYYY-MM-DD
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            if (dateString.includes('-')) {
                return dateString;
            }
            const [day, month, year] = dateString.split('/');
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        }
        
        // Format time from HH:MM to HH:MM
        function formatTime(timeString) {
            if (!timeString) return '';
            return timeString;
        }
        
        // Truncate text based on layout
        function truncateText(text, layout) {
            const maxLengths = {
                1: 120, // 1 card - largest
                2: 80,  // 2 cards - larger
                4: 60,  // 4 cards - medium
                6: 50,  // 6 cards - compact
                8: 40   // 8 cards - smallest
            };
            
            const maxLength = maxLengths[layout] || 50;
            
            // Don't truncate dates (they follow DD/MM/YYYY format)
            if (text.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return text;
            }
            
            if (text.length > maxLength) {
                return text.substring(0, maxLength - 3) + '...';
            }
            return text;
        }
        
        // Generate appointment cards based on selected layout
        function generateAppointments() {
            // Clear the grid first
            appointmentsGrid.innerHTML = '';
            
            // Update grid layout class
            const config = layoutConfigs[currentLayout];
            appointmentsGrid.className = `appointments-grid ${config.layoutClass}`;
            
            // Get translations for current language
            const t = translations[currentLanguage];
            
            // Create cards based on current layout
            for (let i = 0; i < currentLayout; i++) {
                const data = cardData[i];
                const card = document.createElement('div');
                card.className = 'appointment-card';
                card.id = `appointment-card-${i}`;
                card.dataset.index = i;
                
                // Determine which logo to show (individual or global)
                const individualLogo = individualLogos[i];
                const showIndividualLogo = individualLogo !== null;
                const logoDataURL = showIndividualLogo ? individualLogo : globalLogoDataURL;
                
                let logoHTML = '';
                if (logoDataURL) {
                    logoHTML = `
                        <img id="card-logo-${i}" class="card-logo" src="${logoDataURL}" alt="Logo">
                        ${showIndividualLogo ? '<div class="logo-badge">‚úì</div>' : ''}
                    `;
                } else {
                    logoHTML = `<div id="card-default-placeholder-${i}" class="default-logo-placeholder">
                        <div class="logo-icon">üè•</div>
                        <div>${t['no-logo-text']}</div>
                        <small>${t['click-add-logo']}</small>
                    </div>`;
                }
                
                // Truncate text based on layout
                const truncatedAddress = truncateText(data.address, currentLayout);
                const truncatedPacient = truncateText(data.pacient, currentLayout);
                const truncatedHospital = truncateText(data.hospital, currentLayout);
                
                // Translate specialty
                const translatedSpecialty = t[data.speciality] || data.speciality;
                
                card.innerHTML = `
                    <div class="card-number">${i + 1}</div>
                    <div class="card-header">
                        <div class="card-logo-container" data-card-index="${i}">
                            ${logoHTML}
                        </div>
                        <div class="hospital-name" id="card-hospital-${i}">${truncatedHospital}</div>
                    </div>
                    
                    <div class="card-title">${t['card-title']}</div>
                    
                    <div class="appointment-details">
                        <div class="detail-row">
                            <span class="detail-label">${t['name-label']}:</span>
                            <span class="detail-value" id="card-pacient-${i}">${truncatedPacient}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${t['clinic-label']}:</span>
                            <span class="detail-value" id="card-clinic-${i}">${truncatedHospital}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${t['speciality-label-card']}:</span>
                            <span class="detail-value" id="card-speciality-${i}">${translatedSpecialty}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${t['date-label']}:</span>
                            <span class="detail-value date-value" id="card-date-${i}">${data.date}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${t['time-label']}:</span>
                            <span class="detail-value" id="card-hour-${i}">${data.hour}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">${t['location-label']}:</span>
                            <span class="detail-value" id="card-address-${i}">${truncatedAddress}</span>
                        </div>
                    </div>
                    
                    <div class="card-footer">
                        <p>${t['card-footer']}</p>
                    </div>
                    
                    <div class="watermark">${t['watermark']}</div>
                `;
                
                // Add click event for editing card text
                card.addEventListener('click', function(e) {
                    // Don't open modal if clicking on logo container (handled separately)
                    if (!e.target.closest('.card-logo-container')) {
                        const index = parseInt(this.dataset.index);
                        openEditModal(index);
                    }
                });
                
                // Add click event for logo container (individual logo editing)
                const logoContainer = card.querySelector('.card-logo-container');
                logoContainer.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent card click from firing
                    const index = parseInt(this.dataset.cardIndex);
                    openLogoUpload(index, this);
                });
                
                appointmentsGrid.appendChild(card);
            }
        }
        
        // Open logo upload for specific card
        function openLogoUpload(cardIndex, logoContainer) {
            // Create a file input dialog
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            fileInput.addEventListener('change', function() {
                if (this.files && this.files[0]) {
                    const file = this.files[0];
                    
                    // Check if file is an image
                    if (!file.type.match('image.*')) {
                        showFeedback('Please select an image file (JPG, PNG, etc.)', 'error');
                        return;
                    }
                    
                    // Check file size (limit to 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        showFeedback('Image must be less than 5MB', 'error');
                        return;
                    }
                    
                    showFeedback('Loading image...', 'info');
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Store individual logo for this card
                        individualLogos[cardIndex] = e.target.result;
                        
                        // Update the card's logo
                        updateCardLogo(cardIndex, e.target.result, true);
                        showFeedback('Individual logo loaded successfully!', 'success');
                    };
                    
                    reader.onerror = function() {
                        showFeedback('Error reading file. Please try again.', 'error');
                    };
                    
                    reader.readAsDataURL(file);
                }
                
                // Clean up
                document.body.removeChild(fileInput);
            });
            
            // Trigger file selection
            document.body.appendChild(fileInput);
            fileInput.click();
        }
        
        // Update specific card's logo
        function updateCardLogo(cardIndex, logoDataURL, isIndividual = true) {
            const card = document.getElementById(`appointment-card-${cardIndex}`);
            if (!card) return;
            
            const logoContainer = card.querySelector('.card-logo-container');
            if (!logoContainer) return;
            
            // Clear logo container
            logoContainer.innerHTML = '';
            
            // Add new logo
            if (logoDataURL) {
                const img = document.createElement('img');
                img.className = 'card-logo';
                img.src = logoDataURL;
                img.alt = 'Logo';
                logoContainer.appendChild(img);
                
                // Add badge if it's an individual logo
                if (isIndividual) {
                    const badge = document.createElement('div');
                    badge.className = 'logo-badge';
                    badge.textContent = '‚úì';
                    logoContainer.appendChild(badge);
                }
            } else {
                const t = translations[currentLanguage];
                // Add default placeholder
                const placeholder = document.createElement('div');
                placeholder.className = 'default-logo-placeholder';
                placeholder.innerHTML = `
                    <div class="logo-icon">üè•</div>
                    <div>${t['no-logo-text']}</div>
                    <small>${t['click-add-logo']}</small>
                `;
                logoContainer.appendChild(placeholder);
                
                // Add click event to placeholder
                placeholder.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openLogoUpload(cardIndex, logoContainer);
                });
            }
            
            // Re-add click event to logo container
            logoContainer.addEventListener('click', function(e) {
                e.stopPropagation();
                openLogoUpload(cardIndex, this);
            });
        }
        
        // Open edit modal
        function openEditModal(index) {
            currentEditingCardIndex = index;
            const data = cardData[index];
            
            // Remove editing class from all cards
            document.querySelectorAll('.appointment-card').forEach(card => {
                card.classList.remove('editing');
            });
            
            // Add editing class to current card
            const currentCard = document.getElementById(`appointment-card-${index}`);
            if (currentCard) {
                currentCard.classList.add('editing');
            }
            
            // Update modal with current data
            modalCardNumberSpan.textContent = index + 1;
            modalPacientInput.value = data.pacient;
            modalHospitalInput.value = data.hospital;
            modalSpecialityInput.value = data.speciality;
            modalDateInput.value = formatDateForInput(data.date);
            modalHourInput.value = data.hour;
            modalAddressInput.value = data.address;
            
            // Update modal logo preview
            const individualLogo = individualLogos[index];
            if (individualLogo) {
                modalLogoPreview.src = individualLogo;
                modalLogoPreview.classList.remove('hidden');
                modalDefaultLogoPlaceholder.classList.add('hidden');
                modalRemoveLogoBtn.classList.remove('hidden');
            } else {
                modalLogoPreview.classList.add('hidden');
                modalDefaultLogoPlaceholder.classList.remove('hidden');
                modalRemoveLogoBtn.classList.add('hidden');
            }
            
            // Render saved addresses in modal
            renderSavedAddresses(modalSavedAddressesContainer, (address) => {
                modalAddressInput.value = address;
                hideAutocomplete(modalAddressAutocomplete);
            });
            
            // Render saved logos in modal
            renderSavedLogos(modalSavedLogosContainer, (logoDataURL) => {
                setModalLogo(logoDataURL);
            });
            
            // Render saved users in modal
            renderSavedUsers(modalSavedUsersContainer, (user) => {
                modalPacientInput.value = user;
                hideAutocomplete(modalUserAutocomplete);
            });
            
            // Show modal
            modalOverlay.style.display = 'flex';
            
            // Focus on first input
            setTimeout(() => {
                modalPacientInput.focus();
            }, 100);
            
            // Add ESC key listener
            document.addEventListener('keydown', handleEscKey);
            // Add Enter key listeners to all modal fields
            setupModalEnterKeyListeners();
        }
        
        // Setup Enter key listeners for modal fields
        function setupModalEnterKeyListeners() {
            // Remove existing listeners first
            removeModalEnterKeyListeners();
            
            // Add Enter key listener to each input field
            const modalInputs = [
                modalPacientInput,
                modalHospitalInput,
                modalSpecialityInput,
                modalDateInput,
                modalHourInput,
                modalAddressInput
            ];
            
            modalInputs.forEach(input => {
                input.addEventListener('keydown', handleModalInputEnterKey);
            });
        }
        
        // Remove Enter key listeners
        function removeModalEnterKeyListeners() {
            const modalInputs = [
                modalPacientInput,
                modalHospitalInput,
                modalSpecialityInput,
                modalDateInput,
                modalHourInput,
                modalAddressInput
            ];
            
            modalInputs.forEach(input => {
                input.removeEventListener('keydown', handleModalInputEnterKey);
            });
        }
        
        // Handle Enter key in modal input fields
        function handleModalInputEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveCardChanges();
            }
        }
        
        // Handle ESC key press
        function handleEscKey(event) {
            if (event.key === 'Escape' || event.key === 'Esc') {
                closeEditModal();
            }
        }
        
        // Save changes from modal
        function saveCardChanges() {
            if (currentEditingCardIndex === -1) return;
            
            // Update card data
            cardData[currentEditingCardIndex] = {
                pacient: modalPacientInput.value || "Not provided",
                hospital: modalHospitalInput.value || "Not provided",
                speciality: modalSpecialityInput.value || "Not provided",
                date: formatDate(modalDateInput.value) || "Not provided",
                hour: modalHourInput.value || "Not provided",
                address: modalAddressInput.value || "Not provided"
            };
            
            // Update the specific card
            updateCardDisplay(currentEditingCardIndex);
            
            // Close modal
            closeEditModal();
            
            // Show feedback
            showFeedback(`Card ${currentEditingCardIndex + 1} updated successfully!`, 'success');
        }
        
        // Update specific card display
        function updateCardDisplay(index) {
            const data = cardData[index];
            const card = document.getElementById(`appointment-card-${index}`);
            const t = translations[currentLanguage];
            
            if (card) {
                // Truncate text based on layout
                const truncatedAddress = truncateText(data.address, currentLayout);
                const truncatedPacient = truncateText(data.pacient, currentLayout);
                const truncatedHospital = truncateText(data.hospital, currentLayout);
                
                // Translate specialty
                const translatedSpecialty = t[data.speciality] || data.speciality;
                
                // Update card content
                document.getElementById(`card-pacient-${index}`).textContent = truncatedPacient;
                document.getElementById(`card-hospital-${index}`).textContent = truncatedHospital;
                document.getElementById(`card-clinic-${index}`).textContent = truncatedHospital;
                document.getElementById(`card-speciality-${index}`).textContent = translatedSpecialty;
                document.getElementById(`card-date-${index}`).textContent = data.date;
                document.getElementById(`card-hour-${index}`).textContent = data.hour;
                document.getElementById(`card-address-${index}`).textContent = truncatedAddress;
            }
        }
        
        // Close edit modal
        function closeEditModal() {
            modalOverlay.style.display = 'none';
            currentEditingCardIndex = -1;
            
            // Remove editing class from all cards
            document.querySelectorAll('.appointment-card').forEach(card => {
                card.classList.remove('editing');
            });
            
            // Remove ESC key listener
            document.removeEventListener('keydown', handleEscKey);
            // Remove Enter key listeners
            removeModalEnterKeyListeners();
        }
        
        // Apply settings to all cards
        function applyToAllCards() {
            const pacient = globalPacientInput.value || "Alex Silva";
            const hospital = globalHospitalInput.value || "Santa B√°rbara";
            const speciality = globalSpecialityInput.value || "otorrinolaringologista";
            const address = globalAddressInput.value || "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA";
            
            // Update all card data
            for (let i = 0; i < currentLayout; i++) {
                cardData[i].pacient = pacient;
                cardData[i].hospital = hospital;
                cardData[i].speciality = speciality;
                cardData[i].address = address;
            }
            
            // Regenerate all cards
            generateAppointments();
            
            // Show feedback
            showFeedback(`Settings applied to ${currentLayout} card(s)!`, 'success');
        }
        
        // Reset all cards to default
        function resetAllCards() {
            if (confirm('Are you sure you want to reset ALL cards to default values?')) {
                // Reset global inputs
                globalPacientInput.value = "Alex Silva";
                globalHospitalInput.value = "Santa B√°rbara";
                globalSpecialityInput.value = "otorrinolaringologista";
                globalAddressInput.value = "Av. Dom Jo√£o VI, 1291 - Brotas, Salvador - BA";
                
                // Reset global logo
                globalLogoDataURL = null;
                globalLogoPreview.src = '';
                globalLogoPreview.classList.add('hidden');
                defaultLogoPlaceholder.classList.remove('hidden');
                removeGlobalLogoBtn.classList.add('hidden');
                globalLogoUploadInput.value = '';
                
                // Reset card data
                for (let i = 0; i < 8; i++) {
                    cardData[i] = {...defaultCardData};
                    individualLogos[i] = null;
                }
                
                // Regenerate all cards
                generateAppointments();
                
                // Show feedback
                showFeedback('All cards have been reset to default values!', 'success');
            }
        }
        
        // Handle global logo upload
        globalUploadBtn.addEventListener('click', () => {
            globalLogoUploadInput.click();
        });
        
        globalLogoUploadInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    showFeedback('Please select an image file (JPG, PNG, etc.)', 'error');
                    return;
                }
                
                // Check file size (limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showFeedback('Image must be less than 5MB', 'error');
                    return;
                }
                
                showFeedback('Loading image...', 'info');
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    setGlobalLogo(e.target.result);
                    showFeedback('Default logo loaded successfully!', 'success');
                };
                
                reader.onerror = function() {
                    showFeedback('Error reading file. Please try again.', 'error');
                };
                
                reader.readAsDataURL(file);
            }
        });
        
        // Handle save global logo
        saveGlobalLogoBtn.addEventListener('click', function() {
            if (globalLogoDataURL) {
                openSaveLogoModal(globalLogoDataURL, 'global');
            } else {
                showFeedback('Please upload a logo first to save it.', 'warning');
            }
        });
        
        // Handle global logo removal
        removeGlobalLogoBtn.addEventListener('click', function() {
            globalLogoDataURL = null;
            
            // Hide preview and show default placeholder
            globalLogoPreview.classList.add('hidden');
            defaultLogoPlaceholder.classList.remove('hidden');
            
            // Hide remove button
            removeGlobalLogoBtn.classList.add('hidden');
            
            // Reset file input
            globalLogoUploadInput.value = '';
            
            // Update all cards that don't have individual logos
            for (let i = 0; i < currentLayout; i++) {
                if (individualLogos[i] === null) {
                    updateCardLogo(i, null, false);
                }
            }
            
            showFeedback('Default logo removed!', 'success');
        });
        
        // Handle modal logo upload
        modalUploadLogoBtn.addEventListener('click', () => {
            modalLogoUploadInput.click();
        });
        
        modalLogoUploadInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    showFeedback('Please select an image file (JPG, PNG, etc.)', 'error');
                    return;
                }
                
                // Check file size (limit to 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showFeedback('Image must be less than 5MB', 'error');
                    return;
                }
                
                showFeedback('Loading image...', 'info');
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const logoDataURL = e.target.result;
                    setModalLogo(logoDataURL);
                    showFeedback('Individual logo loaded successfully!', 'success');
                };
                
                reader.onerror = function() {
                    showFeedback('Error reading file. Please try again.', 'error');
                };
                
                reader.readAsDataURL(file);
                
                // Reset file input
                this.value = '';
            }
        });
        
        // Handle save modal logo
        saveModalLogoBtn.addEventListener('click', function() {
            if (currentEditingCardIndex !== -1 && individualLogos[currentEditingCardIndex]) {
                openSaveLogoModal(individualLogos[currentEditingCardIndex], 'modal');
            } else {
                showFeedback('Please upload a logo first to save it.', 'warning');
            }
        });
        
        // Handle modal logo removal
        modalRemoveLogoBtn.addEventListener('click', function() {
            // Remove individual logo
            individualLogos[currentEditingCardIndex] = null;
            
            // Update modal preview
            modalLogoPreview.classList.add('hidden');
            modalDefaultLogoPlaceholder.classList.remove('hidden');
            modalRemoveLogoBtn.classList.add('hidden');
            
            // Update card logo (use global logo if available)
            updateCardLogo(currentEditingCardIndex, globalLogoDataURL, false);
            
            showFeedback('Individual logo removed!', 'success');
        });
        
        // Handle use global logo button
        modalUseGlobalLogoBtn.addEventListener('click', function() {
            if (globalLogoDataURL) {
                // Remove individual logo
                individualLogos[currentEditingCardIndex] = null;
                
                // Update modal preview
                modalLogoPreview.classList.add('hidden');
                modalDefaultLogoPlaceholder.classList.remove('hidden');
                modalRemoveLogoBtn.classList.add('hidden');
                
                // Update card logo
                updateCardLogo(currentEditingCardIndex, globalLogoDataURL, false);
                
                showFeedback('Using default logo for this card!', 'success');
            } else {
                showFeedback('No default logo set. Please upload a default logo first.', 'warning');
            }
        });
        
        // Handle layout selection
        layoutOptions.forEach(option => {
            option.addEventListener('click', function() {
                const layout = parseInt(this.dataset.layout);
                
                // Update selected layout
                currentLayout = layout;
                
                // Update UI
                layoutOptions.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                // Update paper info
                updatePaperInfo();
                
                // Regenerate appointments
                generateAppointments();
                
                // Show feedback
                showFeedback(`Layout changed to ${layoutConfigs[layout].name}`, 'info');
            });
        });
        
        // Event listeners for address autocomplete
        globalAddressInput.addEventListener('input', function() {
            showAddressAutocompleteSuggestions(this, globalAddressAutocomplete, savedAddresses);
        });
        
        globalAddressInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showAddressAutocompleteSuggestions(this, globalAddressAutocomplete, savedAddresses);
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!globalAddressInput.contains(e.target) && !globalAddressAutocomplete.contains(e.target)) {
                hideAutocomplete(globalAddressAutocomplete);
            }
        });
        
        modalAddressInput.addEventListener('input', function() {
            showAddressAutocompleteSuggestions(this, modalAddressAutocomplete, savedAddresses);
        });
        
        modalAddressInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showAddressAutocompleteSuggestions(this, modalAddressAutocomplete, savedAddresses);
            }
        });
        
        // Event listeners for user autocomplete
        globalPacientInput.addEventListener('input', function() {
            showUserAutocompleteSuggestions(this, globalUserAutocomplete, savedUsers);
        });
        
        globalPacientInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showUserAutocompleteSuggestions(this, globalUserAutocomplete, savedUsers);
            }
        });
        
        document.addEventListener('click', function(e) {
            if (!globalPacientInput.contains(e.target) && !globalUserAutocomplete.contains(e.target)) {
                hideAutocomplete(globalUserAutocomplete);
            }
        });
        
        modalPacientInput.addEventListener('input', function() {
            showUserAutocompleteSuggestions(this, modalUserAutocomplete, savedUsers);
        });
        
        modalPacientInput.addEventListener('focus', function() {
            if (this.value.length >= 2) {
                showUserAutocompleteSuggestions(this, modalUserAutocomplete, savedUsers);
            }
        });
        
        // Event listeners for logo autocomplete (search functionality)
        document.addEventListener('click', function(e) {
            // Show logo autocomplete when clicking on logo containers
            if (e.target.closest('.logo-preview-container') || e.target.closest('.default-logo-placeholder')) {
                const container = e.target.closest('.logo-upload') ? globalLogoAutocomplete : modalLogoAutocomplete;
                showLogoAutocompleteSuggestions(null, container, savedLogos);
            }
        });
        
        // Event listeners for save address buttons
        saveGlobalAddressBtn.addEventListener('click', function() {
            const address = globalAddressInput.value.trim();
            if (address) {
                openSaveAddressModal(address, 'global');
            } else {
                showFeedback('Please enter an address to save.', 'warning');
            }
        });
        
        saveModalAddressBtn.addEventListener('click', function() {
            const address = modalAddressInput.value.trim();
            if (address) {
                openSaveAddressModal(address, 'modal');
            } else {
                showFeedback('Please enter an address to save.', 'warning');
            }
        });
        
        // Event listeners for save user buttons
        saveGlobalUserBtn.addEventListener('click', function() {
            const user = globalPacientInput.value.trim();
            if (user) {
                openSaveUserModal(user, 'global');
            } else {
                showFeedback('Please enter a name to save.', 'warning');
            }
        });
        
        saveModalUserBtn.addEventListener('click', function() {
            const user = modalPacientInput.value.trim();
            if (user) {
                openSaveUserModal(user, 'modal');
            } else {
                showFeedback('Please enter a name to save.', 'warning');
            }
        });
        
        // Event listeners for save address modal
        saveAddressConfirmBtn.addEventListener('click', function() {
            const name = addressNameInput.value.trim();
            const address = addressValueInput.value.trim();
            saveNewAddress(name, address);
        });
        
        saveAddressCancelBtn.addEventListener('click', closeSaveAddressModal);
        saveAddressModalCloseBtn.addEventListener('click', closeSaveAddressModal);
        
        // Event listeners for save logo modal
        saveLogoConfirmBtn.addEventListener('click', function() {
            const name = logoNameInput.value.trim();
            saveNewLogo(name, logoToSave);
        });
        
        saveLogoCancelBtn.addEventListener('click', closeSaveLogoModal);
        saveLogoModalCloseBtn.addEventListener('click', closeSaveLogoModal);
        
        // Event listeners for save user modal
        saveUserConfirmBtn.addEventListener('click', function() {
            const name = userNameInput.value.trim();
            const fullName = userValueInput.value.trim();
            saveNewUser(name, fullName);
        });
        
        saveUserCancelBtn.addEventListener('click', closeSaveUserModal);
        saveUserModalCloseBtn.addEventListener('click', closeSaveUserModal);
        
        // Close modals when clicking outside - ONLY for save modals, NOT for edit modal
        saveAddressModalOverlay.addEventListener('click', function(e) {
            if (e.target === saveAddressModalOverlay) {
                closeSaveAddressModal();
            }
        });
        
        saveLogoModalOverlay.addEventListener('click', function(e) {
            if (e.target === saveLogoModalOverlay) {
                closeSaveLogoModal();
            }
        });
        
        saveUserModalOverlay.addEventListener('click', function(e) {
            if (e.target === saveUserModalOverlay) {
                closeSaveUserModal();
            }
        });
        
        // Clear all addresses button
        clearGlobalAddressesBtn.addEventListener('click', clearAllAddresses);
        
        // Clear all logos button
        clearGlobalLogosBtn.addEventListener('click', clearAllLogos);
        
        // Clear all users button
        clearGlobalUsersBtn.addEventListener('click', clearAllUsers);
        
        // Generate PDF for printing
        downloadPdfBtn.addEventListener('click', function() {
            const paperSheet = document.querySelector('.paper-sheet');
            
            // Close any open modal first
            closeEditModal();
            closeSaveAddressModal();
            closeSaveLogoModal();
            closeSaveUserModal();
            
            // Show loading feedback
            showFeedback('Generating PDF... Please wait!', 'info');
            setButtonLoading(this, true);
            
            // Temporarily hide card numbers and badges for PDF
            const cardNumbers = document.querySelectorAll('.card-number');
            const logoBadges = document.querySelectorAll('.logo-badge');
            const originalDisplayNumbers = [];
            const originalDisplayBadges = [];
            
            cardNumbers.forEach((number, index) => {
                originalDisplayNumbers[index] = number.style.display;
                number.style.display = 'none';
            });
            
            logoBadges.forEach((badge, index) => {
                originalDisplayBadges[index] = badge.style.display;
                badge.style.display = 'none';
            });
            
            html2canvas(paperSheet, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                width: paperSheet.offsetWidth,
                height: paperSheet.offsetHeight
            }).then(canvas => {
                // Restore displays
                cardNumbers.forEach((number, index) => {
                    number.style.display = originalDisplayNumbers[index];
                });
                
                logoBadges.forEach((badge, index) => {
                    badge.style.display = originalDisplayBadges[index];
                });
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Convert canvas to image data
                const imgData = canvas.toDataURL('image/png');
                
                // Calculate dimensions to fit A4
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Add image to PDF
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                
                // Download PDF
                pdf.save(`${currentLayout}-medical-appointments-a4.pdf`);
                
                // Show success feedback
                showFeedback('PDF generated successfully! Download started.', 'success');
                
                // Reset button
                setButtonLoading(this, false);
                
            }).catch(error => {
                // Restore displays
                cardNumbers.forEach((number, index) => {
                    number.style.display = originalDisplayNumbers[index];
                });
                
                logoBadges.forEach((badge, index) => {
                    badge.style.display = originalDisplayBadges[index];
                });
                
                console.error('Error generating PDF:', error);
                showFeedback('Error generating PDF. Please try again.', 'error');
                setButtonLoading(this, false);
            });
        });
        
        // Generate and download page as image
        downloadImageBtn.addEventListener('click', function() {
            const paperSheet = document.querySelector('.paper-sheet');
            
            // Close any open modal first
            closeEditModal();
            closeSaveAddressModal();
            closeSaveLogoModal();
            closeSaveUserModal();
            
            // Show loading feedback
            showFeedback('Generating image... Please wait!', 'info');
            setButtonLoading(this, true);
            
            // Temporarily hide card numbers and badges for image
            const cardNumbers = document.querySelectorAll('.card-number');
            const logoBadges = document.querySelectorAll('.logo-badge');
            const originalDisplayNumbers = [];
            const originalDisplayBadges = [];
            
            cardNumbers.forEach((number, index) => {
                originalDisplayNumbers[index] = number.style.display;
                number.style.display = 'none';
            });
            
            logoBadges.forEach((badge, index) => {
                originalDisplayBadges[index] = badge.style.display;
                badge.style.display = 'none';
            });
            
            html2canvas(paperSheet, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                width: paperSheet.offsetWidth,
                height: paperSheet.offsetHeight
            }).then(canvas => {
                // Restore displays
                cardNumbers.forEach((number, index) => {
                    number.style.display = originalDisplayNumbers[index];
                });
                
                logoBadges.forEach((badge, index) => {
                    badge.style.display = originalDisplayBadges[index];
                });
                
                const link = document.createElement('a');
                link.download = `${currentLayout}-medical-appointments-a4.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                // Show success feedback
                showFeedback('Image generated successfully! Download started.', 'success');
                
                // Reset button
                setButtonLoading(this, false);
                
            }).catch(error => {
                // Restore displays
                cardNumbers.forEach((number, index) => {
                    number.style.display = originalDisplayNumbers[index];
                });
                
                logoBadges.forEach((badge, index) => {
                    badge.style.display = originalDisplayBadges[index];
                });
                
                console.error('Error generating image:', error);
                showFeedback('Error generating image. Please try again.', 'error');
                setButtonLoading(this, false);
            });
        });
        
        // Print page
        printBtn.addEventListener('click', function() {
            // Close any open modal first
            closeEditModal();
            closeSaveAddressModal();
            closeSaveLogoModal();
            closeSaveUserModal();
            
            // Show feedback
            showFeedback('Preparing for printing...', 'info');
            
            // Print the paper sheet
            const printContent = document.querySelector('.paper-sheet').outerHTML;
            const originalContent = document.body.innerHTML;
            
            document.body.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Print ${currentLayout} Medical Appointments - A4</title>
                    <style>
                        body { 
                            margin: 0;
                            padding: 0;
                            font-family: Arial, sans-serif;
                        }
                        .paper-sheet {
                            width: 210mm;
                            height: 297mm;
                            background-color: white;
                            margin: 0;
                            padding: 15mm;
                            box-sizing: border-box;
                        }
                        .appointments-grid {
                            display: grid;
                            width: 100%;
                            height: 100%;
                        }
                        .appointment-card {
                            background-color: white;
                            border: 1px solid #000;
                            border-radius: 3mm;
                            padding: 3mm;
                            position: relative;
                            overflow: hidden;
                            page-break-inside: avoid;
                            break-inside: avoid;
                            box-sizing: border-box;
                        }
                        .card-logo {
                            max-width: 100%;
                            max-height: 100%;
                            object-fit: contain;
                        }
                        .default-logo-placeholder {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-style: italic;
                            border: 1px dashed #ccc;
                            border-radius: 2mm;
                            padding: 2mm;
                            text-align: center;
                        }
                        @media print {
                            .appointment-card {
                                border: 1px solid #000 !important;
                                box-shadow: none !important;
                            }
                            .card-number, .logo-badge {
                                display: none;
                            }
                        }
                    </style>
                </head>
                <body>${printContent}</body>
                </html>
            `;
            
            window.print();
            document.body.innerHTML = originalContent;
            generateAppointments();
            
            showFeedback('Print configured! Check your printer.', 'success');
        });
        
        // Event listeners
        applyAllBtn.addEventListener('click', applyToAllCards);
        resetAllBtn.addEventListener('click', resetAllCards);
        modalSaveBtn.addEventListener('click', saveCardChanges);
        modalCancelBtn.addEventListener('click', closeEditModal);
        modalCloseBtn.addEventListener('click', closeEditModal);
        
        // Prevent edit modal from closing when clicking outside - REMOVED the click handler
        // Now clicking outside will NOT close the modal
        modalOverlay.addEventListener('click', function(e) {
            // Don't do anything when clicking on overlay
            // The modal will stay open
            e.stopPropagation();
        });
        
        // Prevent modal from closing when clicking inside
        modalContent.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            // Initialize language
            initLanguage();
            
            // Load saved addresses, logos, and users
            loadSavedAddresses();
            loadSavedLogos();
            loadSavedUsers();
            
            // Initialize all cards with default data
            for (let i = 0; i < 8; i++) {
                cardData[i] = {...defaultCardData};
                individualLogos[i] = null;
            }
            
            // Initialize paper info
            updatePaperInfo();
            
            // Render saved addresses in global container
            renderSavedAddresses(globalSavedAddressesContainer, (address) => {
                globalAddressInput.value = address;
                hideAutocomplete(globalAddressAutocomplete);
            });
            
            // Render saved logos in global container
            renderSavedLogos(globalSavedLogosContainer, (logoDataURL) => {
                setGlobalLogo(logoDataURL);
            });
            
            // Render saved users in global container
            renderSavedUsers(globalSavedUsersContainer, (user) => {
                globalPacientInput.value = user;
                hideAutocomplete(globalUserAutocomplete);
            });
            
            // Generate initial appointments
            generateAppointments();
        });
    </script>
</body>
</html>